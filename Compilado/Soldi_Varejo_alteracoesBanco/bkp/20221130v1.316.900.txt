
GO
/****** Object:  StoredProcedure [dbo].[sp_m_Comanda_Consumo]    Script Date: 06/24/2022 09:01:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[sp_m_Comanda_Consumo]
	@comanda as varchar(10),
	@consolidado as integer
AS

	-- SP_M_COMANDA_CONSUMO '8', 0
	if @consolidado = 1
		BEGIN
			IF (OBJECT_ID('tempdb..#SEMCONSOLIDAR')) IS NOT NULL
				DROP TABLE #SEMCONSOLIDAR

			IF (OBJECT_ID('tempdb..#CONSOLIDAR')) IS NOT NULL
				DROP TABLE #CONSOLIDAR

			SELECT 
			codigo = A.PLU,
			descricao = C.DESCRICAO, 
			quantidade = A.QTDE, 
			valor = A.unitario,
			C.Tipo,
			C.Peso_Variavel
			INTO #SEMCONSOLIDAR
			FROM COMANDA_ITEM AS A 
			INNER JOIN COMANDA_CONTROLE AS B ON A.COMANDA=B.COMANDA 
			INNER JOIN MERCADORIA AS C ON A.PLU=C.PLU WHERE
			A.DATA_CANCELAMENTO IS NULL 
			AND (B.STATUS = '02' OR B.STATUS = '06') 
			AND A.CUPOM = '0' AND A.PDV = '0' 
			AND A.COMANDA = @Comanda
			AND (C.Tipo = 'PIZZA' OR C.Peso_Variavel = 'PESO')


			SELECT 
			codigo = A.PLU,
			descricao = C.DESCRICAO, 
			quantidade = SUM(A.QTDE), 
			valor = AVG(A.unitario),
			C.Tipo,
			C.Peso_Variavel
			INTO #CONSOLIDAR
			FROM COMANDA_ITEM AS A 
			INNER JOIN COMANDA_CONTROLE AS B ON A.COMANDA=B.COMANDA 
			INNER JOIN MERCADORIA AS C ON A.PLU=C.PLU WHERE
			A.DATA_CANCELAMENTO IS NULL 
			AND (B.STATUS = '02' OR B.STATUS = '06') 
			AND A.CUPOM = '0' AND A.PDV = '0' 
			AND A.COMANDA = @Comanda
			AND NOT (C.Tipo = 'PIZZA' OR C.Peso_Variavel = 'PESO')
			GROUP BY A.PLU, C.Descricao, C.Tipo, C.Peso_Variavel

			select codigo, descricao, quantidade, valor from #SEMCONSOLIDAR
			union all
			select codigo, descricao, quantidade, valor from #CONSOLIDAR
			ORDER BY 2
		END
	ELSE
		BEGIN
			SELECT 
			codigo = A.PLU,
			descricao = C.DESCRICAO, 
			quantidade = A.QTDE, 
			valor = A.unitario
			FROM COMANDA_ITEM AS A 
			INNER JOIN COMANDA_CONTROLE AS B ON A.COMANDA=B.COMANDA 
			INNER JOIN MERCADORIA AS C ON A.PLU=C.PLU WHERE
			A.DATA_CANCELAMENTO IS NULL 
			AND (B.STATUS = '02' OR B.STATUS = '06') 
			AND A.CUPOM = '0' AND A.PDV = '0' 
			AND A.COMANDA = @Comanda
			ORDER BY A.ID
		END

GO

CREATE TABLE [dbo].[Fornecedor_Ocorrencia](
	[Fornecedor] [varchar](50) NOT NULL,
	[Data] DateTime NOT NULL,
	[Ocorrencia] nVarchar(MAX) NOT NULL,
	[Status] [VarChar](20) NOT NULL,
	[Usuario] [VarChar](20) NOT NULL
)
go

GO
/****** Object:  StoredProcedure [dbo].[LX_SEQUENCIAL]    Script Date: 29/06/2022 10:49:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[LX_SEQUENCIAL] @TABELA_COLUNA VARCHAR(37), @EMPRESA INT = NULL, @SEQUENCIA VARCHAR(20) OUTPUT
AS
BEGIN
	SET NOCOUNT ON
	DECLARE	@SEQUENCIA_ANT VARCHAR(20), 
		@TAMANHO INT, 
		@PERMITE_POR_EMPRESA SMALLINT,
		@EXECUTA SMALLINT,
		@errno   int,
		@errmsg  varchar(255)

	--SET

	SELECT @EXECUTA=1
	WHILE @EXECUTA=1
	BEGIN
		SELECT 	@SEQUENCIA_ANT	= ISNULL(SEQUENCIA,0), 
			@TAMANHO	= ISNULL(TAMANHO,DATALENGTH(RTRIM(SEQUENCIA))), 
			@PERMITE_POR_EMPRESA =0
		FROM SEQUENCIAIS 
		WHERE TABELA_COLUNA=@TABELA_COLUNA
		IF @@ROWCOUNT=0
		BEGIN
			SELECT 	@ERRNO=50001,
				@ERRMSG='O sequencial #'+RTRIM(@TABELA_COLUNA) +' #nao existe na tabela de sequenciais !!!'
			GOTO error
		END

		BEGIN
			SELECT @SEQUENCIA=RIGHT(REPLICATE('0',@TAMANHO)+CONVERT(VARCHAR(20),CONVERT(INT,@SEQUENCIA_ANT)+1),@TAMANHO)

			UPDATE 	SEQUENCIAIS 
			SET 	SEQUENCIA = @SEQUENCIA
			WHERE 	TABELA_COLUNA=@TABELA_COLUNA AND 
				SEQUENCIA=@SEQUENCIA_ANT
			
		END
		IF @@ROWCOUNT=1 OR @@ERROR <> 0
			SELECT @EXECUTA=0
	END


RETURN
error:
    --raiserror @errno @errmsg
RETURN
END






--PROCEDURE =============================================================================================================================================
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SP_REL_HISTORIO_ENTRADA_SAIDA_CONSOLIDADE]') AND type in (N'P', N'PC'))
begin
	DROP PROCEDURE [SP_REL_HISTORIO_ENTRADA_SAIDA_CONSOLIDADE]
end

GO
/****** Object:  UserDefinedFunction [dbo].[F_SaldoKardexPLU]    Script Date: 12/07/2022 09:02:50 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
alter PROCEDURE [dbo].[sp_Br_Cons_SaldoKardexPLU]
@PLU as Varchar(17)
AS

-- sp_br_cons_saldokardexplu  '44065'
begin
	--declare @plu as varchar(17)
	declare @qtdeEntrada as integer
	declare @qtdeSaidanf As integer
	declare @qtdeSaida As integer
	declare @qtdeAjEntrada as Integer
	declare @qtdeAjSaida as Integer
	declare @dataBase	as datetime
	declare @qtdeBase as integer

	--set @plu = '59382'


	SET @dataBase = ISNULL((select TOP 1 IV.Data  from Inventario iv inner join Inventario_itens ii on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao = 'INVENTARIO' and iv.status = 'ENCERRADO'
	WHERE ii.PLU = @plu order by iv.Data desc), '1900-01-01')

	if @dataBase > '1900-01-01' 
		begin
			SET @qtdeBase = ISNULL((select top 1 ii.Contada from Inventario iv inner join Inventario_itens ii on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao = 'INVENTARIO' and iv.status = 'ENCERRADO'
			WHERE ii.PLU = @plu order by iv.Codigo_inventario  desc), '1900-01-01')
		end
	else
		set @qtdeBase = 0


	set @qtdeAjEntrada = isnull(( select sum(ii.Contada) from Inventario iv inner join Inventario_itens ii 
	on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao in('AJUSTE ENTRADA', 'DEVOLUCAO')
	and iv.status = 'ENCERRADO' WHERE iv.data >= @database and ii.PLU = @plu), 0)

	set @qtdeAjSaida  = isnull(( select sum(ii.Contada) from Inventario iv inner join Inventario_itens ii 
	on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao in('AJUSTE SAIDA', 'DESPERDICIO')
	and iv.status = 'ENCERRADO' WHERE iv.Data >= @dataBase and ii.PLU = @plu), 0)
		

	select @qtdeEntrada = sum(i.Qtde * i.Embalagem) 
	from nf inner join nf_item i on nf.Filial = i.Filial and nf.Cliente_Fornecedor = i.Cliente_Fornecedor and nf.codigo = i.codigo
	inner join Natureza_Operacao n on nf.codigo_operacao = n.Codigo_operacao 
	where nf.Tipo_NF = 2
	and i.PLU = @plu
	and nf.data >= case when @dataBase >= '1900-01-01' then @dataBase else '1900-01-01' end
	and ISNULL(nf.nf_canc, 0) < 1
	and n.Baixa_estoque  = 1

		
	select @qtdeSaidanf  = sum(i.Qtde * i.Embalagem) 
	from nf inner join nf_item i on nf.Filial = i.Filial and nf.Cliente_Fornecedor = i.Cliente_Fornecedor and nf.codigo = i.codigo
	inner join Natureza_Operacao n on nf.codigo_operacao = n.Codigo_operacao 
	where nf.Tipo_NF = 1
	and i.PLU = @plu
	and nf.data >= case when @dataBase >= '1900-01-01' then @dataBase else '1900-01-01' end
	and ISNULL(nf.nf_canc, 0) < 1
	and n.Baixa_estoque  = 1

	select @qtdeSaida = sum(s.qtde) from Saida_estoque s with (index=ix_Saida_estoque)
	where s.Filial = 'MATRIZ' AND s.Data_movimento  >= case when @dataBase >= '1900-01-01' then @dataBase else '1900-01-01' end
	and s.PLU = @plu and s.data_cancelamento is null

	/*
	print @database
	print @plu
	print @qtdebase 
	print @qtdeentrada 
	PRINT @qtdeajentrada
	print @qtdesaidanf
	print @qtdesaida
	print @qtdeAjSaida

	PRINT '----'
	*/
	SELECT
	Inicio = CONVERT(VARCHAR, @dataBase, 103) 
	, [Qtde Inicio] =  ISNULL(@qtdeBase, 0)
	, [Entrada NFe] = ISNULL(@qtdeentrada, 0) 
	, [Entrada Ajustes] = ISNULL(@qtdeajentrada, 0) 
	, [Saida NFe] = ISNULL(@qtdesaidanf, 0) 
	, [Saida Cupom] = ISNULL(@qtdesaida, 0) 
	, [Saida Ajustes] = ISNULL(@qtdeAjSaida, 0)
	, [Saldo Final] = ISNULL(@qtdeBase, 0) + ISNULL(@qtdeentrada, 0)  + ISNULL(@qtdeajentrada, 0)  - ISNULL(@qtdesaidanf, 0)  - ISNULL(@qtdesaida, 0)  - ISNULL(@qtdeAjSaida, 0)

end

GO
/****** Object:  StoredProcedure [dbo].[sp_Rel_EstoqueNaData]    Script Date: 07/21/2022 10:30:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--[sp_Rel_EstoqueNaData] 'MATRIZ','TODOS','20220630'
--PROCEDURES =======================================================================================
ALTER procedure [dbo].[sp_Rel_EstoqueNaData]
	@Filial			as varchar(20),
	@Tipo			as varchar(20),	
	@Data			as DateTime

As

set @Data = @Data + 1

IF (OBJECT_ID('tempdb..##CalcCusto') IS NOT NULL)
	DROP TABLE ##CalcCusto
	
IF (OBJECT_ID('tempdb..#PLUs') IS NOT NULL)
	DROP TABLE #PLUs

IF (OBJECT_ID('tempdb..#PLUs2') IS NOT NULL)
	DROP TABLE #PLUs2

DECLARE @NOVO AS INT

IF CONVERT(VARCHAR, @DATA, 102) >= '2022.05'
	BEGIN
		SET @NOVO = 1
	END
ELSE
	BEGIN
		SET @NOVO = 0
	END

CREATE TABLE #PLUS2(PLU VARCHAR(17))

INSERT INTO #PLUS2 
	SELECT DISTINCT PLU FROM NF_Item I WITH (INDEX=IX_NF_ITEM_02)
	INNER JOIN NF ON NF.Cliente_Fornecedor = I.Cliente_Fornecedor AND NF.Codigo = I.Codigo 
	WHERE NF.Data >= DATEADD(YEAR, -2, GETDATE())
INSERT INTO #PLUS2
	SELECT DISTINCT PLU FROM Inventario v INNER JOIN Inventario_itens vi on v.Codigo_inventario = vi.Codigo_inventario WHERE v.Data >= DATEADD(YEAR, -1, GETDATE())
INSERT INTO #PLUS2
	SELECT DISTINCT PLU FROM Saida_estoque WITH (INDEX=IX_SAIDA_ESTOQUE_01) WHERE Filial = @Filial AND Data_movimento >= DATEADD(YEAR, -1, GETDATE())

SELECT DISTINCT PLU INTO #PLUS FROM #PLUS2

--- Calcula Custo na Data
BEGIN
	IF @NOVO = 1
		BEGIN
			--Criar tabela temporária para pegar o último custo
			SELECT NF_ITEM.PLU,
			NF.Data,
			Custo = ISNULL(
			(((NF_ITEM.Total * (CASE WHEN NF_ITEM.Desconto > 0 THEN ((100 - NF_ITEM.Desconto) / 100) ELSE 1 End)) 
			+ NF_ITEM.IVA + NF_ITEM.Frete + NF_ITEM.IPIV + NF_ITEM.Despesas) / (NF_ITEM.Qtde * NF_ITEM.Embalagem))
			,0)
			INTO #NF
			FROM NF with(INDEX=IX_NF_01)
			INNER JOIN NF_ITEM  WITH (INDEX=IX_NF_ITEM_01) 
							ON NF.FILIAL = NF_ITEM.FILIAL 
							AND NF.CLIENTE_FORNECEDOR = NF_ITEM.CLIENTE_FORNECEDOR 
			AND NF.CODIGO = NF_ITEM.CODIGO 
			WHERE NF.FILIAL = 'MATRIZ'
			AND NF.DATA >= DATEADD(YEAR, -2, GETDATE()) AND CONVERT(VARCHAR, NF.DATA, 112)  <= @DATA
			AND NF.TIPO_NF = '2'
			ORDER BY NF.DATA DESC

			--Selecionar último ocusto.
			SELECT ML.Plu,
			Custo = ISNULL((SELECT TOP 1 Custo FROM #NF WHERE #NF.PLU = ML.PLU ORDER BY #NF.DATA DESC), ML.PRECO_CUSTO)
			INTO #CalcCusto1
			FROM 
				Mercadoria_Loja Ml
			WHERE ML.PLU COLLATE DATABASE_DEFAULT IN(SELECT PLU COLLATE DATABASE_DEFAULT FROM #PLUS)
		END
	ELSE
		BEGIN
			
			SELECT NF_Item.Plu,
				Custo = Isnull(Convert(decimal(18,2),Sum(((NF_ITEM.TOTAL * ((100 - CASE WHEN NF_ITEM.DESCONTO > 0 THEN NF_ITEM.DESCONTO ELSE 0 END) / 100)) +  
				NF_ITEM.IVA + 
				NF_ITEM.IPIV) / 
				(NF_ITEM.QTDE * NF_ITEM.EMBALAGEM))),Sum(m.Preco_Custo))
			Into #CalcCusto2
			FROM 
				NF with(INDEX=IX_NF_01)
				INNER JOIN NF_ITEM with(INDEX=IX_NF_ITEM_02) ON NF.FILIAL = NF_ITEM.FILIAL 
				INNER JOIN Mercadoria M ON M.PLU = NF_ITEM.PLU
				AND NF.CLIENTE_FORNECEDOR = NF_ITEM.CLIENTE_FORNECEDOR AND NF.CODIGO = NF_ITEM.CODIGO 
				AND NF.Tipo_NF = NF_ITEM.Tipo_NF 						
				AND Isnull(NF.Serie,0) = Isnull(NF_ITEM.Serie,0)
			WHERE
				NF.FILIAL = @Filial 
			AND 
				NF.DATA = (SELECT MAX(NF.DATA) FROM NF with(INDEX=IX_NF_01)INNER JOIN NF_ITEM  with(INDEX=IX_NF_ITEM_02) 
								ON NF.FILIAL = NF_ITEM.FILIAL AND NF.CLIENTE_FORNECEDOR = NF_ITEM.CLIENTE_FORNECEDOR 
								AND NF.CODIGO = NF_ITEM.CODIGO 
								AND NF.Tipo_NF = NF_ITEM.Tipo_NF 					
								AND Isnull(NF.Serie,0) = Isnull(NF_ITEM.Serie,0)
								WHERE NF.FILIAL = @Filial 
								AND CONVERT(VARCHAR, NF.DATA, 112) <= @data
								AND NF_ITEM.PLU = m.plu
								AND NF.TIPO_NF = '2'
								AND not NF.Codigo_Operacao in ('1202','1411'))
			AND 
				NF.TIPO_NF = '2'
			AND 
				not NF.Codigo_Operacao in ('1202','1411')			
			Group By 
				NF_Item.Plu	
		END
END

DECLARE @STRING AS VARCHAR(MAX)
SET @STRING = 'SELECT * INTO ##CalcCusto FROM ' + CASE WHEN @NOVO = 1 THEN '#CalcCusto1' ELSE '#CalcCusto2' END
EXECUTE(@STRING)

Begin


SELECT 
	M.PLU,
	m.descricao,
	PRECO_CUSTO = ##CalcCusto.Custo,
	M.SALDO_ATUAL,
	m.Tipo,
	SaidaPDV = isnull((Select Sum(s.Qtde) From saida_estoque s with (index=ix_saida_estoque)-- inner join mercadoria_loja l on s.plu = l.plu
						Where s.Filial = @Filial 
						And s.Data_movimento between @Data And Getdate() 
						And s.data_cancelamento is null
						And S.PLU = M.PLU), 0),
	SaidaNF = isnull((Select Sum( ((i.qtde * i.embalagem)  )  )
						From nf Inner Join Natureza_operacao n on n.codigo_operacao = nf.Codigo_operacao 
								Inner Join nf_item i on nf.Filial = i.Filial 
								And nf.Cliente_Fornecedor = i.Cliente_Fornecedor 
								And nf.codigo = i.codigo 								
								And nf.Tipo_NF = i.Tipo_NF 
								And isnull(nf.serie,0) = Isnull(i.serie,0) 	
						Where isnull(nf.nf_canc,0) <> 1
						And nf.tipo_nf = 1
						And n.baixa_estoque = 1
						And nf.Data between @Data And GETDATE()
						And NF.FIlial = @Filial
						And i.PLU = m.plu), 0),
	OutrasSaidas = Isnull((
			(select Isnull(SUM(Contada),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO'
			and v.data between @Data And GETDATE()
			and i.PLU = m.plu
			and exists(select * from Tipo_movimentacao t where t.Movimentacao = v.tipoMovimentacao and t.saida = 1)) 
		),0),								
	OutrasEntradas = Isnull((
			(select Isnull(SUM(Contada),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO'
			and v.data between @Data And GETDATE()
			and i.PLU = m.plu
			and exists(select * from Tipo_movimentacao t where t.Movimentacao = v.tipoMovimentacao and t.saida = 0)) 
		),0),						
	EntradaNF = isnull((Select Sum( ((i.qtde * i.embalagem)  )  )
						From nf Inner Join Natureza_operacao n on n.codigo_operacao = nf.Codigo_operacao 
								Inner Join nf_item i on nf.Filial = i.Filial 
								And nf.Cliente_Fornecedor = i.Cliente_Fornecedor 
								And nf.codigo = i.codigo 								
								And nf.Tipo_NF = i.Tipo_NF 
								And isnull(nf.serie,0) = Isnull(i.serie,0) 									
						Where isnull(nf.nf_canc,0) <> 1
						And nf.tipo_nf = 2
						And n.baixa_estoque = 1
						And nf.Data between @Data And GETDATE()
						And NF.Filial = @Filial
						And i.PLU = m.plu), 0),
	DivInv = Isnull((
			(select Isnull(SUM((i.Contada-i.Saldo_Atual)),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO' and v.tipoMovimentacao  = 'INVENTARIO'
			and v.data between @Data And GETDATE()
			and i.PLU = m.plu)),0),
	ICMSEntrada = ISNULL(T.Saida_Icms, 0),
	Perc_PIS = M.Pis_Perc_Entrada,
	Perc_COFINS = M.Cofins_Perc_Entrada 											
into #lixo 
From 
	Mercadoria m Inner join ##CalcCusto on m.plu = ##CalcCusto.plu
	INNER JOIN Tributacao T on t.codigo_tributacao = M.Codigo_Tributacao 
Where
	m.Filial = @Filial	
And	
	(@Tipo = 'TODOS' OR  @Tipo like '%'+m.Tipo+'%')	


Select 
	PLU, 
	Descricao, 
	Departamento = (Select w.descricao_departamento 
						From W_BR_CADASTRO_DEPARTAMENTO w Inner Join mercadoria m 
						on w.codigo_departamento = m.Codigo_departamento 
						Where m.plu = #lixo.PLU),
	Tipo,
	Custo = convert(decimal(18,2),preco_custo), 
	Saldo = (saldo_atual + OutrasSaidas + SaidaPDV + SaidaNF - EntradaNF - OutrasEntradas+(DivInv*-1) ),
	[Valor Estoque] = convert(decimal(18,2),(saldo_atual + OutrasSaidas + SaidaPDV + SaidaNF - EntradaNF - OutrasEntradas+(DivInv*-1))) * preco_custo,
	ICMSEntrada,
	Perc_PIS,
	Perc_COFINS
into #estoque 
From 
	#lixo
Where 
	(saldo_atual + OutrasSaidas + SaidaPDV + SaidaNF - EntradaNF - OutrasEntradas+(DivInv*-1)) > 0
	
Select 
	Plu = #estoque.PLU, 
	Descricao = #estoque.Descricao, 
	Departamento = #estoque.Departamento, 
	Tipo = #estoque.Tipo,
	Custo = #estoque.Custo, 
	Saldo = #estoque.Saldo, 
	[Valor Estoque]= #estoque.[Valor Estoque], 
	ICMS = convert(decimal(18,2),#estoque.[Valor Estoque]*ICMSEntrada/100),
	PIS = convert(decimal(18,2),#estoque.[Valor Estoque]*Isnull(Perc_PIS,0)/100),
	COFINS = convert(decimal(18,2),#estoque.[Valor Estoque]*Isnull(Perc_COFINS,0)/100) 
into #CalcCustoLiquido	   	 	    	    
From 
	#estoque 
Order by 7 Desc
End


select 
	Plu, Descricao, Departamento, Tipo, Custo, Saldo,[Valor Estoque], ICMS, PIS, COFINS, [Custo Liquido] = convert(decimal(18,2),[Valor Estoque]-icms-pis-cofins)
From 
	#CalcCustoLiquido 
Order by 10 desc

GO

/****** Object:  Index [ix_CPF_Data]    Script Date: 02/08/2022 08:19:35 ******/
CREATE NONCLUSTERED INDEX [ix_CPF_Data] ON [dbo].[Saida_estoque]
(
	[CPF_CNPJ] ASC,
	[Data_movimento] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

go
alter table nf_item ADd Redutor_Base_IVA Decimal (5,2) default 0

GO
/****** Object:  StoredProcedure [dbo].[sp_Rel_Venda_nf]    Script Date: 10/08/2022 10:12:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--PROCEDURES =======================================================================================
ALTER PROCEDURE [dbo].[sp_Rel_Venda_nf] 
		@FILIAL 	AS VARCHAR(17),
		@DataDe		As Varchar(8),
		@DataAte	As Varchar(8)
		as
begin
	-- exec sp_Rel_Venda_nf 'MATRIZ','20141201','20141220'
	Select nf.CODIGO,convert(varchar,NF.Data,103) Data, nf.Cliente_Fornecedor Cod,cliente.Nome_Cliente,Total = nf.Total
	from NF inner join cliente on NF.Cliente_Fornecedor= cliente.Codigo_Cliente 
			INNER JOIN NF_Item ON NF.Codigo = NF_ITEM.CODIGO 		
	where NF.Tipo_NF = 1 and (NF.Data between @DataDe and @DataAte )AND nf_item.codigo_operacao in ('5102','5405','5402','5403','6102','6405','6401','6403')  
	and nf.Status IN('AUTORIZADO', 'AUTORIZADA')
	group by nf.Codigo,nf.data,nf.Cliente_Fornecedor,cliente.Nome_Cliente,nf.total
end
		  


GO
/****** Object:  StoredProcedure [dbo].[sp_Rel_Cliente_nf]    Script Date: 10/08/2022 11:09:56 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Rel_Cliente_nf] 
		@FILIAL 	AS VARCHAR(17),
		@DataDe		As Varchar(8),
		@DataAte	As Varchar(8),
		@ID	    As int = 0,
		@cnpj       as Varchar(20),
		@tipo       as varchar(20)
		
		as
BEGIN
	-- exec [sp_Rel_Cliente_nf] 'MATRIZ','20220801','20220809','', '','analitico'
	
	IF(LEN(@CNPJ)>0)
	BEGIN 
		SET @CNPJ = LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(@CNPJ,'.',''),'/',''),'-','')))
	END 
	
	if (OBJECT_ID('tempdb..##tempVendaNF') is not null)
		drop table ##tempVendaNF

	if @ID > 0
		BEGIN
			Select 
					Emissao,
					nf.Cliente_Fornecedor Cod,
					cliente.Nome_Cliente,
					cliente.nome_fantasia,
					ISNULL(cg.Grupo, '') AS Grupo,
					Qtde_Notas =  isnull((select count(distinct(nfnota.Codigo)) from nf as nfnota 
										where convert(varchar,nfnota.EMISSAO,112) = convert(varchar,nf.EMISSAO,112) 
										and nfnota.Cliente_Fornecedor = nf.Cliente_Fornecedor),0),
					Total = Convert(decimal(15,2),Sum(NF_Item.Total+Isnull(NF_Item.Frete,0)))
			
				into #tempVendaNF1 
				from NF inner join cliente on NF.Cliente_Fornecedor= cliente.Codigo_Cliente 
						 INNER JOIN NF_Item ON NF.Codigo = NF_ITEM.CODIGO and nf.Cliente_Fornecedor = nf_item.Cliente_Fornecedor and nf.Filial = nf_item.Filial
						 inner JOIN cliente_grupo  as cg on cg.id= cliente.grupo_empresa	
						 inner join Natureza_operacao np on.nf.Codigo_operacao = np.Codigo_operacao	
				 where (NF.Data between @DataDe and @DataAte ) 
				 AND Isnull(NF.NF_Canc,0) = 0 AND LTRIM(NF.Filial) = 'matriz'
				AND NF.Tipo_NF in (1,3) --Incluido a condição 3 - Emissao de Pedidos
				 and NP.NF_devolucao = 0 
					AND nf_item.codigo_operacao in ('5101', '5102','5405','5402','5403','6101', '6102','6405','6401','6403')  
				AND (LEN(@CNPJ)=0 OR LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(CLIENTE.CNPJ,'.',''),'/',''),'-','')))= @CNPJ)
				AND cg.id = @id
				 group by NF.EMISSAO,nf.Cliente_Fornecedor,cliente.Nome_Cliente,cliente.nome_fantasia, Cliente.Grupo_Empresa, cg.grupo, nf.Total
				 ORDER BY CONVERT(VARCHAR,NF.EMISSAO,102) 
		END
	ELSE
		BEGIN
			Select 
					Emissao,
					nf.Cliente_Fornecedor Cod,
					cliente.Nome_Cliente,
					cliente.nome_fantasia,
					ISNULL(cg.Grupo, '') AS Grupo,
					Qtde_Notas =  isnull((select count(distinct(nfnota.Codigo)) from nf as nfnota 
										where convert(varchar,nfnota.EMISSAO,112) = convert(varchar,nf.EMISSAO,112) 
										and nfnota.Cliente_Fornecedor = nf.Cliente_Fornecedor),0),
					Total = Convert(decimal(15,2),Sum(NF_Item.Total+Isnull(NF_Item.Frete,0)))
			
				into #tempVendaNF2
				from NF inner join cliente on NF.Cliente_Fornecedor= cliente.Codigo_Cliente 
						 INNER JOIN NF_Item ON NF.Codigo = NF_ITEM.CODIGO and nf.Cliente_Fornecedor = nf_item.Cliente_Fornecedor and nf.Filial = nf_item.Filial
						 inner JOIN cliente_grupo  as cg on cg.id= cliente.grupo_empresa	
						 inner join Natureza_operacao np on.nf.Codigo_operacao = np.Codigo_operacao	
				 where (NF.Data between @DataDe and @DataAte ) 
				 AND Isnull(NF.NF_Canc,0) = 0 AND LTRIM(NF.Filial) = 'matriz'
				AND NF.Tipo_NF in (1,3) --Incluido a condição 3 - Emissao de Pedidos
				 and NP.NF_devolucao = 0 
					AND nf_item.codigo_operacao in ('5101', '5102','5405','5402','5403','6101', '6102','6405','6401','6403')  
				AND (LEN(@CNPJ)=0 OR LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(CLIENTE.CNPJ,'.',''),'/',''),'-','')))= @CNPJ)
				 group by NF.EMISSAO,nf.Cliente_Fornecedor,cliente.Nome_Cliente,cliente.nome_fantasia, Cliente.Grupo_Empresa, cg.grupo, nf.Total
				 ORDER BY CONVERT(VARCHAR,NF.EMISSAO,102) 
		END

	declare @StringVenda as Varchar(MAX)
	SET @StringVenda = 'SELECT * INTO ##TempVendaNF FROM ' + CASE WHEN @ID > 0 THEN '#TempVendaNF1' ELSE '#TempVendaNF2' END
	EXECUTE(@StringVenda)
	--SET @StringVenda = 'SELECT * INTO TempVendaNF FROM ' + CASE WHEN @ID > 0 THEN '#TempVendaNF1' ELSE '#TempVendaNF2' END
	--EXECUTE(@StringVenda)
	if(@tipo='ANALITICO')
	BEGIN
		Select 
		CONVERT(VARCHAR,EMISSAO,103) EMISSAO,
		Grupo,
		COD='SFT_'+Cod,
		Cliente= Nome_Cliente,
		nome_fantasia,
		Qtde_Notas,
		sum (Total) 
		from ##tempVendaNF	
		group by 
		EMISSAO,
		Grupo,
		Cod,
		Nome_Cliente,
		nome_fantasia,
		Qtde_Notas
	END
	ELSE	
	BEGIN
		if(@tipo='SINTETICO')
		begin  
			Select 
				Grupo,
				COD='SFT_'+Cod,
				Cliente =nome_Cliente,
				Fantasia=nome_fantasia,
				Total = Sum(Total) 
			 from
			 ##tempVendaNF
			 group by Grupo,COD, nome_Cliente,nome_fantasia
		end
		else
		begin 
			if(len(@cnpj)=0)
			begin
				Select 
					Grupo,
					Total = Sum(total)
				from ##tempVendaNF
				group by grupo
				order by sum(total) desc
			end
			else
			begin 
				Select 
				COD='SFT_'+Cod,
				Cliente=Nome_Cliente,
					Total = Sum(total)
				from ##tempVendaNF
				group by COD, Nome_Cliente
				order by sum(total) desc
			end 

		end 
	END
END
GO

ALTER TABLE NFE_XML ADD det_icms_vRedBCST Numeric(10,4)

go

/****** Object:  StoredProcedure [dbo].[sp_NFe_Det]    Script Date: 24/08/2022 13:06:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER   procedure [dbo].[sp_NFe_Det]
	@id varchar(47)
	as

	select ID,
		ide_nNF,
		emit_cnpj,
		ide_dEmi,
		det_prod_cProd,
		det_prod_cEAN,
		det_prod_xProd,
		det_prod_NCM,
		det_prod_EXTIPI,
		det_prod_genero,
		det_prod_CFOP,
		det_prod_uCOM,
		det_prod_qCOM,
		det_prod_vUnCOM,
		det_prod_vProd,
		det_prod_cEANTrib,
		det_prod_uTrib,
		det_prod_qTrib,
		det_prod_vUnTrib,
		det_prod_vFrete,
		det_prod_vSeg,
		det_prod_vDesc,
		det_prod_DI,
		det_prod_DetEspecifico,
		det_icms_orig,
		det_icms_CST,
		det_icms_modBC,
		det_icms_pRedBC,
		det_icms_vBC,
		det_icms_pICMS,
		det_icms_vICMS,
		det_icms_modBCST,
		det_icms_pMVAST,
		det_icms_pRedBCST,
		det_icms_vBCST,
		det_icms_pICMSST,
		det_icms_vICMSST,
		det_ipi_clEnq,
		det_ipi_CNPJProd,
		det_ipi_cSelo,
		det_ipi_qSelo,
		det_ipi_cEnq,
		det_ipi_CST,
		det_ipi_vBC,
		det_ipi_pIPI,
		det_ipi_vIPI,
		det_ipi_qUnid,
		det_ipi_vUnid,
		det_II_vBC,
		det_II_vDespAdu,
		det_II_vII,
		det_II_vIOF,
		det_pis_CST,
		det_pis_vBC,
		det_pis_pPIS,
		det_pis_vPIS,
		det_pis_qBCProd,
		det_pis_vAliqProd,
		det_pisst_vBC,
		det_pisst_pPIS,
		det_pisst_vPIS,
		det_pisst_qBCProd,
		det_pisst_vAliqProd,
		det_cofins_CST,
		det_cofins_vBC,
		det_cofins_pCOFINS,
		det_cofins_vCOFINS,
		det_cofins_qBCProd,
		det_cofins_vAliqProd,
		det_cofinsst_vBC,
		det_cofinsst_pCOFINS,
		det_cofinsst_vCOFINS,
		det_cofinsst_qBCProd,
		det_cofinsst_vAliqProd,
		det_issqn2g_vBC,
		det_issqn2g_vAliq,
		det_issqn2g_vISSQN,
		det_issqn2g_cMunFG,
		det_issqn2g_cListServ,
		det_issqn2g_cSitTrib,
		det_icms_CSOSN,
		det_icms_pCredSN,
		det_icms_vCredICMSSN,
		det_nItem,
		det_prod_vOutro,
		det_prod_indTot,
		det_prod_CEST,
		det_ICMS_vBCFCP,
		det_ICMS_pFCP,
		det_ICMS_vFCP,
		det_ICMS_vBCFCPST,
		det_ICMS_pFCPST,
		det_ICMS_vFCPST = convert(float,det_ICMS_vFCPST),
		det_icms_vRedBCST 
	from 
		nfe_xml 
	where 
		id=@id 
		and det_prod_cprod is not null
	Order By
		det_nItem



GO

go

if not exists(select 1 from PARAMETROS where PARAMETRO='PEDIDO_VDA_RAP_CUSTO_MRG')
begin	
INSERT INTO [PARAMETROS]
           ([PARAMETRO]
           ,[PENULT_ATUALIZACAO]
           ,[VALOR_DEFAULT]
           ,[ULT_ATUALIZACAO]
           ,[VALOR_ATUAL]
           ,[DESC_PARAMETRO]
           ,[TIPO_DADO]
           ,[RANGE_VALOR_ATUAL]
           ,[GLOBAL]
           ,[NOTA_PROGRAMADOR]
           ,[ESCOPO]
           ,[POR_USUARIO_OK]
           ,[DATA_PARA_TRANSFERENCIA]
           ,[PERMITE_POR_EMPRESA])
     VALUES
           ('PEDIDO_VDA_RAP_CUSTO_MRG'
           ,GETDATE()
           ,'FALSE'
           ,GETDATE()
           ,'FALSE'
           ,'VISUALIZAR CUSTO E MARGEM NA INCLUSAO DE ITEM RAPIDO'
           ,''
           ,0
           ,1
           ,''
           ,0
           ,0
           ,NULL
           ,0)
 end
GO

ALTER TALB Saida_EStoque add Data_Devolucao DateTime, Qtde_Devolvida decimal(10,3) default 0
go

GO
/****** Object:  StoredProcedure [dbo].[sp_Movimento_Venda]    Script Date: 10/10/2022 13:00:54 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER  Procedure [dbo].[sp_Movimento_Venda]

                @Filial				As Varchar(20),
                @DataDe				As Varchar(8),
                @DataAte			As Varchar(8),
                @finalizadora		As varchar(30),
                @plu				As varchar(17),
                @cupom				As varchar(20),
                @pdv				as varchar(10),                
                @horaInicio			as varchar(5),				
				@horafim			as varchar(5),
				@cancelados			as varchar(15),
				@comanda			as varchar(20),
				@ext_sat			as varchar(6)

AS

begin 
--exec     sp_Movimento_Venda   @Filial='MATRIZ', @DataDe = '20180602',  @dataate = '20180602',  @horaInicio = '00:00',  @horafim = '23:59',  @finalizadora = 'TODOS',  @Pdv = 'TODOS',  @plu = '',  @cupom = '',  @comanda = '',  @cancelados = 'TODOS',  @ext_sat = '' 

Select Data_movimento, S.Documento, S.PLU, m.DESCRICAO, S.QTDE, vlr, Desconto,  Acrescimo ,
	Caixa_Saida, Ext_SAT = '', Hora_venda, ComandaPedidoCupom, Finalizadora = 'NAO FINALIZADOS'
Into 
	#CupomSemPagamento
From 
	Saida_estoque s INNER JOIN Mercadoria m on s.plu = m.plu 
	Where 
		s.Data_movimento BETWEEN @DataDe AND @DataAte
	And 
		not s.data_cancelamento is null
	And 
		s.Filial = @FILIAL   
	And 
		not exists(select * from Lista_finalizadora l 
					Where l.documento = s.documento and l.Emissao = s.data_movimento
						And l.pdv = s.caixa_saida
						And l.filial = s.Filial)


--exec sp_Movimento_Venda @Filial='MATRIZ', @DataDe = '20180705',  @dataate = '20180705',  @horaInicio = '00:00',  @horafim = '23:59',  @finalizadora = 'TODOS',  @Pdv = 'TODOS',  @plu = '',  @cupom = '',  @comanda = '',  @cancelados = '',  @ext_sat = '' 
IF(@plu='' AND @cupom='' and @ext_sat ='')

      BEGIN

            IF(@finalizadora ='TODOS')

                  BEGIN

                        SELECT DISTINCT

                             DATA = CONVERT(VARCHAR,lista.EMISSAO,103),

                             lista.PDV,

                             CUPOM = lista.DOCUMENTO,
                             [Ext SAT ] = 'SFT_'+SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
                             CONVERT(varchar , s.Hora_venda,108) as HORA,
                             
							[COMANDA/PEDIDOS] =  '_'+(SELECT Max(ComandaPedidoCupom) FROM Saida_estoque st  with (index(IX_Movimento_venda_01))

								WHERE st.Filial = @FILIAL And st.data_cancelamento is null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento),
                        
                             
                             FINALIZADORA = lista.id_finalizadora,
							
						     VLR = (SELECT isnull(convert(decimal(18,2),SUM(list1.Total )),0) 
										FROM Lista_finalizadora list1
				                             INNER JOIN Finalizadora ON list1.finalizadora = finalizadora.Nro_Finalizadora 
								  			 --INNER JOIN  Saida_estoque S  with (index(IX_Movimento_venda_01)) ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv and CONVERT(varchar , s.Hora_venda,108) between @horaInicio and @horafim
									WHERE list1.Filial = @FILIAL And Isnull(Cancelado,0) = 0 
											 AND (list1.Emissao = lista.Emissao)
											 and list1.pdv =lista.pdv
											 and list1.documento = lista.documento
											 AND LIST1.id_finalizadora = LISTA.id_finalizadora
                         ),
                             CANCELADOS = (SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) 
										    FROM Saida_estoque st  with (index(IX_Movimento_venda_01)) 
											WHERE st.Filial = @FILIAL And data_cancelamento is not null 
													and CONVERT(varchar , st.Hora_venda,108) between @horaInicio and @horafim 
													AND (st.Data_movimento = lista.Emissao)
													and st.Caixa_Saida =lista.pdv
													and st.documento = lista.documento),
						 [CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)

						INTO #LISTA_TEMP FROM Lista_finalizadora lista
                            INNER JOIN Finalizadora ON lista.finalizadora = finalizadora.Nro_Finalizadora 
							INNER JOIN Saida_estoque S  with (index(IX_Movimento_venda_01))  ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv	and s.Data_movimento = lista.Emissao
                        WHERE lista.Filial = @FILIAL  AND (Emissao BETWEEN @DataDe  AND  @DataAte )
								  and CONVERT(varchar , s.Hora_venda,108) between @horaInicio and @horafim 
                                   and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
								   and (LEN(@cancelados)=0 OR
										
										(@cancelados ='TODOS' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																							WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
																								AND (st.Data_movimento = lista.Emissao)
																							   and st.Caixa_Saida =lista.pdv
																							   and st.documento = lista.documento))>0) 
										OR (@cancelados='ITEM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=0 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0) 
										OR (@cancelados='CUPOM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=1 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0)												   
																						   
																						   ) 
																						   
						and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
						
						--Incluir Registros sem Pagamento
						Insert into #LISTA_TEMP
						Select  DISTINCT
							DATA = CONVERT(VARCHAR,c.Data_movimento,103)
						  , PDV = c.Caixa_Saida
						  , Cupom = Documento
						  , Ext_SAT
						  , CONVERT(varchar , C.Hora_venda,108) as HORA
						  , [COMANDA/PEDIDOS] = '_'+ Max(ComandaPedidoCupom)
						  , Finalizadora
						  , vlr = 0
						  , Cancelados = SUM(Vlr-isnull(Desconto,0)) 
						  ,''
						From 
							#CupomSemPagamento c 
						Where
							CONVERT(varchar , c.Hora_venda,108) between @horaInicio and @horafim 
						--And 
						--	(LEN(@comanda)=0 or c.ComandaPedidoCupom  like '%'+@comanda+'%')
						and 
							Finalizadora = (case when @cancelados = ''				 then 'NAO FINALIZADOS' 
													when @cancelados = 'NAO FINALIZADOS' then 'NAO FINALIZADOS' 
													when @cancelados = 'TODOS'			 then 'NAO FINALIZADOS' 
													else 'NAO APARECE NADA' end)								
						Group By 			
							c.Data_movimento, c.Caixa_Saida, Documento, Ext_SAT, Finalizadora	, HORA_VENDA																																	   
                       
                       ----*******************************************************---------
                       
					   
						UPDATE #LISTA_TEMP SET CANCELADOS = (CANCELADOS/(SELECT COUNT(B.CUPOM) FROM #LISTA_TEMP AS B WHERE  B.CUPOM = #LISTA_TEMP.CUPOM and b.pdv = #LISTA_TEMP.pdv)  ) 
						WHERE CUPOM IN (SELECT CUPOM FROM #LISTA_TEMP where CANCELADOS >0 GROUP BY CUPOM,pdv HAVING   COUNT(CUPOM) > 1   )
						AND CANCELADOS >0
						

                       SELECT DISTINCT * FROM #LISTA_TEMP
					   

                  END

            ELSE

                  BEGIN

                        SELECT

                             DATA = CONVERT(VARCHAR,EMISSAO,103),

                             PDV,

                             CUPOM = lista.DOCUMENTO,
                             [Ext SAT] = 'SFT_'+SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
                             CONVERT(varchar , Hora_venda,108) AS HORA,

                             [COMANDA/PEDIDOS] = '_'+(SELECT Max(ComandaPedidoCupom) FROM Saida_estoque st

								WHERE st.Filial = @FILIAL And data_cancelamento is null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento),
                                   VLR =(SELECT isnull(convert(decimal(18,2),SUM(list1.Total )),0) FROM Lista_finalizadora list1

                             INNER JOIN Finalizadora ON list1.finalizadora = finalizadora.Nro_Finalizadora 

                        WHERE list1.Filial = @FILIAL And Isnull(Cancelado,0) = 0 
									AND (list1.Emissao = lista.Emissao)
                                   and list1.pdv =lista.pdv
                                   and list1.documento = lista.documento
                                   
                         ),        

                             FINALIZADORA = id_finalizadora,
                             
                     
                             CANCELADO = (SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st  with (index(IX_Movimento_venda_01))

								WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento
                                    ),
							[CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
													Select TOP 1 S2.ID_CHAVE		 
													FROM SAIDA_ESTOQUE  AS S2
													WHERE S2.Documento = S.Documento
														AND S2.Caixa_Saida = S.Caixa_Saida
														AND S2.Data_movimento = S.Data_movimento
														AND S2.Filial = S.Filial
														AND S2.ID_Chave IS NOT NULL
												)
										)


                      INTO #LISTA_TEMP2   FROM

                             Lista_finalizadora lista

                             INNER JOIN Finalizadora ON lista.finalizadora = finalizadora.Nro_Finalizadora 
                             INNER JOIN  Saida_estoque S  ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv and s.Data_movimento = lista.Emissao

                        WHERE lista.Filial = @FILIAL  AND (Emissao BETWEEN @DataDe  AND  @DataAte )

                        AND finalizadora.Finalizadora  = @finalizadora 
						and CONVERT(varchar , Hora_venda,108) between @horaInicio and @horafim 
                         and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
						 and (LEN(@cancelados)=0 OR
								(@cancelados ='TODOS' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																							WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
																								AND (st.Data_movimento = lista.Emissao)
																							   and st.Caixa_Saida =lista.pdv
																							   and st.documento = lista.documento))>0) 
										OR (@cancelados='ITEM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=0 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0) 
										OR (@cancelados='CUPOM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=1 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0)												   
																						   
																						   ) 
									
                       and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                      --  GROUP BY Emissao, PDV, lista.DOCUMENTO ,id_finalizadora,CONVERT(varchar , Hora_venda,108),SUBSTRING(S.ID_CHAVE,35,6)




                             SELECT DISTINCT * FROM #LISTA_TEMP2

                  END

      END

 

ELSE IF (@plu<>'' AND @cupom='' and @ext_sat = '')

BEGIN

      SELECT CUPOM = S.Documento,
			 [Ext SAT] = SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
             DATA = CONVERT(VARCHAR,s.Data_movimento,103),
             HORA = convert(varchar,Hora_venda),
	         PDV=convert(varchar,s.caixa_saida) ,
			 'PLU'+S.PLU as PLU,
			 DESCRICAO =M.Descricao,
             QTDE=replace(convert(varchar,S.Qtde),'.',','),
             VLR=replace(convert(varchar,S.vlr),'.',','),
			 [-DESCONTO]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),
			 [+ACRESCIMO]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),
			 TOTAL=replace(convert(varchar,(s.vlr-isnull(s.Desconto,0))+ISNULL(s.acrescimo,0)),'.',',') ,
			 [CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
					Select TOP 1 S2.ID_CHAVE		 
					FROM SAIDA_ESTOQUE  AS S2
					WHERE S2.Documento = S.Documento
						AND S2.Caixa_Saida = S.Caixa_Saida
						AND S2.Data_movimento = S.Data_movimento
						AND S2.Filial = S.Filial
						AND S2.ID_Chave IS NOT NULL
					)
			 )

      FROM Saida_estoque S  with (index(IX_saida_estoque)) 
					--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
                    INNER JOIN Mercadoria M ON S.PLU = M.PLU      
	  where s.Filial = @filial 
                        and s.Data_movimento BETWEEN @DataDe  AND  @DataAte
						and (len(@plu)=0 or s.PLU = @plu )
                        and (LEN(@cupom)=0 or  s.Documento  =  @cupom  )
                        And s.Data_Cancelamento is null
                         --and (LEN(@pdv)=0 or l.pdv = @pdv)
                        and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                        and CONVERT(varchar , Hora_venda,108) between @horaInicio and @horafim 
						and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                        --Group by s.Documento,l.Emissao,l.pdv,s.plu,m.descricao,s.Qtde,s.vlr,s.Desconto,s.Acrescimo,Hora_venda
                        order by s.Data_movimento , Hora_venda

      END

ELSE

      BEGIN
      
            SELECT	CUPOM = S.Documento, --1
					[Ext SAT] = SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),--2
					DATA = CONVERT(VARCHAR,s.Data_movimento,103), --3
					PDV=convert(varchar,s.caixa_saida) ,--4
					'PLU'+S.PLU AS PLU, --5
					DESCRICAO = M.Descricao, --6
					QTDE=replace(convert(varchar,S.Qtde),'.',','),--7
					VLR=replace(convert(varchar,S.vlr),'.',','),--8
					[-DESCONTO]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),--9
					[+ACRESCIMO]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),--10
					TOTAL=replace(convert(varchar,(s.vlr-isnull(s.Desconto,0))+ISNULL(s.acrescimo,0)),'.',','), --11
					[CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
							Select TOP 1 S2.ID_CHAVE		 
							FROM SAIDA_ESTOQUE  AS S2
							WHERE S2.Documento = S.Documento
								AND S2.Caixa_Saida = S.Caixa_Saida
								AND S2.Data_movimento = S.Data_movimento
								AND S2.Filial = S.Filial
								AND S2.ID_Chave IS NOT NULL
							)
					 )

            FROM Saida_estoque S  with (index(IX_Movimento_venda_01)) 
						--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
						INNER JOIN Mercadoria M ON S.PLU = M.PLU      
			where s.Documento like (case when @cupom <>'' then @cupom  else '%' end  )
						and (len(@ext_sat)=0 or SUBSTRING(S.ID_CHAVE,35,6)= @ext_sat)
                        and s.PLU like (case when @plu <>'' then @plu else '%' end )
                        and s.data_movimento BETWEEN @DataDe  AND  @DataAte
                        And s.Data_Cancelamento is null
						and s.Data_movimento between @DataDe aND @DataAte 
                        and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                        and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                       --Group by s.Documento,s.data_movimento,s.caixa_saida,s.plu,m.descricao,s.Qtde,s.vlr,s.Desconto,s.Acrescimo,Hora_venda,SUBSTRING(S.ID_CHAVE,35,6)
		union all                      
			SELECT '',--1
				   '',--2
                   '|-CANCELADO-|',--3
				   pdv=convert(varchar,s.caixa_saida) ,--4
                   '|-'+S.PLU+'-|',--5
                   '|-'+M.Descricao+'-|', --6
                   Qtde=replace(convert(varchar,S.Qtde),'.',','),--7
                   Vlr=replace(convert(varchar,S.vlr),'.',','),--8
                   [-Desconto]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),--9
                   [+Acrescimo]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),--10
                   Total='0,000', --11
				   ''--12
            FROM Saida_estoque S  with (index(IX_Movimento_venda_01))
				--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
				INNER JOIN Mercadoria M ON S.PLU = M.PLU      
			where s.Documento like (case when @cupom <>'' then @cupom  else '%' end  )
					and (len(@ext_sat)=0 or SUBSTRING(S.ID_CHAVE,35,6)= @ext_sat)
					and s.PLU like (case when @plu <>'' then @plu else '%' end )
                    and s.data_movimento BETWEEN @DataDe  AND  @DataAte
                	And s.Data_Cancelamento is NOT null
					and s.Data_movimento between @DataDe aND @DataAte 
                    and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                    and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
		union all

            select  '',--1
					'',--2
					'',--3
					'',--4
					'',--5
					'|-'+ id_finalizadora+'-|'  ,--6
					'',--7
					'',--8
					'',--9
					'',--10
					 '|-'+replace(convert(varchar,(SUM(Lista_Finalizadora.Total))),'.',',')+'-|' --11
					,'' -- 12
			from Lista_finalizadora
			where  Documento like (case when @cupom <>'TODOS' then @cupom  else '%' end  )
		
                   and Emissao BETWEEN @DataDe  AND  @DataAte
                   And Isnull(Cancelado,0) = 0
                   and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
			GROUP BY Emissao, PDV, DOCUMENTO ,id_finalizadora

                       

      END


end

go

alter table NF_Manifestar ADD Numero_Protocolo Varchar(100), Situacao Tinyint, Validada_Comercial Tinyint, Integrado TinyInt default 0



CREATE TRIGGER [dbo].[utg_Manifesto] ON [dbo].[NF_Manifestar]
   AFTER UPDATE
AS 

DECLARE @CHAVE AS VARCHAR(60)

SELECT @CHAVE = INSERTED.CHAVE FROM INSERTED

BEGIN
	IF UPDATE(nfeXML)
		BEGIN
			UPDATE 
				NF_Manifestar
				SET Integrado = 0
			WHERE Chave = @CHAVE 
		END
END


GO




/****** Object:  StoredProcedure [dbo].[SP_REL_TOTAIS_TESOURARIA]    Script Date: 18/10/2022 14:38:25 ******/
IF EXISTS (SELECT name FROM sys.objects WHERE type = 'P' AND name = 'SP_REL_TOTAIS_TESOURARIA')
Begin
	DROP PROCEDURE SP_REL_TOTAIS_TESOURARIA
end
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- exec SP_REL_TOTAIS_TESOURARIA @Filial='MATRIZ', @datade = '20221017',  @dataate = '20221018',  @finalizadora = 'TODOS',  @operador = 'TODOS',  @Status = 'PENDENTE' 
--PROCEDURES =======================================================================================
CREATE PROCEDURE [dbo].[SP_REL_TOTAIS_TESOURARIA]
    @FILIAL			AS VARCHAR(17),
    @DataDe			As Varchar(8),
    @DataAte		As varchar(8), 
    @Operador		As Varchar(40),
    @finalizadora   As Varchar(40),
	@STATUS			As Varchar(40)
AS
BEGIN
    declare @strWhere As nVarchar(max)
    declare @strqUERY As nVarchar(max)

    set @strWhere = ''
    set @strqUERY = ''
	IF(@STATUS <> 'FECHADO')
		begin
			delete td from tesouraria_detalhes td  inner join Status_Pdv s on td.Emissao =convert(varchar,s.data_abertura,23)
			 and td.pdv=s.pdv and td.operador=s.Id_Operador and td.filial = s.filial where s.filial = @FILIAL and s.status <> 'FECHADO';
			 insert into tesouraria_detalhes 
			 (filial,emissao,pdv,cupom,operador,total,finalizadora,id_finalizadora,id_cartao,autorizacao,id_bandeira,rede_cartao,hora_venda,vencimento,taxa,id_fechamento) 
			 Select distinct  lf.filial,  lf.Emissao,  lf.pdv, lf.cupom, lf.operador, lf.total, lf.finalizadora, lf.id_finalizadora, cartao.id_cartao, lf.autorizacao, lf.id_Bandeira,
			 rede_cartao = case when isnull(lf.autorizacao,'')in ('','0') then '' else  lf.rede_cartao   end,
			 (Select max(hora_venda) from Saida_Estoque as se where  se.Filial=lf.filial and se.Data_movimento= lf.Emissao and se.Caixa_Saida=lf.pdv and se.Documento=lf.cupom )as hora,
			 lf.vencimento, lf.taxa,lf.id_movimento from Lista_finalizadora lf left join Cartao on cartao.nro_Finalizadora=lf.finalizadora and 
			 convert( int ,lf.rede_cartao)= convert(int,Cartao.id_rede) and convert(int,lf.id_Bandeira)= convert(int ,Cartao.id_bandeira) 
			 left join tesouraria_detalhes td  on lf.cupom = td.cupom and lf.emissao = td.emissao and lf.pdv = td.pdv  and lf.filial = td.filial 
			 inner join (select status,id_fechamento,Emissao =convert(varchar,data_abertura,23), pdv, operador = id_operador, filial from Status_Pdv 
			 where status <> 'FECHADO' and filial = @FILIAL and convert(varchar,Data_Abertura,112) between convert(date,@DataDe) and convert(date,@DataAte)) as v on 
			 lf.emissao = v.Emissao and lf.filial = v.Filial and lf.operador = v.operador and lf.pdv = v.Pdv and lf.id_movimento = v.id_fechamento where	isnull(lf.Cancelado,0) <> 1 
			 order by Emissao,cartao.id_cartao;
		end
    if (@Operador <>'TODOS')
        set @strWhere ='AND UPPER(o.nome) = ' + char(39) + @Operador  + char(39) + ' '
    
    if (@finalizadora <>'TODOS')
        set @strWhere = @strWhere + 'AND UPPER(t.id_finalizadora) like ' + char(39) + '%' + @finalizadora + '%' + char(39) + ' '
	
    if (@STATUS <>'FECHADO')
		begin
			set @strWhere = @strWhere + 'AND UPPER(ltrim(rtrim(isnull(s.status,'+ char(39) + char(39) +')))) not like ' + char(39) + 'FECHADO' + char(39) + ' '
		end
	else
		begin
			set @strWhere = @strWhere + 'AND UPPER(ltrim(rtrim(isnull(s.status,'+ char(39) + char(39) +')))) = ' + char(39) + 'FECHADO' + char(39) + ' '
		end

	set @strqUERY = 'select  ID_Nome_Caixa = convert(varchar,o.ID_Operador) + ' + CHAR(39) + '-' + CHAR(39) + ' + replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(UPPER(o.nome),'
	set @strqUERY = @strqUERY + '' + CHAR(39) + '0' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '1' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '2' + CHAR(39) + ',' 
	set @strqUERY = @strqUERY + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '3' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '4' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' 
	set @strqUERY = @strqUERY + CHAR(39) + '5' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '8' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '9' + CHAR(39) + ',' 
	set @strqUERY = @strqUERY + CHAR(39)  + CHAR(39) + '),' + CHAR(39) + '0' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '-' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '), '
	set @strqUERY = @strqUERY + 'Status_Caixa = (case when s.status=' + CHAR(39) + 'FECHADO' + CHAR(39) + ' then ' + CHAR(39) + 'FECHADO' + CHAR(39) + ' else ' + CHAR(39) + 'PENDENTE' + CHAR(39) + '' 
	set @strqUERY = @strqUERY + ' end),Finalizadora = t.id_finalizadora, Registrado_Sistema = convert(float,t.Total_Sistema),Informado_Caixa = convert(float,t.Total_Entregue), '
	set @strqUERY = @strqUERY + 'Diferenca = convert(float,convert(decimal(21,2),convert(float,t.Total_Entregue) - convert(float,t.Total_Sistema))), Data = convert(varchar,t.DATA_ABERTURA,103) '
	set @strqUERY = @strqUERY + 'into #rel_totais_tesouraria from tesouraria t '
	set @strqUERY = @strqUERY + 'inner join status_pdv s on t.ID_OPERADOR=s.id_operador and t.pdv = s.pdv and t.id_fechamento = s.id_fechamento ' 
	set @strqUERY = @strqUERY + 'inner join filial f on f.filial=t.FILIAL and convert(varchar,t.DATA_ABERTURA,23) = convert(varchar,s.Data_Abertura,23) '
	set @strqUERY = @strqUERY + 'inner join operadores o on o.ID_Operador=t.ID_OPERADOR '
	set @strqUERY = @strqUERY + 'where t.FILIAL = ' + CHAR(39) + @FILIAL + CHAR(39) + ' and convert(varchar,s.Data_Abertura,112) between ' + CHAR(39) + @Datade + CHAR(39) + ' and ' + CHAR(39) + @DataAte + CHAR(39) + ' ' 
	set @strqUERY = @strqUERY + @strWhere
	--set @strqUERY = @strqUERY +' order by convert(varchar,s.Data_Abertura,23) asc, replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(UPPER(o.nome),'
	--set @strqUERY = @strqUERY + '' + CHAR(39) + '0' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '1' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '2' + CHAR(39) + ',' 
	--set @strqUERY = @strqUERY +  + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '3' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '4' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' 
	--set @strqUERY = @strqUERY + + CHAR(39) + '5' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '8' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '9' + CHAR(39) + ',' 
	--set @strqUERY = @strqUERY + + CHAR(39)  + CHAR(39) + '),' + CHAR(39) + '0' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '-' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + ') asc'
	if (@STATUS <>'FECHADO')
		begin
			set @strqUERY = @strqUERY + '; insert  #rel_totais_tesouraria '
			set @strqUERY = @strqUERY + 'select distinct ID_Nome_Caixa = convert(varchar,o.ID_Operador) + ' + CHAR(39) + '-' + CHAR(39) + ' + replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(UPPER(o.nome),'
			set @strqUERY = @strqUERY + '' + CHAR(39) + '0' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '1' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '2' + CHAR(39) + ',' 
			set @strqUERY = @strqUERY + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '3' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '4' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' 
			set @strqUERY = @strqUERY + CHAR(39) + '5' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '8' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '9' + CHAR(39) + ',' 
			set @strqUERY = @strqUERY + CHAR(39)  + CHAR(39) + '),' + CHAR(39) + '0' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '),' + CHAR(39) + '-' + CHAR(39) + ',' + CHAR(39) + CHAR(39) + '), '
			set @strqUERY = @strqUERY + 'Status_Caixa = ' + CHAR(39) + 'PENDENTE' + CHAR(39) + ',Finalizadora = d.id_finalizadora, Registrado_Sistema = convert(float,(select sum(Total) from tesouraria_detalhes '
			set @strqUERY = @strqUERY + 'where operador = d.operador and pdv = d.pdv and id_fechamento = d.id_fechamento and convert(varchar,emissao,23) = convert(varchar,d.emissao,23) and OPERADOR=d.OPERADOR and FILIAL = d.FILIAL and id_finalizadora = d.id_finalizadora)), '
			set @strqUERY = @strqUERY + 'Informado_Caixa  = convert(float,0), Diferenca = convert(float,0), Data = convert(varchar,d.emissao,103) '
			set @strqUERY = @strqUERY + 'from tesouraria_detalhes d '
			set @strqUERY = @strqUERY + 'inner join tesouraria t on t.ID_OPERADOR <> d.operador and t.pdv <> d.pdv and t.id_fechamento <> d.id_fechamento ' 
			set @strqUERY = @strqUERY + 'and convert(varchar,d.emissao,23) <> convert(varchar,t.Data_Abertura,23) '
			set @strqUERY = @strqUERY + 'inner join status_pdv s on d.OPERADOR=s.id_operador and d.pdv = s.pdv and d.id_fechamento = s.id_fechamento ' 
			set @strqUERY = @strqUERY + 'inner join filial f on f.filial=d.FILIAL and convert(varchar,d.emissao,23) = convert(varchar,s.Data_Abertura,23) '
			set @strqUERY = @strqUERY + 'inner join operadores o on o.ID_Operador=d.OPERADOR '
			set @strqUERY = @strqUERY + 'where d.FILIAL = ' + CHAR(39) + @FILIAL + CHAR(39) + ' and convert(varchar,s.Data_Abertura,112) between ' + CHAR(39) + @Datade + CHAR(39) + ' and ' + CHAR(39) + @DataAte + CHAR(39) + ' ' 
			set @strWhere = @strWhere + 'AND UPPER(ltrim(rtrim(isnull(s.status,'+ char(39) + char(39) +')))) = ' + char(39) + 'OPERANDO' + char(39) + ' '
			set @strqUERY = @strqUERY + @strWhere
		end
	set @strqUERY = @strqUERY + '; select distinct ID_Nome_Caixa,Status_Caixa,Finalizadora,Registrado_Sistema,Informado_caixa, Diferenca = Convert(float,Convert(decimal(21,2),(Registrado_Sistema - Informado_caixa))),Data from #rel_totais_tesouraria order by data asc, ID_Nome_Caixa,Finalizadora desc'
	--print @strqUERY
	execute(@strQuery)
end

--Rodar Este Comando em Separado !!!

--**   ALTER DATABASE Bratterweb SET COMPATIBILITY_LEVEL = 100

--Rodar Este Comando em Separado !!!

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Rel_Fin_ResumoPorOperador')
DROP PROCEDURE [sp_Rel_Fin_ResumoPorOperador]
GO
/****** Object:  StoredProcedure [dbo].[sp_Rel_Fin_ResumoPorOperador]    Script Date: 10/05/2022 19:17:43 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- sp_Rel_Fin_ResumoPorOperador 'matriz','20220425', '20220425', '12-GUILHERME', 'TODOS', '00:00', '23:59'
--PROCEDURES =======================================================================================
create PROCEDURE [dbo].[sp_Rel_Fin_ResumoPorOperador](
	@FILIAL 	AS VARCHAR(17),
	@Data		As Varchar(8),
	@DataAte	as varchar(8), --novo
	@Operador	As Varchar(40),
	@Pdv		As Varchar(10),
	@horade		As varchar(5),
	@horaate	As varchar(5))
as
 
IF (OBJECT_ID('tempdb..##lixoRelOperador') IS NOT NULL)
	DROP TABLE ##lixoRelOperador


if len(@horade)= 0
	begin
		set @horade = '0'
	end
if len(@horaate) = 0
	begin
		set @horaate = '24'
	end
	
Declare @pIndex int 
Declare @idOp int 

if @Operador <> 'TODOS'
	begin
		set @pIndex= CHARINDEX('-', @Operador)	
		set @idOp = SUBSTRING(@Operador,0,@pIndex)

	end

Select 
	RTRIM(LTRIM(Operadores.Nome)) + ' PDV:' + CONVERT(VARCHAR, Lista_finalizadora.pdv) + '- ID Movimento:' + CONVERT(VARCHAR, LISTA_FINALIZADORA.ID_MOVIMENTO)
	+ ' Qtde Cupons: ' + CONVERT(VARCHAR, (SELECT COUNT(*) FROM (SELECT DISTINCT s.Documento, s.Caixa_Saida FROM Saida_estoque s 
								WITH (INDEX=IX_Saida_Estoque) WHERE s.Filial = Lista_finalizadora.filial 
								AND s.Data_movimento = Lista_finalizadora.Emissao
								AND s.data_cancelamento IS NULL 
								AND s.Codigo_Funcionario = Operadores.ID_Operador) AS sRel)) AS Movimento, 
	Lista_Finalizadora.Emissao,
	isnull(finalizadora.Finalizadora,'Outra') as Finalizadora, sum(ISNULL(total,0)) as valor,
	Operadores.ID_Operador, Lista_finalizadora.id_movimento 
	into ##lixoRelOperador
From 	Lista_Finalizadora with (index=IX_Lista_Finalizadora_ResumoPorDia)
	Left Outer Join	finalizadora on lista_finalizadora.finalizadora = finalizadora.nro_finalizadora
	INNER JOIN Operadores ON Operadores.ID_Operador = Lista_finalizadora.operador 
Where
	lista_finalizadora.filial = @filial and 
	Emissao between @data and @DataAte  
    --and (@Operador='TODOS' OR isnull(Operador ,'') = @idOp)
	--and (pdv = @Pdv or @pdv='TODOS')and
	and operador like (case when @idOp > 0 then CONVERT(VARCHAR, @idOp) else '%' end)
	and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
	and isnull(cancelado,0) = 0 And
	exists(Select * from saida_Estoque  with (index=ix_saida_estoque) where saida_estoque.filial = @filial 
			and data_movimento between @data and @dataate and 
			convert(decimal(18,2),substring(replace(hora_venda,':','.'),1,5)) 
					between isnull(convert(decimal(18,2), replace(@horade,':','.')),0) and isnull(convert(decimal(18,2), replace(@horaate,':','.')),24)
			and Lista_finalizadora.pdv = saida_estoque.Caixa_Saida 
			and lista_finalizadora.cupom = saida_Estoque.documento)
group by 
		Lista_Finalizadora.Filial, Operadores.Nome, operadores.id_operador, Lista_Finalizadora.PDV, LISTA_FINALIZADORA.ID_MOVIMENTO,  
	Lista_Finalizadora.Emissao, finalizadora.Finalizadora
order by Lista_finalizadora.Emissao, 1

select 
case when b.emissao is null then '|-' + b.Movimento + '-|' else convert(varchar, b.emissao, 103) end as Movimento, 
isnull(b.Finalizadora,'|-Sub Total-|') as Finalizadora,  case when b.emissao is null then '|-' +  REPLACE(convert(varchar, total), '.', ',') + '-|' else  REPLACE(convert(varchar, total), '.', ',') end as Total
from (
Select Movimento, Emissao, Finalizadora, Sum(valor) as Total from ##lixoRelOperador
group by movimento, rollup( emissao, Finalizadora)) as b
where (b.emissao is not null and b.Finalizadora is not null) or b.emissao is null and b.Finalizadora is null 
union all
select '' as Movimento,
Finalizadora,
REPLACE(convert(varchar, sum(valor)), '.', ',')  as total
from ##lixoRelOperador
group by finalizadora 
union all
select 
'|-Qtde total de cupons:' + CONVERT(VARCHAR, (SELECT COUNT(*) FROM (SELECT DISTINCT s.Documento, s.Caixa_Saida FROM Saida_estoque s 
								WITH (INDEX=IX_Saida_Estoque) WHERE s.Filial = @filial 
								AND s.Data_movimento BETWEEN @Data AND @DataAte 
								AND s.data_cancelamento IS NULL) AS sRel)) + '-|' as movimento,
'|-Total-|' as finalizadora,
'|-' +  REPLACE(convert(varchar, sum(valor)), '.', ',') + '-|'    as total
from ##lixoRelOperador
go


IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('Mercadoria') 
            AND  UPPER(COLUMN_NAME) = UPPER('Codigo_Produto_ANVISA'))
begin
	alter table Mercadoria alter column Codigo_Produto_ANVISA VARCHAR(13)
end
else
begin
	alter table Mercadoria add Codigo_Produto_ANVISA VARCHAR(13)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('Mercadoria') 
            AND  UPPER(COLUMN_NAME) = UPPER('Motivo_Isencao_ANVISA'))
begin
	alter table Mercadoria alter column Motivo_Isencao_ANVISA VARCHAR(255)
end
else
begin
	alter table Mercadoria add Motivo_Isencao_ANVISA VARCHAR(255)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('Mercadoria') 
            AND  UPPER(COLUMN_NAME) = UPPER('Preco_Maximo_ANVISA'))
begin
	alter table Mercadoria alter column Preco_Maximo_ANVISA Decimal(13,2)
end
else
begin
	alter table Mercadoria add Preco_Maximo_ANVISA Decimal(13,2)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF_Item') 
            AND  UPPER(COLUMN_NAME) = UPPER('Codigo_Produto_ANVISA'))
begin
	alter table NF_Item alter column Codigo_Produto_ANVISA VARCHAR(13)
end
else
begin
	alter table NF_Item add Codigo_Produto_ANVISA VARCHAR(13)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF_Item') 
            AND  UPPER(COLUMN_NAME) = UPPER('Motivo_Isencao_ANVISA'))
begin
	alter table NF_Item alter column Motivo_Isencao_ANVISA VARCHAR(255)
end
else
begin
	alter table NF_Item add Motivo_Isencao_ANVISA VARCHAR(255)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF_Item') 
            AND  UPPER(COLUMN_NAME) = UPPER('Preco_Maximo_ANVISA'))
begin
	alter table NF_Item alter column Preco_Maximo_ANVISA Decimal(13,2)
end
else
begin
	alter table NF_Item add Preco_Maximo_ANVISA Decimal(13,2)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('inventario') 
            AND  UPPER(COLUMN_NAME) = UPPER('DataHora_Inclusao'))
begin
	alter table inventario alter column DataHora_Inclusao DATETIME
end
else
begin
	alter table inventario add DataHora_Inclusao DATETIME
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('inventario') 
            AND  UPPER(COLUMN_NAME) = UPPER('DataHora_Encerramento'))
begin
	alter table inventario alter column DataHora_Encerramento DATETIME
end
else
begin
	alter table inventario add DataHora_Encerramento DATETIME
end 
go

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF') 
            AND  UPPER(COLUMN_NAME) = UPPER('DataHora_Encerramento'))
begin
	alter table NF alter column DataHora_Encerramento DATETIME
end
else
begin
	alter table NF add DataHora_Encerramento DATETIME
end 
go

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF') 
            AND  UPPER(COLUMN_NAME) = UPPER('DataHora_Lancamento'))
begin
	alter table NF alter column DataHora_Lancamento DATETIME
end
else
begin
	alter table NF add DataHora_Lancamento DATETIME
end 
go

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_br_Acumulado_Geral')
DROP PROCEDURE [sp_br_Acumulado_Geral]
GO

/****** Object:  StoredProcedure [dbo].[sp_br_Acumulado_Geral]    Script Date: 06/11/2022 09:50:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  PROCEDURE [dbo].[sp_br_Acumulado_Geral]

 

AS
                DECLARE @FILIAL VARCHAR(20) = 'MATRIZ'

                DECLARE @PLU VARCHAR(17) 

				DECLARE @DIA int = 90                

	--Salva conteudo atual em uma tabela temp
	Select * into #Acumulado_Geral FROM Acumulado_Geral
	
	--Deleta Conteudo tabela temp
	DELETE FROM #Acumulado_Geral

BEGIN

INSERT INTO

   #Acumulado_Geral

SELECT

	FILIAL = ML.FILIAL,

	PLU = M.PLU,

	EAN = ISNULL((SELECT MAX(EAN.EAN) FROM EAN WHERE EAN.PLU = M.PLU),''),

	DESCRICAO = M.DESCRICAO,

	GRUPO = CONVERT(INT, SUBSTRING(M.CODIGO_DEPARTAMENTO, 1, 3)),

	GRUPO_DESCRICAO = ISNULL((SELECT DESCRICAO_GRUPO FROM GRUPO WHERE GRUPO.CODIGO_GRUPO = CONVERT(INT, SUBSTRING(M.CODIGO_DEPARTAMENTO,1,3))),''),

	SUBGRUPO = SUBSTRING(M.CODIGO_DEPARTAMENTO, 1, 6),

	SUBGRUPO_DESCRICAO = ISNULL((SELECT DESCRICAO_SUBGRUPO FROM SUBGRUPO WHERE SUBGRUPO.CODIGO_SUBGRUPO = SUBSTRING(M.CODIGO_DEPARTAMENTO,1,6)),''),

	DEPARTAMENTO = M.CODIGO_DEPARTAMENTO,

	DEPARTAMENTO_DESCRICAO = ISNULL((SELECT DESCRICAO_DEPARTAMENTO FROM DEPARTAMENTO WHERE DEPARTAMENTO.CODIGO_DEPARTAMENTO = M.CODIGO_DEPARTAMENTO),''),

	CST_ICMS = ISNULL(M.ORIGEM,'0') + ISNULL(T.INDICE_ST,'00'),

	ALIQUOTA_ICMS = ISNULL(T.ICMS_EFETIVO, 0),

	CST_PISCOFINS_ENTRADA = ISNULL(M.CST_ENTRADA, '50'),

	CST_PISCOFINS_SAIDA = ISNULL(M.CST_SAIDA, '01'),

	ALIQUOTA_PIS = CASE WHEN CONVERT(INT, ISNULL(M.CST_ENTRADA, 50)) BETWEEN 50 AND 66 THEN FILIAL.PIS ELSE 0 END,

	ALIQUOTA_COFINS = CASE WHEN CONVERT(INT, ISNULL(M.CST_ENTRADA, 50)) BETWEEN 50 AND 66 THEN FILIAL.COFINS ELSE 0 END,

	PRECO_CUSTO = ML.PRECO_CUSTO,

	PRECO_VENDA = ML.PRECO,

	SALDO_ATUAL = ML.SALDO_ATUAL,

	PEDIDO_PENDENTE = 0,

	CUSTOMES13 = ML.PRECO_CUSTO,

	CUSTOMES12 = ML.PRECO_CUSTO,

	CUSTOMES11 = ML.PRECO_CUSTO,

	CUSTOMES10 = ML.PRECO_CUSTO,

	CUSTOMES09 = ML.PRECO_CUSTO,

	CUSTOMES08 = ML.PRECO_CUSTO,

	CUSTOMES07 = ML.PRECO_CUSTO,

	CUSTOMES06 = ML.PRECO_CUSTO,

	CUSTOMES05 = ML.PRECO_CUSTO,

	CUSTOMES04 = ML.PRECO_CUSTO,

	CUSTOMES03 = ML.PRECO_CUSTO,

	CUSTOMES02 = ML.PRECO_CUSTO,

	CUSTOMES01 = ML.PRECO_CUSTO,

	VQMES13 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -12, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -12, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0 ), 0),

	VQMES12 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -11, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -11, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES11 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -10, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -10, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES10 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -9, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -9, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0    ), 0),

	VQMES09 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -8, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -8, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES08 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -7, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -7, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES07 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -6, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -6, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES06 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -5, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -5, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES05 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -4, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -4, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES04 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -3, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -3, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES03 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -2, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -2, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES02 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -1, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -1, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VQMES01 = ISNULL((SELECT SUM(S.QTDE) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, 0, GETDATE()), 102), 1, 7)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO inner join Natureza_operacao as np on np.Codigo_operacao = N.Codigo_operacao WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, 0, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1 AND I.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' AND np.Saida = 1  and isnull(np.NF_devolucao,0) =0   ), 0),

	VVMES13 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -12, GETDATE()), 102), 1, 7)), 0),

	VVMES12 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -11, GETDATE()), 102), 1, 7)), 0),

	VVMES11 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -10, GETDATE()), 102), 1, 7)), 0),

	VVMES10 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -9, GETDATE()), 102), 1, 7)), 0),

	VVMES09 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -8, GETDATE()), 102), 1, 7)), 0),

	VVMES08 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -7, GETDATE()), 102), 1, 7)), 0),

	VVMES07 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -6, GETDATE()), 102), 1, 7)), 0),

	VVMES06 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -5, GETDATE()), 102), 1, 7)), 0),

	VVMES05 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -4, GETDATE()), 102), 1, 7)), 0),

	VVMES04 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -3, GETDATE()), 102), 1, 7)), 0),

	VVMES03 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -2, GETDATE()), 102), 1, 7)), 0),

	VVMES02 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -1, GETDATE()), 102), 1, 7)), 0),

	VVMES01 = ISNULL((SELECT SUM(S.VLR - ISNULL(DESCONTO, 0)) FROM SAIDA_ESTOQUE S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND SUBSTRING(CONVERT(VARCHAR, S.DATA_MOVIMENTO, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, 0, GETDATE()), 102), 1, 7)), 0),

	EQMES13 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -12, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES12 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -11, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES11 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -10, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES10 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -9, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES09 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -8, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES08 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -7, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES07 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -6, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES06 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -5, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES05 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -4, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES04 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -3, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES03 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -2, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES02 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -1, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EQMES01 = ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, 0, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES13 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -12, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES12 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -11, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES11 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -10, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES10 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -9, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES09 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -8, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES08 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -7, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES07 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -6, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES06 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -5, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES05 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -4, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES04 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -3, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES03 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -2, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES02 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, -1, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	EVMES01 = ISNULL((SELECT SUM(I.TOTAL + ISNULL(I.IVA, 0) + ISNULL(I.IPIV, 0)) FROM NF N WITH (INDEX=IX_NF_01) INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01) ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO WHERE N.FILIAL = ML.FILIAL AND SUBSTRING(CONVERT(VARCHAR, N.DATA, 102), 1, 7) = SUBSTRING(CONVERT(VARCHAR, DATEADD(MONTH, 0, GETDATE()), 102), 1, 7) AND I.PLU = M.PLU AND ISNULL(N.NF_CANC,0) <> 1), 0),

	FLAG = '',

	INICIO = '1900-01-01',

	FIM = '1900-01-01',
	VQDIA01 = 0, 
	VQDIA02 = 0, 
	VQDIA03 = 0, 
	VQDIA04 = 0, 
	VQDIA05 = 0, 
	VQDIA06 = 0, 
	VQDIA07 = 0, 
	VQDIA08 = 0, 
	VQDIA09 = 0, 
	VQDIA10 = 0, 
	VQDIA11 = 0, 
	VQDIA12 = 0, 
	VQDIA13 = 0, 
	VQDIA14 = 0, 
	VQDIA15 = 0, 
	VQDIA16 = 0, 
	VQDIA17 = 0, 
	VQDIA18 = 0, 
	VQDIA19 = 0, 
	VQDIA20 = 0, 
	VQDIA21 = 0, 
	VQDIA22 = 0, 
	VQDIA23 = 0, 
	VQDIA24 = 0, 
	VQDIA25 = 0, 
	VQDIA26 = 0, 
	VQDIA27 = 0, 
	VQDIA28 = 0, 
	VQDIA29 = 0, 
	VQDIA30 = 0, 
	VQDIA31 = 0, 
	VQDIA32 = 0, 
	VQDIA33 = 0, 
	VQDIA34 = 0, 
	VQDIA35 = 0, 
	VQDIA36 = 0, 
	VQDIA37 = 0, 
	VQDIA38 = 0, 
	VQDIA39 = 0, 
	VQDIA40 = 0, 
	VQDIA41 = 0, 
	VQDIA42 = 0, 
	VQDIA43 = 0, 
	VQDIA44 = 0, 
	VQDIA45 = 0, 
	VQDIA46 = 0, 
	VQDIA47 = 0, 
	VQDIA48 = 0, 
	VQDIA49 = 0, 
	VQDIA50 = 0, 
	VQDIA51 = 0, 
	VQDIA52 = 0, 
	VQDIA53 = 0, 
	VQDIA54 = 0, 
	VQDIA55 = 0, 
	VQDIA56 = 0, 
	VQDIA57 = 0, 
	VQDIA58 = 0, 
	VQDIA59 = 0, 
	VQDIA60 = 0, 
	VQDIA61 = 0, 
	VQDIA62 = 0, 
	VQDIA63 = 0, 
	VQDIA64 = 0, 
	VQDIA65 = 0, 
	VQDIA66 = 0, 
	VQDIA67 = 0, 
	VQDIA68 = 0, 
	VQDIA69 = 0, 
	VQDIA70 = 0, 
	VQDIA71 = 0, 
	VQDIA72 = 0, 
	VQDIA73 = 0, 
	VQDIA74 = 0, 
	VQDIA75 = 0, 
	VQDIA76 = 0, 
	VQDIA77 = 0, 
	VQDIA78 = 0, 
	VQDIA79 = 0, 
	VQDIA80 = 0, 
	VQDIA81 = 0, 
	VQDIA82 = 0, 
	VQDIA83 = 0, 
	VQDIA84 = 0, 
	VQDIA85 = 0, 
	VQDIA86 = 0, 
	VQDIA87 = 0, 
	VQDIA88 = 0, 
	VQDIA89 = 0, 
	VQDIA90 = 0, 
	VVDIA01 = 0, 
	VVDIA02 = 0, 
	VVDIA03 = 0, 
	VVDIA04 = 0, 
	VVDIA05 = 0, 
	VVDIA06 = 0, 
	VVDIA07 = 0, 
	VVDIA08 = 0, 
	VVDIA09 = 0, 
	VVDIA10 = 0, 
	VVDIA11 = 0, 
	VVDIA12 = 0, 
	VVDIA13 = 0, 
	VVDIA14 = 0, 
	VVDIA15 = 0, 
	VVDIA16 = 0, 
	VVDIA17 = 0, 
	VVDIA18 = 0, 
	VVDIA19 = 0, 
	VVDIA20 = 0, 
	VVDIA21 = 0, 
	VVDIA22 = 0, 
	VVDIA23 = 0, 
	VVDIA24 = 0, 
	VVDIA25 = 0, 
	VVDIA26 = 0, 
	VVDIA27 = 0, 
	VVDIA28 = 0, 
	VVDIA29 = 0, 
	VVDIA30 = 0, 
	VVDIA31 = 0, 
	VVDIA32 = 0, 
	VVDIA33 = 0, 
	VVDIA34 = 0, 
	VVDIA35 = 0, 
	VVDIA36 = 0, 
	VVDIA37 = 0, 
	VVDIA38 = 0, 
	VVDIA39 = 0, 
	VVDIA40 = 0, 
	VVDIA41 = 0, 
	VVDIA42 = 0, 
	VVDIA43 = 0, 
	VVDIA44 = 0, 
	VVDIA45 = 0, 
	VVDIA46 = 0, 
	VVDIA47 = 0, 
	VVDIA48 = 0, 
	VVDIA49 = 0, 
	VVDIA50 = 0, 
	VVDIA51 = 0, 
	VVDIA52 = 0, 
	VVDIA53 = 0, 
	VVDIA54 = 0, 
	VVDIA55 = 0, 
	VVDIA56 = 0, 
	VVDIA57 = 0, 
	VVDIA58 = 0, 
	VVDIA59 = 0, 
	VVDIA60 = 0, 
	VVDIA61 = 0, 
	VVDIA62 = 0, 
	VVDIA63 = 0, 
	VVDIA64 = 0, 
	VVDIA65 = 0, 
	VVDIA66 = 0, 
	VVDIA67 = 0, 
	VVDIA68 = 0, 
	VVDIA69 = 0, 
	VVDIA70 = 0, 
	VVDIA71 = 0, 
	VVDIA72 = 0, 
	VVDIA73 = 0, 
	VVDIA74 = 0, 
	VVDIA75 = 0, 
	VVDIA76 = 0, 
	VVDIA77 = 0, 
	VVDIA78 = 0, 
	VVDIA79 = 0, 
	VVDIA80 = 0, 
	VVDIA81 = 0, 
	VVDIA82 = 0, 
	VVDIA83 = 0, 
	VVDIA84 = 0, 
	VVDIA85 = 0, 
	VVDIA86 = 0, 
	VVDIA87 = 0, 
	VVDIA88 = 0, 
	VVDIA89 = 0, 
	VVDIA90 = 0, 
	EQDIA90 = 0,
	Integrado = 1 
FROM
   MERCADORIA M

   INNER JOIN MERCADORIA_LOJA ML ON M.PLU = ML.PLU

   INNER JOIN FILIAL ON FILIAL.FILIAL = ML.FILIAL

   LEFT OUTER JOIN TRIBUTACAO T ON M.CODIGO_TRIBUTACAO = T.CODIGO_TRIBUTACAO
WHERE
	M.PLU <> '999999'
And 
	M.Inativo = 0
And 
	M.FILIAL = 'MATRIZ'
	
	
IF (SELECT COUNT(*) FROM #Acumulado_Geral) > 0
BEGIN	
	delete Acumulado_Geral
	
	insert into Acumulado_Geral
	Select * FROM #Acumulado_Geral 							
-------------------******************************************************************************----------------------------

--DROP TABLE #venda
-- Tabela Temp Saida Estoque
SELECT S.* into #venda 
FROM SAIDA_ESTOQUE S  WITH (INDEX=IX_SAIDA_ESTOQUE_01), MERCADORIA_LOJA ML WHERE S.PLU = ML.PLU
AND S.FILIAL = ML.FILIAL  AND S.PLU = ML.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) >= CONVERT(VARCHAR, DATEADD(DAY, -90, GETDATE()), 112) 
AND S.DATA_CANCELAMENTO IS NULL

-- Tabela Temp VendasNF
--drop table #vendaNF
SELECT 
	I.*,N.DATA into #vendaNF
FROM
	NF N WITH (INDEX=IX_NF_01)	INNER JOIN NF_ITEM I WITH (INDEX=IX_NF_ITEM_01)  
								ON N.FILIAL = I.FILIAL AND N.CLIENTE_FORNECEDOR = I.CLIENTE_FORNECEDOR AND N.CODIGO = I.CODIGO 
							INNER JOIN Natureza_operacao as np 
								ON np.Codigo_operacao = N.Codigo_operacao 
							INNER JOIN MERCADORIA_LOJA ML 								
								ON I.PLU = ML.PLU 								
Where N.FILIAL = ML.FILIAL 
AND I.PLU = ML.PLU 
AND ISNULL(N.NF_CANC,0) <> 1 
AND N.Codigo_operacao IN ('5102','5405','5402','5403','6102','6405','6401','6403') AND N.TIPO_NF = 1 AND N.status='AUTORIZADO' 
AND CONVERT(VARCHAR, N.DATA, 112) >= CONVERT(VARCHAR, DATEADD(DAY, -90, GETDATE()), 112) 
AND np.Saida = 1 
AND isnull(np.NF_devolucao,0) = 0

Update 
	Acumulado_Geral
Set
	VQDIA01 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -1, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -1, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA02 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -2, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -2, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA03 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -3, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -3, GETDATE()), 112) AND I.PLU = M.PLU),0),		
	VQDIA04 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -4, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -4, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA05 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -5, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -5, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA06 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -6, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -6, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA07 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -7, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -7, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA08 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -8, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -8, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA09 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -9, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -9, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA10 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -10, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -10, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA11 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -11, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -11, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA12 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -12, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -12, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA13 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -13, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -13, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA14 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -14, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -14, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA15 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -15, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -15, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA16 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -16, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -16, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA17 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -17, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -17, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA18 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -18, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -18, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA19 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -19, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -19, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA20 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -20, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -20, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA21 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -21, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -21, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA22 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -22, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -22, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA23 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -23, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -23, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA24 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -24, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -24, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA25 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -25, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -25, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA26 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -26, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -26, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA27 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -27, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -27, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA28 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -28, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -28, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA29 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -29, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -29, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA30 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -30, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -30, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA31 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -31, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -31, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA32 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -32, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -32, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA33 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -33, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -33, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA34 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -34, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -34, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA35 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -35, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -35, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA36 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -36, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -36, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA37 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -37, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -37, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA38 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -38, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -38, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA39 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -39, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -39, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA40 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -40, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -40, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA41 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -41, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -41, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA42 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -42, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -42, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA43 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -43, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -43, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA44 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -44, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -44, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA45 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -45, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -45, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA46 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -46, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -46, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA47 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -47, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -47, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA48 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -48, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -48, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA49 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -49, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -49, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA50 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -50, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -50, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA51 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -51, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -51, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA52 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -52, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -52, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA53 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -53, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -53, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA54 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -54, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -54, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA55 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -55, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -55, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA56 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -56, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -56, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA57 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -57, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -57, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA58 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -58, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -58, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA59 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -59, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -59, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA60 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -60, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -60, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA61 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -61, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -61, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA62 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -62, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -62, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA63 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -63, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -63, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA64 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -64, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -64, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA65 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -65, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -65, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA66 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -66, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -66, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA67 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -67, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -67, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA68 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -68, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -68, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA69 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -69, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -69, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA70 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -70, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -70, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA71 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -71, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -71, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA72 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -72, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -72, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA73 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -73, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -73, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA74 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -74, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -74, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA75 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -75, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -75, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA76 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -76, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -76, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA77 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -77, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -77, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA78 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -78, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -78, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA79 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -79, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -79, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA80 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -80, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -80, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA81 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -81, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -81, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA82 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -82, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -82, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA83 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -83, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -83, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA84 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -84, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -84, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA85 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -85, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -85, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA86 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -86, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -86, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA87 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -87, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -87, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA88 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -88, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -88, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA89 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -89, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -89, GETDATE()), 112) AND I.PLU = M.PLU),0),	
	VQDIA90 = ISNULL((SELECT SUM(S.QTDE) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = M.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -90, GETDATE()), 112)), 0) + ISNULL((SELECT SUM(I.QTDE * I.EMBALAGEM) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -90, GETDATE()), 112) AND I.PLU = M.PLU),0)	
FROM 
	MERCADORIA M
	INNER JOIN MERCADORIA_LOJA ML ON M.PLU = ML.PLU
	INNER JOIN FILIAL ON FILIAL.FILIAL = ML.FILIAL
WHERE
	ML.Filial = 'MATRIZ'
AND	
	M.PLU <> '999999'
AND 
	Acumulado_Geral.plu = ml.plu	
And
	inativo = 0	


-------------------------------------*****************************************************--------------------------------------------									

SELECT 
	a.PLU,
	VVDIA01 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -1, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -1, GETDATE()), 112)), 0),
	VVDIA02 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -2, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -2, GETDATE()), 112)), 0),
	VVDIA03 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -3, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -3, GETDATE()), 112)), 0),
	VVDIA04 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -4, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -4, GETDATE()), 112)), 0),
	VVDIA05 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -5, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -5, GETDATE()), 112)), 0),
	VVDIA06 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -6, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -6, GETDATE()), 112)), 0),
	VVDIA07 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -7, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -7, GETDATE()), 112)), 0),
	VVDIA08 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -8, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -8, GETDATE()), 112)), 0),
	VVDIA09 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -9, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -9, GETDATE()), 112)), 0),
	VVDIA10 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -10, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -10, GETDATE()), 112)), 0),
	VVDIA11 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -11, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -11, GETDATE()), 112)), 0),
	VVDIA12 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -12, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -12, GETDATE()), 112)), 0),
	VVDIA13 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -13, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -13, GETDATE()), 112)), 0),
	VVDIA14 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -14, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -14, GETDATE()), 112)), 0),
	VVDIA15 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -15, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -15, GETDATE()), 112)), 0),
	VVDIA16 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -16, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -16, GETDATE()), 112)), 0),
	VVDIA17 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -17, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -17, GETDATE()), 112)), 0),
	VVDIA18 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -18, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -18, GETDATE()), 112)), 0),
	VVDIA19 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -19, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -19, GETDATE()), 112)), 0),
	VVDIA20 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -20, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -20, GETDATE()), 112)), 0),
	VVDIA21 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -21, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -21, GETDATE()), 112)), 0),
	VVDIA22 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -22, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -22, GETDATE()), 112)), 0),
	VVDIA23 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -23, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -23, GETDATE()), 112)), 0),
	VVDIA24 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -24, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -24, GETDATE()), 112)), 0),
	VVDIA25 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -25, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -25, GETDATE()), 112)), 0),
	VVDIA26 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -26, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -26, GETDATE()), 112)), 0),
	VVDIA27 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -27, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -27, GETDATE()), 112)), 0),
	VVDIA28 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -28, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -28, GETDATE()), 112)), 0),
	VVDIA29 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -29, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -29, GETDATE()), 112)), 0),
	VVDIA30 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -30, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -30, GETDATE()), 112)), 0),
	VVDIA31 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -31, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -31, GETDATE()), 112)), 0),
	VVDIA32 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -32, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -32, GETDATE()), 112)), 0),
	VVDIA33 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -33, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -33, GETDATE()), 112)), 0),
	VVDIA34 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -34, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -34, GETDATE()), 112)), 0),
	VVDIA35 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -35, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -35, GETDATE()), 112)), 0),
	VVDIA36 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -36, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -36, GETDATE()), 112)), 0),
	VVDIA37 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -37, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -37, GETDATE()), 112)), 0),
	VVDIA38 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -38, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -38, GETDATE()), 112)), 0),
	VVDIA39 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -39, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -39, GETDATE()), 112)), 0),
	VVDIA40 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -40, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -40, GETDATE()), 112)), 0),
	VVDIA41 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -41, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -41, GETDATE()), 112)), 0),
	VVDIA42 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -42, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -42, GETDATE()), 112)), 0),
	VVDIA43 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -43, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -43, GETDATE()), 112)), 0),
	VVDIA44 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -44, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -44, GETDATE()), 112)), 0),
	VVDIA45 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -45, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -45, GETDATE()), 112)), 0),
	VVDIA46 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -46, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -46, GETDATE()), 112)), 0),
	VVDIA47 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -47, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -47, GETDATE()), 112)), 0),
	VVDIA48 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -48, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -48, GETDATE()), 112)), 0),
	VVDIA49 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -49, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -49, GETDATE()), 112)), 0),
	VVDIA50 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -50, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -50, GETDATE()), 112)), 0),
	VVDIA51 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -51, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -51, GETDATE()), 112)), 0),
	VVDIA52 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -52, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -52, GETDATE()), 112)), 0),
	VVDIA53 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -53, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -53, GETDATE()), 112)), 0),
	VVDIA54 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -54, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -54, GETDATE()), 112)), 0),
	VVDIA55 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -55, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -55, GETDATE()), 112)), 0),
	VVDIA56 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -56, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -56, GETDATE()), 112)), 0),
	VVDIA57 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -57, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -57, GETDATE()), 112)), 0),
	VVDIA58 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -58, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -58, GETDATE()), 112)), 0),
	VVDIA59 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -59, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -59, GETDATE()), 112)), 0),
	VVDIA60 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -60, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -60, GETDATE()), 112)), 0),
	VVDIA61 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -61, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -61, GETDATE()), 112)), 0),
	VVDIA62 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -62, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -62, GETDATE()), 112)), 0),
	VVDIA63 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -63, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -63, GETDATE()), 112)), 0),
	VVDIA64 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -64, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -64, GETDATE()), 112)), 0),
	VVDIA65 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -65, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -65, GETDATE()), 112)), 0),
	VVDIA66 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -66, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -66, GETDATE()), 112)), 0),
	VVDIA67 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -67, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -67, GETDATE()), 112)), 0),
	VVDIA68 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -68, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -68, GETDATE()), 112)), 0),
	VVDIA69 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -69, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -69, GETDATE()), 112)), 0),
	VVDIA70 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -70, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -70, GETDATE()), 112)), 0),
	VVDIA71 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -71, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -71, GETDATE()), 112)), 0),
	VVDIA72 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -72, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -72, GETDATE()), 112)), 0),
	VVDIA73 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -73, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -73, GETDATE()), 112)), 0),
	VVDIA74 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -74, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -74, GETDATE()), 112)), 0),
	VVDIA75 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -75, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -75, GETDATE()), 112)), 0),
	VVDIA76 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -76, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -76, GETDATE()), 112)), 0),
	VVDIA77 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -77, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -77, GETDATE()), 112)), 0),
	VVDIA78 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -78, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -78, GETDATE()), 112)), 0),
	VVDIA79 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -79, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -79, GETDATE()), 112)), 0),
	VVDIA80 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -80, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -80, GETDATE()), 112)), 0),
	VVDIA81 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -81, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -81, GETDATE()), 112)), 0),
	VVDIA82 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -82, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -82, GETDATE()), 112)), 0),
	VVDIA83 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -83, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -83, GETDATE()), 112)), 0),
	VVDIA84 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -84, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -84, GETDATE()), 112)), 0),
	VVDIA85 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -85, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -85, GETDATE()), 112)), 0),
	VVDIA86 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -86, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -86, GETDATE()), 112)), 0),
	VVDIA87 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -87, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -87, GETDATE()), 112)), 0),
	VVDIA88 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -88, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -88, GETDATE()), 112)), 0),
	VVDIA89 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -89, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -89, GETDATE()), 112)), 0),
	VVDIA90 = ISNULL((SELECT (Isnull(SUM(S.VLR - ISNULL(DESCONTO,0)),0)+ISNULL((SELECT ISNULL(SUM(I.TOTAL),0) FROM #vendaNF I WHERE I.FILIAL = ML.FILIAL AND CONVERT(VARCHAR, I.DATA, 112) = CONVERT(VARCHAR, DATEADD(DAY, -90, GETDATE()), 112) AND I.PLU = a.PLU),0)) FROM #venda S WHERE S.FILIAL = ML.FILIAL  AND S.PLU = a.PLU AND CONVERT(VARCHAR, S.DATA_MOVIMENTO, 112) = CONVERT(VARCHAR, DATEADD(DAY, -90, GETDATE()), 112)), 0)	
INTO 	
	#VVDIA
FROM 
	 MERCADORIA_LOJA ML INNER JOIN Acumulado_Geral a ON a.plu = ml.plu
WHERE 
	ML.Filial = 'MATRIZ'
And	
	ML.PLU <> '999999'
GROUP BY 
	ml.filial, ml.plu,a.plu

	
UPDATE
	Acumulado_Geral
Set
	VVDIA01= case when (Acumulado_Geral.VQDIA01 > 0 And v.VVDIA01 > 0) then v.VVDIA01/VQDIA01 ELSE 0 END, 
	VVDIA02= case when (Acumulado_Geral.VQDIA02 > 0 And v.VVDIA02 > 0) then v.VVDIA02/VQDIA02 ELSE 0 END, 
	VVDIA03= case when (Acumulado_Geral.VQDIA03 > 0 And v.VVDIA03 > 0) then v.VVDIA03/VQDIA03 ELSE 0 END, 
	VVDIA04= case when (Acumulado_Geral.VQDIA04 > 0 And v.VVDIA04 > 0) then v.VVDIA04/VQDIA04 ELSE 0 END, 
	VVDIA05= case when (Acumulado_Geral.VQDIA05 > 0 And v.VVDIA05 > 0) then v.VVDIA05/VQDIA05 ELSE 0 END, 
	VVDIA06= case when (Acumulado_Geral.VQDIA06 > 0 And v.VVDIA06 > 0) then v.VVDIA06/VQDIA06 ELSE 0 END, 
	VVDIA07= case when (Acumulado_Geral.VQDIA07 > 0 And v.VVDIA07 > 0) then v.VVDIA07/VQDIA07 ELSE 0 END, 
	VVDIA08= case when (Acumulado_Geral.VQDIA08 > 0 And v.VVDIA08 > 0) then v.VVDIA08/VQDIA08 ELSE 0 END, 
	VVDIA09= case when (Acumulado_Geral.VQDIA09 > 0 And v.VVDIA09 > 0) then v.VVDIA09/VQDIA09 ELSE 0 END, 
	VVDIA10= case when (Acumulado_Geral.VQDIA10 > 0 And v.VVDIA10 > 0) then v.VVDIA10/VQDIA10 ELSE 0 END, 
	VVDIA11= case when (Acumulado_Geral.VQDIA11 > 0 And v.VVDIA11 > 0) then v.VVDIA11/VQDIA11 ELSE 0 END, 
	VVDIA12= case when (Acumulado_Geral.VQDIA12 > 0 And v.VVDIA12 > 0) then v.VVDIA12/VQDIA12 ELSE 0 END, 
	VVDIA13= case when (Acumulado_Geral.VQDIA13 > 0 And v.VVDIA13 > 0) then v.VVDIA13/VQDIA13 ELSE 0 END, 
	VVDIA14= case when (Acumulado_Geral.VQDIA14 > 0 And v.VVDIA14 > 0) then v.VVDIA14/VQDIA14 ELSE 0 END, 
	VVDIA15= case when (Acumulado_Geral.VQDIA15 > 0 And v.VVDIA15 > 0) then v.VVDIA15/VQDIA15 ELSE 0 END, 
	VVDIA16= case when (Acumulado_Geral.VQDIA16 > 0 And v.VVDIA16 > 0) then v.VVDIA16/VQDIA16 ELSE 0 END, 
	VVDIA17= case when (Acumulado_Geral.VQDIA17 > 0 And v.VVDIA17 > 0) then v.VVDIA17/VQDIA17 ELSE 0 END, 
	VVDIA18= case when (Acumulado_Geral.VQDIA18 > 0 And v.VVDIA18 > 0) then v.VVDIA18/VQDIA18 ELSE 0 END, 
	VVDIA19= case when (Acumulado_Geral.VQDIA19 > 0 And v.VVDIA19 > 0) then v.VVDIA19/VQDIA19 ELSE 0 END, 
	VVDIA20= case when (Acumulado_Geral.VQDIA20 > 0 And v.VVDIA20 > 0) then v.VVDIA20/VQDIA20 ELSE 0 END, 
	VVDIA21= case when (Acumulado_Geral.VQDIA21 > 0 And v.VVDIA21 > 0) then v.VVDIA21/VQDIA21 ELSE 0 END, 
	VVDIA22= case when (Acumulado_Geral.VQDIA22 > 0 And v.VVDIA22 > 0) then v.VVDIA22/VQDIA22 ELSE 0 END, 
	VVDIA23= case when (Acumulado_Geral.VQDIA23 > 0 And v.VVDIA23 > 0) then v.VVDIA23/VQDIA23 ELSE 0 END, 
	VVDIA24= case when (Acumulado_Geral.VQDIA24 > 0 And v.VVDIA24 > 0) then v.VVDIA24/VQDIA24 ELSE 0 END, 
	VVDIA25= case when (Acumulado_Geral.VQDIA25 > 0 And v.VVDIA25 > 0) then v.VVDIA25/VQDIA25 ELSE 0 END, 
	VVDIA26= case when (Acumulado_Geral.VQDIA26 > 0 And v.VVDIA26 > 0) then v.VVDIA26/VQDIA26 ELSE 0 END, 
	VVDIA27= case when (Acumulado_Geral.VQDIA27 > 0 And v.VVDIA27 > 0) then v.VVDIA27/VQDIA27 ELSE 0 END, 
	VVDIA28= case when (Acumulado_Geral.VQDIA28 > 0 And v.VVDIA28 > 0) then v.VVDIA28/VQDIA28 ELSE 0 END, 
	VVDIA29= case when (Acumulado_Geral.VQDIA29 > 0 And v.VVDIA29 > 0) then v.VVDIA29/VQDIA29 ELSE 0 END, 
	VVDIA30= case when (Acumulado_Geral.VQDIA30 > 0 And v.VVDIA30 > 0) then v.VVDIA30/VQDIA30 ELSE 0 END, 
	VVDIA31= case when (Acumulado_Geral.VQDIA31 > 0 And v.VVDIA31 > 0) then v.VVDIA31/VQDIA31 ELSE 0 END, 
	VVDIA32= case when (Acumulado_Geral.VQDIA32 > 0 And v.VVDIA32 > 0) then v.VVDIA32/VQDIA32 ELSE 0 END, 
	VVDIA33= case when (Acumulado_Geral.VQDIA33 > 0 And v.VVDIA33 > 0) then v.VVDIA33/VQDIA33 ELSE 0 END, 
	VVDIA34= case when (Acumulado_Geral.VQDIA34 > 0 And v.VVDIA34 > 0) then v.VVDIA34/VQDIA34 ELSE 0 END, 
	VVDIA35= case when (Acumulado_Geral.VQDIA35 > 0 And v.VVDIA35 > 0) then v.VVDIA35/VQDIA35 ELSE 0 END, 
	VVDIA36= case when (Acumulado_Geral.VQDIA36 > 0 And v.VVDIA36 > 0) then v.VVDIA36/VQDIA36 ELSE 0 END, 
	VVDIA37= case when (Acumulado_Geral.VQDIA37 > 0 And v.VVDIA37 > 0) then v.VVDIA37/VQDIA37 ELSE 0 END, 
	VVDIA38= case when (Acumulado_Geral.VQDIA38 > 0 And v.VVDIA38 > 0) then v.VVDIA38/VQDIA38 ELSE 0 END, 
	VVDIA39= case when (Acumulado_Geral.VQDIA39 > 0 And v.VVDIA39 > 0) then v.VVDIA39/VQDIA39 ELSE 0 END, 
	VVDIA40= case when (Acumulado_Geral.VQDIA40 > 0 And v.VVDIA40 > 0) then v.VVDIA40/VQDIA40 ELSE 0 END, 
	VVDIA41= case when (Acumulado_Geral.VQDIA41 > 0 And v.VVDIA41 > 0) then v.VVDIA41/VQDIA41 ELSE 0 END, 
	VVDIA42= case when (Acumulado_Geral.VQDIA42 > 0 And v.VVDIA42 > 0) then v.VVDIA42/VQDIA42 ELSE 0 END, 
	VVDIA43= case when (Acumulado_Geral.VQDIA43 > 0 And v.VVDIA43 > 0) then v.VVDIA43/VQDIA43 ELSE 0 END, 
	VVDIA44= case when (Acumulado_Geral.VQDIA44 > 0 And v.VVDIA44 > 0) then v.VVDIA44/VQDIA44 ELSE 0 END, 
	VVDIA45= case when (Acumulado_Geral.VQDIA45 > 0 And v.VVDIA45 > 0) then v.VVDIA45/VQDIA45 ELSE 0 END, 
	VVDIA46= case when (Acumulado_Geral.VQDIA46 > 0 And v.VVDIA46 > 0) then v.VVDIA46/VQDIA46 ELSE 0 END, 
	VVDIA47= case when (Acumulado_Geral.VQDIA47 > 0 And v.VVDIA47 > 0) then v.VVDIA47/VQDIA47 ELSE 0 END, 
	VVDIA48= case when (Acumulado_Geral.VQDIA48 > 0 And v.VVDIA48 > 0) then v.VVDIA48/VQDIA48 ELSE 0 END, 
	VVDIA49= case when (Acumulado_Geral.VQDIA49 > 0 And v.VVDIA49 > 0) then v.VVDIA49/VQDIA49 ELSE 0 END, 
	VVDIA50= case when (Acumulado_Geral.VQDIA50 > 0 And v.VVDIA50 > 0) then v.VVDIA50/VQDIA50 ELSE 0 END, 
	VVDIA51= case when (Acumulado_Geral.VQDIA51 > 0 And v.VVDIA51 > 0) then v.VVDIA51/VQDIA51 ELSE 0 END, 
	VVDIA52= case when (Acumulado_Geral.VQDIA52 > 0 And v.VVDIA52 > 0) then v.VVDIA52/VQDIA52 ELSE 0 END, 
	VVDIA53= case when (Acumulado_Geral.VQDIA53 > 0 And v.VVDIA53 > 0) then v.VVDIA53/VQDIA53 ELSE 0 END, 
	VVDIA54= case when (Acumulado_Geral.VQDIA54 > 0 And v.VVDIA54 > 0) then v.VVDIA54/VQDIA54 ELSE 0 END, 
	VVDIA55= case when (Acumulado_Geral.VQDIA55 > 0 And v.VVDIA55 > 0) then v.VVDIA55/VQDIA55 ELSE 0 END, 
	VVDIA56= case when (Acumulado_Geral.VQDIA56 > 0 And v.VVDIA56 > 0) then v.VVDIA56/VQDIA56 ELSE 0 END, 
	VVDIA57= case when (Acumulado_Geral.VQDIA57 > 0 And v.VVDIA57 > 0) then v.VVDIA57/VQDIA57 ELSE 0 END, 
	VVDIA58= case when (Acumulado_Geral.VQDIA58 > 0 And v.VVDIA58 > 0) then v.VVDIA58/VQDIA58 ELSE 0 END, 
	VVDIA59= case when (Acumulado_Geral.VQDIA59 > 0 And v.VVDIA59 > 0) then v.VVDIA59/VQDIA59 ELSE 0 END, 
	VVDIA60= case when (Acumulado_Geral.VQDIA60 > 0 And v.VVDIA60 > 0) then v.VVDIA60/VQDIA60 ELSE 0 END, 
	VVDIA61= case when (Acumulado_Geral.VQDIA61 > 0 And v.VVDIA61 > 0) then v.VVDIA61/VQDIA61 ELSE 0 END, 
	VVDIA62= case when (Acumulado_Geral.VQDIA62 > 0 And v.VVDIA62 > 0) then v.VVDIA62/VQDIA62 ELSE 0 END, 
	VVDIA63= case when (Acumulado_Geral.VQDIA63 > 0 And v.VVDIA63 > 0) then v.VVDIA63/VQDIA63 ELSE 0 END, 
	VVDIA64= case when (Acumulado_Geral.VQDIA64 > 0 And v.VVDIA64 > 0) then v.VVDIA64/VQDIA64 ELSE 0 END, 
	VVDIA65= case when (Acumulado_Geral.VQDIA65 > 0 And v.VVDIA65 > 0) then v.VVDIA65/VQDIA65 ELSE 0 END, 
	VVDIA66= case when (Acumulado_Geral.VQDIA66 > 0 And v.VVDIA66 > 0) then v.VVDIA66/VQDIA66 ELSE 0 END, 
	VVDIA67= case when (Acumulado_Geral.VQDIA67 > 0 And v.VVDIA67 > 0) then v.VVDIA67/VQDIA67 ELSE 0 END, 
	VVDIA68= case when (Acumulado_Geral.VQDIA68 > 0 And v.VVDIA68 > 0) then v.VVDIA68/VQDIA68 ELSE 0 END, 
	VVDIA69= case when (Acumulado_Geral.VQDIA69 > 0 And v.VVDIA69 > 0) then v.VVDIA69/VQDIA69 ELSE 0 END, 
	VVDIA70= case when (Acumulado_Geral.VQDIA70 > 0 And v.VVDIA70 > 0) then v.VVDIA70/VQDIA70 ELSE 0 END, 
	VVDIA71= case when (Acumulado_Geral.VQDIA71 > 0 And v.VVDIA71 > 0) then v.VVDIA71/VQDIA71 ELSE 0 END, 
	VVDIA72= case when (Acumulado_Geral.VQDIA72 > 0 And v.VVDIA72 > 0) then v.VVDIA72/VQDIA72 ELSE 0 END, 
	VVDIA73= case when (Acumulado_Geral.VQDIA73 > 0 And v.VVDIA73 > 0) then v.VVDIA73/VQDIA73 ELSE 0 END, 
	VVDIA74= case when (Acumulado_Geral.VQDIA74 > 0 And v.VVDIA74 > 0) then v.VVDIA74/VQDIA74 ELSE 0 END, 
	VVDIA75= case when (Acumulado_Geral.VQDIA75 > 0 And v.VVDIA75 > 0) then v.VVDIA75/VQDIA75 ELSE 0 END, 
	VVDIA76= case when (Acumulado_Geral.VQDIA76 > 0 And v.VVDIA76 > 0) then v.VVDIA76/VQDIA76 ELSE 0 END, 
	VVDIA77= case when (Acumulado_Geral.VQDIA77 > 0 And v.VVDIA77 > 0) then v.VVDIA77/VQDIA77 ELSE 0 END, 
	VVDIA78= case when (Acumulado_Geral.VQDIA78 > 0 And v.VVDIA78 > 0) then v.VVDIA78/VQDIA78 ELSE 0 END, 
	VVDIA79= case when (Acumulado_Geral.VQDIA79 > 0 And v.VVDIA79 > 0) then v.VVDIA79/VQDIA79 ELSE 0 END, 
	VVDIA80= case when (Acumulado_Geral.VQDIA80 > 0 And v.VVDIA80 > 0) then v.VVDIA80/VQDIA80 ELSE 0 END, 
	VVDIA81= case when (Acumulado_Geral.VQDIA81 > 0 And v.VVDIA81 > 0) then v.VVDIA81/VQDIA81 ELSE 0 END, 
	VVDIA82= case when (Acumulado_Geral.VQDIA82 > 0 And v.VVDIA82 > 0) then v.VVDIA82/VQDIA82 ELSE 0 END, 
	VVDIA83= case when (Acumulado_Geral.VQDIA83 > 0 And v.VVDIA83 > 0) then v.VVDIA83/VQDIA83 ELSE 0 END, 
	VVDIA84= case when (Acumulado_Geral.VQDIA84 > 0 And v.VVDIA84 > 0) then v.VVDIA84/VQDIA84 ELSE 0 END, 
	VVDIA85= case when (Acumulado_Geral.VQDIA85 > 0 And v.VVDIA85 > 0) then v.VVDIA85/VQDIA85 ELSE 0 END, 
	VVDIA86= case when (Acumulado_Geral.VQDIA86 > 0 And v.VVDIA86 > 0) then v.VVDIA86/VQDIA86 ELSE 0 END, 
	VVDIA87= case when (Acumulado_Geral.VQDIA87 > 0 And v.VVDIA87 > 0) then v.VVDIA87/VQDIA87 ELSE 0 END, 
	VVDIA88= case when (Acumulado_Geral.VQDIA88 > 0 And v.VVDIA88 > 0) then v.VVDIA88/VQDIA88 ELSE 0 END, 
	VVDIA89= case when (Acumulado_Geral.VQDIA89 > 0 And v.VVDIA89 > 0) then v.VVDIA89/VQDIA89 ELSE 0 END, 
	VVDIA90= case when (Acumulado_Geral.VQDIA90 > 0 And v.VVDIA90 > 0) then v.VVDIA90/VQDIA90 ELSE 0 END
FROM 
	#VVDIA v
WHERE
	v.plu = Acumulado_Geral.plu

	
--- Calculo Estoque 90 Dias

SELECT 
	M.PLU,
	M.SALDO_ATUAL,
	SaidaPDV = isnull((Select Sum(s.Qtde) From saida_estoque s with (index=ix_saida_estoque) inner join mercadoria_loja l on s.plu = l.plu
						Where s.Filial = M.FILIAL 
						and convert(varchar,s.Data_movimento,112) between CONVERT(VARCHAR, DATEADD(DAY, -@Dia, GETDATE()), 112) And convert(varchar,GETDATE(),112)						
						And s.data_cancelamento is null
						And S.PLU = M.PLU), 0),
	SaidaNF = isnull((Select Sum( ((i.qtde * i.embalagem)  )  )
						From nf Inner Join Natureza_operacao n on n.codigo_operacao = nf.Codigo_operacao 
								Inner Join nf_item i on nf.Cliente_Fornecedor = i.Cliente_Fornecedor 
								And nf.Tipo_NF = i.Tipo_NF 
								And nf.codigo = i.codigo 
						Where isnull(nf.nf_canc,0) <> 1
						And nf.tipo_nf = 1
						And n.baixa_estoque = 1
						and convert(varchar,nf.Data,112) between CONVERT(VARCHAR, DATEADD(DAY, -@Dia, GETDATE()), 112) And convert(varchar,GETDATE(),112)												
						And NF.FIlial = M.FILIAL
						And i.PLU = m.plu), 0),
	OutrasSaidas = Isnull((
			(select Isnull(SUM(Contada),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO'
			and convert(varchar,v.Data,112) between CONVERT(VARCHAR, DATEADD(DAY, -@Dia, GETDATE()), 112) And convert(varchar,GETDATE(),112)															
			and i.PLU = m.plu
			And i.Filial = M.FILIAL
			and exists(select * from Tipo_movimentacao t where t.Movimentacao = v.tipoMovimentacao and t.saida = 1)) 
		),0),								
	OutrasEntradas = Isnull((
			(select Isnull(SUM(Contada),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO'
			and convert(varchar,v.Data,112) between CONVERT(VARCHAR, DATEADD(DAY, -@Dia, GETDATE()), 112) And convert(varchar,GETDATE(),112)															
			and i.PLU = m.plu
			And i.Filial = M.FILIAL
			and exists(select * from Tipo_movimentacao t where t.Movimentacao = v.tipoMovimentacao and t.saida = 0)) 
		),0),						
	EntradaNF = isnull((Select Sum( ((i.qtde * i.embalagem)  )  )
						From nf Inner Join Natureza_operacao n on n.codigo_operacao = nf.Codigo_operacao 
								Inner Join nf_item i on nf.Cliente_Fornecedor = i.Cliente_Fornecedor 
								And nf.Tipo_NF = i.Tipo_NF 
								And nf.codigo = i.codigo 
						Where isnull(nf.nf_canc,0) <> 1
						And nf.tipo_nf = 2
						And n.baixa_estoque = 1
						and convert(varchar,nf.Data,112) between CONVERT(VARCHAR, DATEADD(DAY, -@Dia, GETDATE()), 112) And convert(varchar,GETDATE(),112)																		
						And NF.Filial = M.FILIAL
						And i.PLU = m.plu), 0),
	DivInv = Isnull((
			(select Isnull(SUM((i.Contada-i.Saldo_Atual)),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO' and v.tipoMovimentacao  = 'INVENTARIO'
			and convert(varchar,v.Data,112) between CONVERT(VARCHAR, DATEADD(DAY, -@Dia, GETDATE()), 112) And convert(varchar,GETDATE(),112)															
			and i.PLU = m.plu)),0),
	EQDIA90 = 0					
into #ColunasEstoque90Dias
From 
	Mercadoria_loja m
Where
	m.Filial = 'MATRIZ'	

--faz o calculo E SETA A COLUNA EQDIA90
Update #ColunasEstoque90Dias set EQDIA90 = (Isnull(saldo_atual,0) + Isnull(OutrasSaidas,0) + Isnull(SaidaPDV,0) + Isnull(SaidaNF,0) - Isnull(EntradaNF,0) - Isnull(OutrasEntradas,0)+(Isnull(DivInv,0)*-1) )	

--Altera na tabela Acumulado_Geral
Update 
	Acumulado_Geral 
Set 
	Acumulado_Geral.EQDIA90 = e.EQDIA90
From
	#ColunasEstoque90Dias e 
Where
	e.plu = Acumulado_Geral.Plu
	
	
END	

END
                           
go
IF OBJECT_ID('utg_Atualiza_Status', 'TR') IS NOT NULL
	DROP TRIGGER utg_Atualiza_Status
GO
CREATE TRIGGER utg_Atualiza_Status ON NF
AFTER UPDATE
AS
IF UPDATE(Status)
	BEGIN
		UPDATE NF 
		SET Integrado = 0 
		FROM DELETED D
		INNER JOIN NF ON NF.Filial = D.Filial AND NF.Cliente_Fornecedor = D.Cliente_Fornecedor AND NF.Codigo = D.Codigo AND NF.serie = D.serie
	END
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Rel_Fin_FluxoCaixa')
DROP PROCEDURE [sp_Rel_Fin_FluxoCaixa]
GO

/****** Object:  StoredProcedure [dbo].[sp_Rel_Fin_FluxoCaixa]    Script Date: 16/06/2022 15:55:27 ******/

--PROCEDURES =======================================================================================

-- exec sp_Rel_Fin_FluxoCaixa 'MATRIZ','20220621','20220621', 'TODOS'
create  PROCEDURE [dbo].[sp_Rel_Fin_FluxoCaixa] 
		@FILIAL 	AS VARCHAR(17),
		@DataDe		As Varchar(8),
		@DataAte	As Varchar(8),
		@PDV		AS varchar(5) = ''
AS


if (OBJECT_ID('tempdb..##saidaEstoque02')) > 0
	drop table ##saidaEstoque02

if (OBJECT_ID('tempdb..##listaFinalizadora02')) > 0
	drop table ##listaFinalizadora02

IF @PDV = 'TODOS'
	SET @PDV = ''

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[Totais]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)

Begin

Drop table Totais

End
	
	Create table Totais
(
	Descricao  varchar(400),
	Total	 Decimal(18,2)
);
	

	--******
	--** Criando tabelas temporarias registros 
	--******
	
	
	SELECT * INTO ##saidaEstoque02 FROM saida_Estoque WITH(INDEX(IX_Saida_Estoque)) where Filial  = @Filial And Data_Movimento BETWEEN @DataDe AND @DataAte AND (LEN(@PDV) = 0 OR CAIXA_SAIDA = @PDV)

	CREATE NONCLUSTERED INDEX IX_202206151213 ON ##saidaEstoque02 (Filial, Data_Movimento)

	SELECT * INTO ##listaFinalizadora02 FROM Lista_Finalizadora WITH (INDEX=IX_Lista_Finalizadora_ResumoPorDia) WHERE
	Filial  = @Filial And
		Emissao BETWEEN @DataDe AND @DataAte 

	--****

	
	select count(*) as Qtde into #cupons from ##SaidaEstoque02 WITH (INDEX=IX_202206151213) where 
		Filial  = @Filial And
		Data_Movimento BETWEEN @DataDe AND @DataAte AND 
		Data_Cancelamento IS NULL
	group by documento, filial, caixa_saida
	
	insert into #cupons 
	select COUNT(*) from nf where nf.codigo_operacao in ('5102','5405','5402','5403','6102','6405','6401','6403') and nf.Tipo_NF=1 and nf.Emissao between @dataDe and @DataAte AND nf.Filial = @FILIAL and nf.status='AUTORIZADO'
	group by Codigo
	
	insert into #cupons
	select COUNT(*) from pedido where Tipo=1 and  pedido_simples=1 and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte  and pedido.Status <>3
	GROUP by pedido
	

	----# Insere Todo Faturamento em uma tabela temp (Para fazer calculo) #------
	Insert into Totais
	SELECT 'TOTAL FATURAMENTO (1+2+3)' AS Descricao,CONVERT(VARCHAR,
					Isnull((SELECT SUM(convert(decimal(18,2), (VLR-isnull(desconto,0)))) FROM ##SaidaEstoque02 WITH (INDEX=IX_202206151213) WHERE Filial = @FILIAL and  Data_Movimento BETWEEN @DataDe AND @DataAte AND Data_Cancelamento IS NULL 
					),0)
					+Isnull((SELECT Total = convert(decimal(10,2),sum(nf_item.Total) + SUM(nf.frete) - Sum(isnull(convert(decimal(10,2),nf_item.desconto*nf_item.Total)/100,0))) from nf_item inner join nf on nf_item.codigo= nf.Codigo AND nf_item.Filial = nf.FILIAL where  nf_item.codigo_operacao in ('5102','5405','5402','5403','6102','6405','6401','6403') and nf_item.Tipo_NF=1 and nf.Emissao between @dataDe and @DataAte AND nf_item.Filial = @FILIAL AND ISNULL(NF.nf_Canc,0)=0 and nf.status='AUTORIZADO' ),0) 
					+Isnull((SELECT Sum(isnull(Total,0)) from pedido where Tipo=1 AND STATUS = 2 and  pedido_simples=1  and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte),0)
					)  Total

	----# Insere Todas VENDAS CANCELADAS do PDV em uma tabela temp (Para fazer calculo) #------					
	INSERT into Totais
	SELECT 'ITENS CANCELADOS NO CUPOM', CONVERT(VARCHAR,ISNULL((SELECT SUM(VLR-isnull(desconto,0)) 
																	FROM ##SaidaEstoque02 WITH (INDEX=IX_202206151213) 
																	WHERE  FILIAL = @FILIAL 
																	   and Data_Movimento BETWEEN @DataDe AND @DataAte  
																	   AND Data_Cancelamento IS NOT NULL
																	   AND ISNULL(cupom_cancelado,0)=0 ),0))  
	INSERT into Totais
	SELECT 'CUPONS CANCELADOS FINALIZADOS', CONVERT(VARCHAR,ISNULL((SELECT SUM(s.VLR-isnull(s.desconto,0)) 
																	FROM ##SaidaEstoque02 S WITH (INDEX=IX_202206151213)  Inner Join ##listaFinalizadora02 l
																			On s.Documento = l.Cupom AND s.Filial = l.Filial AND s.Data_Movimento = l.Emissao AND s.Caixa_Saida = l.Pdv
																	WHERE  s.FILIAL = @FILIAL 
																	   AND s.Data_Movimento BETWEEN @DataDe AND @DataAte  
																	   AND s.Data_Cancelamento IS NOT NULL
																	   AND ISNULL(s.cupom_cancelado,0)=1 ),0))  				
	INSERT into Totais
	SELECT 'CUPONS CANCELADOS NAO FINALIZADOS', CONVERT(VARCHAR,ISNULL((SELECT SUM(SE.VLR-isnull(SE.desconto,0)) 
																	FROM ##SaidaEstoque02 SE WITH (INDEX=IX_202206151213) 
																	WHERE  FILIAL = @FILIAL 
																	   AND Data_Movimento BETWEEN @DataDe AND @DataAte  
																	   AND Data_Cancelamento IS NOT NULL
																	   AND 	not exists(select * from ##listaFinalizadora02 l 
																		Where l.documento = se.documento and l.Emissao = se.data_movimento
																			And l.pdv = se.caixa_saida
																			And l.filial = se.Filial)
																	   ),0))  

	----# Insere Todos ITENS CANCELADOS PEDIDO do PDV em uma tabela temp (Para fazer calculo) #------					
	INSERT into Totais
	SELECT 'ITENS CANCELADOS PEDIDO', CONVERt(VARCHAR,ISNULL(Sum(isnull(Total,0)),0)) from pedido with(index(ix_pedido_fluxo_caixa)) where Tipo=1 and  pedido_simples=1 and pedido.Data_cadastro between @dataDe and @DataAte And Pedido.Status in (3)

	----# Insere Todos ITENS CANCELADOS PEDIDO do PDV em uma tabela temp (Para fazer calculo) #------					
	INSERT into Totais
	SELECT 'AJUSTE DEVOLUCAO', isnull(CONVERt(VARCHAR,Convert(Decimal(18,2),Sum(isnull(Contada*Custo,0)))),0) from Inventario_itens itens inner join Inventario i on i.Codigo_inventario =  itens.Codigo_inventario 
		where Data BETWEEN @DataDe AND @DataAte  and status = 'ENCERRADO' And tipoMovimentacao = 'DEVOLUCAO'		
	
	----# Insere Todos ITENS CANCELADOS PEDIDO do PDV em uma tabela temp (Para fazer calculo) #------					
	INSERT into Totais
	SELECT 'NF DEVOLUCAO', CONVERt(VARCHAR,ISNULL(Sum(isnull(convert(decimal(10,2),nf.Total),0)),0)) from nf Where nf.codigo_operacao in ('1202', '5202', '5411', '6202') and nf.Tipo_NF=2 and Isnull(nf.nf_Canc,0) = 0 and nf.Emissao between @dataDe and @DataAte		
		






	SELECT '' As Descritivo,'' As Total
	UNION ALL
	SELECT 'VENDAS PEDIDOS SIMPLIFICADOS', replace(CONVERt(VARCHAR,Sum(convert(decimal(18,2),isnull(Total,0),0))),'.',',') from pedido with(index(ix_pedido_fluxo_caixa)) where Tipo=1 and  pedido_simples=1 and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte and pedido.Status <>3 
	--UNION ALL
	--SELECT 'VENDAS PEDIDOS (Delivery Transito)', replace(CONVERt(VARCHAR,Sum(convert(decimal(18,2),isnull(Total,0),0))),'.',',') from pedido with(index(ix_pedido_fluxo_caixa)) where Tipo=1 and  pedido_simples=1 and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte and pedido.Status = 5		
	--UNION ALL
	--SELECT 'VENDAS PEDIDOS (Delivery Pendente Entrega)', replace(CONVERt(VARCHAR,Sum(convert(decimal(18,2),isnull(Total,0),0))),'.',',') from pedido with(index(ix_pedido_fluxo_caixa)) where Tipo=1 and  pedido_simples=1 and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte and pedido.Status = 4			
	UNION ALL
	SELECT 'VENDAS PEDIDOS (Delivery Transf Comanda)', replace(CONVERt(VARCHAR,Sum(convert(decimal(18,2),isnull(Total,0),0))),'.',',') from pedido with(index(ix_pedido_fluxo_caixa)) where Tipo=1 and  pedido_simples=1 and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte and pedido.Status = 6
	UNION ALL
	SELECT 'VENDAS PEDIDOS (Cobrado Delivery) - (1)', replace(CONVERt(VARCHAR,Sum(convert(decimal(18,2),isnull(Total,0),0))),'.',',') from pedido with(index(ix_pedido_fluxo_caixa)) where Tipo=1 and  pedido_simples=1 and convert(varchar,pedido.Data_cadastro,112) between @dataDe and @DataAte and pedido.Status = 2
	UNION ALL
	SELECT 'VENDAS NOTA FISCAL - (2)', replace(CONVERt(VARCHAR,ISNULL(Sum(isnull(convert(decimal(18,2),nf_item.Total),0) + Isnull(NF.Frete,0) -(isnull(NF_Item.Total,0)*isnull(nf_item.desconto,0)/100)),0)),'.',',') from nf_item inner join nf on nf_item.codigo= nf.Codigo  AND nf_item.Filial = nf.FILIAL where nf_item.codigo_operacao in ('5102','5405','5402','5403','6102','6405','6401','6403') and nf_item.Tipo_NF=1 and nf.Emissao between @dataDe and @DataAte AND nf_item.Filial = @FILIAL and nf.status='AUTORIZADO'
	UNION ALL
	SELECT 'VENDAS CUPOM - (3)',replace(CONVERT(VARCHAR,ISNULL((SELECT SUM(convert(decimal(18,2), (VLR-isnull(desconto,0)))) FROM ##SaidaEstoque02 WITH (INDEX=IX_202206151213) WHERE FILIAL = @FILIAL and Data_Movimento BETWEEN @DataDe AND @DataAte AND Data_Cancelamento IS NULL 
			AND Filial = @FILIAL),0)),'.',',')
	UNION ALL
	SELECT '|-SUB-|'+Descricao, replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'TOTAL FATURAMENTO (1+2+3)'
					 
	UNION ALL
				
		SELECT '',''
	UNION ALL
	SELECT 'NUMERO DE CLIENTES', Convert(varchar, (select count(*) from #Cupons))		
	UNION ALL
	SELECT 'VENDAS COM NFP', REPLACE( CONVERT(VARCHAR,convert(numeric(18,2),(Select sum(isnull(vlr-isnull(desconto,0),0)) from ##SaidaEstoque02 WITH (INDEX=IX_202206151213) where Filial = @filial and data_movimento between @DataDe and @DataAte and data_cancelamento is null  and len(isnull(cpf_cnpj,''))>10))),'.',',')
	UNION ALL
	SELECT 'PORC DE VENDAS COM NFP',replace(CONVERT(VARCHAR,convert(numeric(18,2),(Select sum(isnull(vlr-isnull(desconto,0),0)) from ##SaidaEstoque02 WITH (INDEX=IX_202206151213) where filial = @filial and data_movimento between @DataDe and @DataAte and data_cancelamento is null  and len(isnull(cpf_cnpj,''))>10) / (Select sum(isnull(vlr-isnull(desconto,0),0)) from saida_estoque where data_movimento between @DataDe and @DataAte and data_cancelamento is null)*100)),'.',',')
	UNION ALL
	--SELECT 'QTDE ITENS VENDIDOS',REPLACE( CONVERT(VARCHAR,CONVERt(Int,ISNULL((SELECT SUM(QTDE) FROM ##SaidaEstoque02 WITH (INDEX=IX_202206151213) WHERE  Filial = @FILIAL and Data_Movimento BETWEEN @DataDe AND @DataAte AND Data_Cancelamento IS NULL ),0))),'.',',')
	--UNION ALL
	SELECT '',''
	
	UNION ALL
	SELECT 'QTDE ITENS CANCELADOS VENDA', replace(CONVERT(VARCHAR,ISNULL(convert(Numeric(18),(SELECT SUM(QTDE) FROM ##SaidaEstoque02 WITH (INDEX=IX_202206151213) WHERE  Filial = @FILIAL and Data_Movimento BETWEEN @DataDe AND @DataAte AND Data_Cancelamento IS NOT NULL )),0)),'.',',')	
	UNION ALL
	
	SELECT Descricao,replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'ITENS CANCELADOS NO CUPOM'
	UNION ALL
	SELECT Descricao,replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'CUPONS CANCELADOS FINALIZADOS'
	UNION ALL
	SELECT Descricao,replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'CUPONS CANCELADOS NAO FINALIZADOS'
	UNION ALL
	SELECT '',''
	UNION ALL
	SELECT Descricao, replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'ITENS CANCELADOS PEDIDO'
	UNION ALL
	SELECT Descricao, replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'AJUSTE DEVOLUCAO'
	UNION ALL
	SELECT Descricao, replace(CONVERT(VARCHAR(90),Total),'.',',') From Totais Where Descricao = 'NF DEVOLUCAO'

	--UNION ALL
	
	--SELECT 'RESULTADO TOTAL',
	--	replace(CONVERT(VARCHAR(90),Convert(Decimal(18,2),SUM(Total) - (Select SUM(Total) From TOTAIS  Where Descricao = 'VENDAS CANCELADAS') - (Select SUM(Total) From TOTAIS  Where Descricao = 'ITENS CANCELADOS PEDIDO') - (Select SUM(Total) From TOTAIS  Where Descricao = 'AJUSTE DEVOLUCAO') - (Select Sum(Total) From TOTAIS Where Descricao = 'NF DEVOLUCAO'))),'.',',')
	--FROM  TOTAIS
	--Where Descricao = 'TOTAL FATURAMENTO'

	UNION ALL
	SELECT '',''
	UNION ALL
	SELECT 'DESCONTOS',REPLACE( CONVERT(VARCHAR,convert(numeric(18,2),(Select sum(isnull(desconto,0)) from ##SaidaEstoque02 WITH (INDEX=IX_202206151213) where data_movimento between @DataDe and @DataAte and data_cancelamento is null and filial = @filial))),'.',',')
	UNION ALL
	SELECT 'ACRESCIMOS SERVICOS',REPLACE( CONVERT(VARCHAR,convert(numeric(18,2),(Select sum(isnull(Acrescimo,0)) from ##SaidaEstoque02 WITH (INDEX=IX_202206151213) where filial = @filial and  data_movimento between @DataDe and @DataAte and data_cancelamento is null ))),'.',',')
	UNION ALL
	SELECT 'INDUSTRIA', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'CONTRAVALES EMITIDOS', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'CONTRAVALES RECEBIDOS', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'CONTRAVALES DIGITAIS EMITIDOS', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'CONTRAVALES DIGITAIS RECEBIDOS', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'PAGAMENTO EM CONTA ASSINADA', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'DEPOSITO EM CONTA ASSINADA', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT 'ESTORNO DE DEPOSITO EM CONTA ASSINADA', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
    SELECT 'GERENCIAL ',replace(CONVERT(VARCHAR,ISNULL((SELECT SUM(convert(decimal(18,2), (VLR-isnull(desconto,0)))) FROM ##SaidaEstoque02 WITH (INDEX=IX_202206151213) WHERE Filial = @FILIAL AND Data_Movimento BETWEEN @DataDe AND @DataAte AND Data_Cancelamento IS NULL AND CONVERT(NUMERIC, ISNULL(COO,0)) <= 0 ),0)),'.',',')
	UNION ALL
	SELECT 'REPIQUE', CONVERT(VARCHAR,0) + ',00'
	UNION ALL
	SELECT '',''
	UNION ALL
	
	SELECT 'Forma de Pagamento |-SUB-|','Valor Total'
	UNION ALL
	SELECT FINALIZADORA.FINALIZADORA,replace(CONVERt(VARCHAR,SUM(TOTAL)),'.',',')
		FROM LISTA_FINALIZADORA  WITH(INDEX(ix_Lista_Fluxo_Caixa))
		INNER JOIN FINALIZADORA ON LISTA_FINALIZADORA.FINALIZADORA = FINALIZADORA.NRO_FINALIZADORA
		WHERE EMISSAO between @dataDe and @DataAte and isnull(Cancelado,0) = 0 and Lista_finalizadora.filial  = @FILIAL
		and (LEN(@PDV) = 0 OR Lista_Finalizadora.pdv = @PDV) 
		GROUP BY FINALIZADORA.FINALIZADORA
	UNION ALL	
	SELECT 'Valor Total',replace(CONVERt(VARCHAR,SUM(ISNULL(TOTAL,0))),'.',',')
		FROM LISTA_FINALIZADORA WITH(INDEX(ix_Lista_Fluxo_Caixa))
		INNER JOIN FINALIZADORA ON LISTA_FINALIZADORA.FINALIZADORA = FINALIZADORA.NRO_FINALIZADORA
		WHERE EMISSAO  between @datade and @DataAte and isnull(Cancelado,0) = 0 and Lista_finalizadora.filial  = @FILIAL 
		and (LEN(@PDV) = 0 OR lista_Finalizadora.pdv = @PDV) 
	UNION ALL
	SELECT '',''
	  
GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Rel_Cliente_nf')
DROP PROCEDURE [sp_Rel_Cliente_nf]
GO

GO
/****** Object:  StoredProcedure [dbo].[sp_Rel_Cliente_nf]    Script Date: 06/10/2022 10:12:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[sp_Rel_Cliente_nf] 
		@FILIAL 	AS VARCHAR(17),
		@DataDe		As Varchar(8),
		@DataAte	As Varchar(8),
		@ID	    As int = 0,
		@cnpj       as Varchar(20),
		@tipo       as varchar(20)
		
		as
BEGIN
	-- exec [sp_Rel_Cliente_nf] 'MATRIZ','20210201','20220228','', '',''
	
	IF(LEN(@CNPJ)>0)
	BEGIN 
		SET @CNPJ = LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(@CNPJ,'.',''),'/',''),'-','')))
	END 
	
	if (OBJECT_ID('tempdb..##tempVendaNF') is not null)
		drop table ##tempVendaNF

	if @ID > 0
		BEGIN
			Select 
					Emissao,
					nf.Cliente_Fornecedor Cod,
					cliente.Nome_Cliente,
					cliente.nome_fantasia,
					ISNULL(cg.Grupo, '') AS Grupo,
					Total = Convert(decimal(15,2),Sum(NF_Item.Total+Isnull(NF_Item.Frete,0)))
			
				into #tempVendaNF1 
				from NF inner join cliente on NF.Cliente_Fornecedor= cliente.Codigo_Cliente 
						 INNER JOIN NF_Item ON NF.Codigo = NF_ITEM.CODIGO and nf.Cliente_Fornecedor = nf_item.Cliente_Fornecedor and nf.Filial = nf_item.Filial
						 inner JOIN cliente_grupo  as cg on cg.id= cliente.grupo_empresa	
						 inner join Natureza_operacao np on.nf.Codigo_operacao = np.Codigo_operacao	
				 where (NF.Data between @DataDe and @DataAte ) 
				 AND Isnull(NF.NF_Canc,0) = 0 AND LTRIM(NF.Filial) = 'matriz'
				AND NF.Tipo_NF in (1,3) --Incluido a condição 3 - Emissao de Pedidos
				 and NP.NF_devolucao = 0 
					AND nf_item.codigo_operacao in ('5101', '5102','5405','5402','5403','6101', '6102','6405','6401','6403')  
				AND (LEN(@CNPJ)=0 OR LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(CLIENTE.CNPJ,'.',''),'/',''),'-','')))= @CNPJ)
				AND cg.id = @id
				 group by NF.EMISSAO,nf.Cliente_Fornecedor,cliente.Nome_Cliente,cliente.nome_fantasia, Cliente.Grupo_Empresa, cg.grupo, nf.Total
				 ORDER BY CONVERT(VARCHAR,NF.EMISSAO,102) 
		END
	ELSE
		BEGIN
			Select 
					Emissao,
					nf.Cliente_Fornecedor Cod,
					cliente.Nome_Cliente,
					cliente.nome_fantasia,
					ISNULL(cg.Grupo, '') AS Grupo,
					Total = Convert(decimal(15,2),Sum(NF_Item.Total+Isnull(NF_Item.Frete,0)))
			
				into #tempVendaNF2
				from NF inner join cliente on NF.Cliente_Fornecedor= cliente.Codigo_Cliente 
						 INNER JOIN NF_Item ON NF.Codigo = NF_ITEM.CODIGO and nf.Cliente_Fornecedor = nf_item.Cliente_Fornecedor and nf.Filial = nf_item.Filial
						 inner JOIN cliente_grupo  as cg on cg.id= cliente.grupo_empresa	
						 inner join Natureza_operacao np on.nf.Codigo_operacao = np.Codigo_operacao	
				 where (NF.Data between @DataDe and @DataAte ) 
				 AND Isnull(NF.NF_Canc,0) = 0 AND LTRIM(NF.Filial) = 'matriz'
				AND NF.Tipo_NF in (1,3) --Incluido a condição 3 - Emissao de Pedidos
				 and NP.NF_devolucao = 0 
					AND nf_item.codigo_operacao in ('5101', '5102','5405','5402','5403','6101', '6102','6405','6401','6403')  
				AND (LEN(@CNPJ)=0 OR LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(CLIENTE.CNPJ,'.',''),'/',''),'-','')))= @CNPJ)
				 group by NF.EMISSAO,nf.Cliente_Fornecedor,cliente.Nome_Cliente,cliente.nome_fantasia, Cliente.Grupo_Empresa, cg.grupo, nf.Total
				 ORDER BY CONVERT(VARCHAR,NF.EMISSAO,102) 
		END

	declare @StringVenda as Varchar(MAX)
	SET @StringVenda = 'SELECT * INTO ##TempVendaNF FROM ' + CASE WHEN @ID > 0 THEN '#TempVendaNF1' ELSE '#TempVendaNF2' END
	EXECUTE(@StringVenda)


	if(@tipo='ANALITICO')
	BEGIN
		Select 
		CONVERT(VARCHAR,EMISSAO,103) EMISSAO,
		COD='SFT_'+Cod,
		Grupo,
		Cliente= Nome_Cliente,
		Total 
		from ##tempVendaNF		
	END
	ELSE	
	BEGIN
		if(@tipo='SINTETICO')
		begin  
			Select 
				CONVERT(VARCHAR,EMISSAO,103) EMISSAO,
				Grupo,
				Cliente =nome_fantasia,
				Total = Sum(Total) 
			 from
			 ##tempVendaNF
			 group by Emissao , Grupo, nome_fantasia
		end
		else
		begin 
			if(len(@cnpj)=0)
			begin
				Select 
					Grupo,
					Total = Sum(total)
				from ##tempVendaNF
				group by grupo
				order by sum(total) desc
			end
			else
			begin 
				Select 
					COD='SFT_'+Cod,
					Grupo,
					Cliente=Nome_Cliente,
					Total = Sum(total)
				from ##tempVendaNF
				group by COD, Grupo, Nome_Cliente
				order by sum(total) desc
			end 

		end 
	END
END

GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Rel_ProdutosAlterados')
DROP PROCEDURE [sp_Rel_ProdutosAlterados]
GO

/****** Object:  StoredProcedure [dbo].[sp_Rel_ProdutosAlterados]    Script Date: 24/06/2022 08:53:49 ******/


create Procedure [dbo].[sp_Rel_ProdutosAlterados]

                @Filial                 As Varchar(20),
                @plu					as Varchar(20),
                @ean					as Varchar(20),
                @ncm					as Varchar(20),
             	@Ref_Fornecedor         As Varchar(20),
                @Descricao              As Varchar(60) ,
                @DataDe                 As Varchar(8),
                @DataAte                As Varchar(8),
                @grupo					As varchar(20)
				,@subGrupo				As varchar(20)
				,@departamento			As varchar(20)
				,@familia				As varchar(40)
				,@custoMargem			as varchar(40)
				,@LINHA VARCHAR(30)
				,@saldo varchar(14)


AS

Declare @String               As Varchar(max)
Declare @Where               As Varchar(max)


-- sp_Rel_ProdutosAlterados 'MATRIZ', '', '', '', '', '', '2022-01-01', '2022-12-31', '', '', '', 'PRECO-ATACADO', '','TODOS'
BEGIN
                --** Cria A String Com Os filtros selecionados

	
                               -- ** Começa a Criar query na Variavel String
		SET @String = 'SELECT '
		SET @String = @String + 'mercadoria.PLU,  isnull(e.EAN , '+ CHAR(39) + CHAR(39) +') as EAN, NCM = ISNULL(MERCADORIA.CF, '+ CHAR(39) + CHAR(39) +'),'
		SET @String = @String + 'mercadoria.ref_fornecedor AS REF_FORN, mercadoria.DESCRICAO , '
		SET @String = @String + 'mercadoria.PESO , '


		if(@custoMargem='ALTERADOS' or @custoMargem='ALTERADOS-CUST-MARG-VENDA' )
			begin

			SET @String = @String + 'CONVERT(VARCHAR, mercadoria.Data_Alteracao, 103) As DATA_ALTERACAO,'
			end		

		if(@custoMargem='CUSTO-MARGEM-VENDA' or @custoMargem='ALTERADOS-CUST-MARG-VENDA' )
		begin
			set @String = @String + ' mercadoria_loja.PRECO_CUSTO,MARGEM = convert(decimal(10,2), Case when mercadoria_loja.Preco_Custo > 0 and mercadoria_loja.Preco > 0 then'
			SET @String = @String + '((mercadoria_loja.Preco - mercadoria_loja.Preco_Custo ) / mercadoria_loja.Preco_Custo ) * 100 else 0 end),'
		end
	
	
		SET @String = @String + 'mercadoria_loja.preco as VENDA '

		if (@custoMargem='PRECO-ATACADO')
			BEGIN
				SET @String = @String + ', ISNULL(Mercadoria_Loja.Qtde_Atacado, 0) AS Qtde_Atacado, ISNULL(Mercadoria_Loja.Preco_Atacado, 0) AS Preco_Atacado'
			END

		SET @String = @String + ' from mercadoria inner join mercadoria_loja on mercadoria.plu = mercadoria_loja.plu '
		SET @String = @String + ' left join LINHA on mercadoria.Cod_Linha = LINHA.codigo_linha '
        SET @String = @String + ' left join EAN e on mercadoria.plu=e.PLU
								 inner join W_BR_CADASTRO_DEPARTAMENTO c on (mercadoria.codigo_departamento= c.codigo_Departamento and mercadoria.filial=c.filial)'
                               --PRINT @STRING + @Where + ' GROUP BY Mercadoria.PLU, Mercadoria.Descricao ORDER BY vlr DESC'
		Set @Where = ' WHERE  (Mercadoria_Loja.Filial = ' + CHAR(39) + @Filial + CHAR(39)+')'
        
         IF (LEN(@DESCRICAO) > 0)
		BEGIN
            SET @Where = @Where + ' AND ( mercadoria.DESCRICAO LIKE '+ CHAR(39) +'%'+ @DESCRICAO + '%'+CHAR(39)+')'

        END      
        
        
		if(@custoMargem='ALTERADOS' or @custoMargem='ALTERADOS-CUST-MARG-VENDA' )
		begin
		
			Set @Where = @Where +' And (convert(date,Mercadoria.Data_Alteracao) BETWEEN ' + CHAR(39) + @DataDe + CHAR(39) + ' AND ' + CHAR(39) + @DataAte + CHAR(39)+')'
		end

		if (@custoMargem='PRECO-ATACADO')
			BEGIN
				SET @String = @String + ' AND ISNULL(Mercadoria_Loja.Preco_Atacado, 0) > 0'
			END
	       
        
      if LEN(@plu)>0
      begin
		    SET @Where = @Where + ' AND (mercadoria.plu = '+ CHAR(39) + @plu + CHAR(39)+')'

      end	
      if LEN(@ean)>0
      begin
		    SET @Where = @Where + ' AND (e.ean = '+ CHAR(39) + @ean + CHAR(39)+')'

      end	
      if LEN(@ncm)>0
      begin
		    SET @Where = @Where + ' AND (mercadoria.CF = '+ CHAR(39) + @ncm + CHAR(39)+')'

      end	
      
      IF LEN(ISNULL(@Ref_Fornecedor,'')) > 0
	   BEGIN

            SET @Where = @Where + ' AND (Mercadoria.Ref_Fornecedor LIKE '+ CHAR(39) + @Ref_Fornecedor + CHAR(39)+')'

        END     
	
	  IF LEN(ISNULL(@grupo,'')) > 0
	   BEGIN

            SET @Where = @Where + ' AND (c.descricao_grupo = '+ CHAR(39) + @grupo + CHAR(39)+')'

        END     
	IF LEN(ISNULL(@subGrupo,'')) > 0
	   BEGIN

            SET @Where = @Where + ' AND (c.descricao_subgrupo = '+ CHAR(39) + @subGrupo + CHAR(39)+')'

        END     
        IF LEN(ISNULL(@departamento,'')) > 0
	   BEGIN

            SET @Where = @Where + ' AND c.descricao_departamento = '+ CHAR(39) + @departamento + CHAR(39)

        END    
	   IF LEN(ISNULL(@familia,'')) > 0
	   BEGIN

            SET @Where = @Where + ' AND mercadoria.descricao_familia = '+ CHAR(39) + @familia + CHAR(39)
		end


		Begin
		IF(@saldo='Igual a Zero')
			 SET @Where = @Where + ' 	and (mercadoria.saldo_atual=0)'
		End
		
		Begin
		IF(@saldo='Menor que Zero')
			 SET @Where = @Where + ' 	and (mercadoria.saldo_atual<0)'
		End
		
		Begin
		IF(@saldo='Maior que Zero')
			 SET @Where = @Where + ' 	and (mercadoria.saldo_atual>0)'
		End
		
		IF(LEN(@LINHA)>0 )
		Begin
			SET @Where = @Where + ' 	and (LINHA.descricao_linha ='+char(39)+@LINHA+char(39)+')'
		End
	 

		--print(@String + @Where)
		EXECUTE(@String + @Where)

END

 go

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_m_Comanda_Consumo')
DROP PROCEDURE [sp_m_Comanda_Consumo]
GO

/****** Object:  StoredProcedure [dbo].[sp_m_Comanda_Consumo]    Script Date: 06/24/2022 09:01:27 ******/

create PROCEDURE [dbo].[sp_m_Comanda_Consumo]
	@comanda as varchar(10),
	@consolidado as integer
AS

	-- SP_M_COMANDA_CONSUMO '8', 0
	if @consolidado = 1
		BEGIN
			IF (OBJECT_ID('tempdb..#SEMCONSOLIDAR')) IS NOT NULL
				DROP TABLE #SEMCONSOLIDAR

			IF (OBJECT_ID('tempdb..#CONSOLIDAR')) IS NOT NULL
				DROP TABLE #CONSOLIDAR

			SELECT 
			codigo = A.PLU,
			descricao = C.DESCRICAO, 
			quantidade = A.QTDE, 
			valor = A.unitario,
			C.Tipo,
			C.Peso_Variavel
			INTO #SEMCONSOLIDAR
			FROM COMANDA_ITEM AS A 
			INNER JOIN COMANDA_CONTROLE AS B ON A.COMANDA=B.COMANDA 
			INNER JOIN MERCADORIA AS C ON A.PLU=C.PLU WHERE
			A.DATA_CANCELAMENTO IS NULL 
			AND (B.STATUS = '02' OR B.STATUS = '06') 
			AND A.CUPOM = '0' AND A.PDV = '0' 
			AND A.COMANDA = @Comanda
			AND (C.Tipo = 'PIZZA' OR C.Peso_Variavel = 'PESO')


			SELECT 
			codigo = A.PLU,
			descricao = C.DESCRICAO, 
			quantidade = SUM(A.QTDE), 
			valor = AVG(A.unitario),
			C.Tipo,
			C.Peso_Variavel
			INTO #CONSOLIDAR
			FROM COMANDA_ITEM AS A 
			INNER JOIN COMANDA_CONTROLE AS B ON A.COMANDA=B.COMANDA 
			INNER JOIN MERCADORIA AS C ON A.PLU=C.PLU WHERE
			A.DATA_CANCELAMENTO IS NULL 
			AND (B.STATUS = '02' OR B.STATUS = '06') 
			AND A.CUPOM = '0' AND A.PDV = '0' 
			AND A.COMANDA = @Comanda
			AND NOT (C.Tipo = 'PIZZA' OR C.Peso_Variavel = 'PESO')
			GROUP BY A.PLU, C.Descricao, C.Tipo, C.Peso_Variavel

			select codigo, descricao, quantidade, valor from #SEMCONSOLIDAR
			union all
			select codigo, descricao, quantidade, valor from #CONSOLIDAR
			ORDER BY 2
		END
	ELSE
		BEGIN
			SELECT 
			codigo = A.PLU,
			descricao = C.DESCRICAO, 
			quantidade = A.QTDE, 
			valor = A.unitario
			FROM COMANDA_ITEM AS A 
			INNER JOIN COMANDA_CONTROLE AS B ON A.COMANDA=B.COMANDA 
			INNER JOIN MERCADORIA AS C ON A.PLU=C.PLU WHERE
			A.DATA_CANCELAMENTO IS NULL 
			AND (B.STATUS = '02' OR B.STATUS = '06') 
			AND A.CUPOM = '0' AND A.PDV = '0' 
			AND A.COMANDA = @Comanda
			ORDER BY A.ID
		END

go

insert into Versoes_Atualizadas select 'Versão:1.315.898', getdate();

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('nf_item') 
            AND  UPPER(COLUMN_NAME) = UPPER('Redutor_Base_IVA'))
begin
	alter table nf_item alter column Redutor_Base_IVA Decimal (5,2) 
end
else
begin
	alter table nf_item add Redutor_Base_IVA Decimal (5,2) default 0
end 
go 




IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('manifesto_consultas') 
            AND  UPPER(COLUMN_NAME) = UPPER('cStat'))
begin
	alter table manifesto_consultas alter column cStat varchar(3)
end
else
begin
	alter table manifesto_consultas add cStat varchar(3)
end 
go 

if not exists(select 1 from PARAMETROS where PARAMETRO='TEMPO_MANIFESTO')
begin	
INSERT INTO [PARAMETROS]([PARAMETRO],[PENULT_ATUALIZACAO],[VALOR_DEFAULT],[ULT_ATUALIZACAO],[VALOR_ATUAL],[DESC_PARAMETRO],[TIPO_DADO],[RANGE_VALOR_ATUAL],[GLOBAL],[NOTA_PROGRAMADOR],[ESCOPO],[POR_USUARIO_OK],[DATA_PARA_TRANSFERENCIA],[PERMITE_POR_EMPRESA])     
VALUES('TEMPO_MANIFESTO',GETDATE(),'60',GETDATE(),'5','TEMPO EM MINUTOS DE INTERVALO DE CONSULTA DO MANIFESTO','',0,1,'',0,0,NULL,0)
 end
GO
go 
if not exists(select 1 from PARAMETROS where PARAMETRO='NF_CADASTRO_AUTO')
begin	
INSERT [dbo].[Parametros] ([PARAMETRO], [PENULT_ATUALIZACAO], [VALOR_DEFAULT], [ULT_ATUALIZACAO], [VALOR_ATUAL], [DESC_PARAMETRO], [TIPO_DADO], [RANGE_VALOR_ATUAL], [GLOBAL], [NOTA_PROGRAMADOR], [ESCOPO], [POR_USUARIO_OK], [DATA_PARA_TRANSFERENCIA], [PERMITE_POR_EMPRESA]) 
VALUES (N'NF_CADASTRO_AUTO', CAST(N'2022-03-11T15:52:42.690' AS DateTime), N'FALSE', CAST(N'2022-03-11T15:52:42.690' AS DateTime), N'FALSE', N'NF ENTRADA CADASTRO DE FORNECEDOR E MERCADORIA AUTOMATICO ', N' ', N'0', 1, N'', 0, 0, NULL, 0) 
end 
GO
if not exists(select 1 from PARAMETROS where PARAMETRO='CFOPS_BONIFICACAO')
begin	
INSERT [dbo].[Parametros] ([PARAMETRO], [PENULT_ATUALIZACAO], [VALOR_DEFAULT], [ULT_ATUALIZACAO], [VALOR_ATUAL], [DESC_PARAMETRO], [TIPO_DADO], [RANGE_VALOR_ATUAL], [GLOBAL], [NOTA_PROGRAMADOR], [ESCOPO], [POR_USUARIO_OK], [DATA_PARA_TRANSFERENCIA], [PERMITE_POR_EMPRESA]) 
VALUES (N'CFOPS_BONIFICACAO', CAST(N'2022-03-11T15:53:20.617' AS DateTime), N'5910,6910,1910,2910', CAST(N'2022-03-11T15:53:20.617' AS DateTime), N'5910,6910,1910,2910', N'CFOPS DE BONIFICACAO', N' ', N'0', 1, N'', 0, 0, NULL, 0)
end 
GO
if not exists(select 1 from PARAMETROS where PARAMETRO='EVENTOS_CONTABEIS')
begin	
INSERT [dbo].[Parametros] ([PARAMETRO], [PENULT_ATUALIZACAO], [VALOR_DEFAULT], [ULT_ATUALIZACAO], [VALOR_ATUAL], [DESC_PARAMETRO], [TIPO_DADO], [RANGE_VALOR_ATUAL], [GLOBAL], [NOTA_PROGRAMADOR], [ESCOPO], [POR_USUARIO_OK], [DATA_PARA_TRANSFERENCIA], [PERMITE_POR_EMPRESA]) 
VALUES (N'EVENTOS_CONTABEIS', CAST(N'2022-03-11T15:53:20.630' AS DateTime), N'FALSE', CAST(N'2022-03-11T15:53:20.630' AS DateTime), N'FALSE', N'DEFINE SE O SISTEMA VAI POPULAR DADOS NA TABELA EVENTOS CONTABEIS', N'L', N'0', 1, N'', 0, 0, NULL, 0)
end 
GO
if not exists(select 1 from PARAMETROS where PARAMETRO='PEDIDO_DESC_TOTAL')
begin	
INSERT [dbo].[Parametros] ([PARAMETRO], [PENULT_ATUALIZACAO], [VALOR_DEFAULT], [ULT_ATUALIZACAO], [VALOR_ATUAL], [DESC_PARAMETRO], [TIPO_DADO], [RANGE_VALOR_ATUAL], [GLOBAL], [NOTA_PROGRAMADOR], [ESCOPO], [POR_USUARIO_OK], [DATA_PARA_TRANSFERENCIA], [PERMITE_POR_EMPRESA]) 
VALUES (N'PEDIDO_DESC_TOTAL', CAST(N'2022-07-18T15:43:41.697' AS DateTime), N'FALSE', CAST(N'2022-07-18T15:43:41.697' AS DateTime), N'TRUE', N'PEDIDO VENDA CALCULA VALOR TOTAL DO DESCONTO', N' ', N'0', 1, N'', 0, 0, NULL, 0)
end 
GO
if not exists(select 1 from PARAMETROS where PARAMETRO='PEDIDO_VDA_RAP_CUSTO_MRG')
begin	
INSERT [dbo].[Parametros] ([PARAMETRO], [PENULT_ATUALIZACAO], [VALOR_DEFAULT], [ULT_ATUALIZACAO], [VALOR_ATUAL], [DESC_PARAMETRO], [TIPO_DADO], [RANGE_VALOR_ATUAL], [GLOBAL], [NOTA_PROGRAMADOR], [ESCOPO], [POR_USUARIO_OK], [DATA_PARA_TRANSFERENCIA], [PERMITE_POR_EMPRESA]) 
VALUES (N'PEDIDO_VDA_RAP_CUSTO_MRG', CAST(N'2022-09-14T11:13:13.230' AS DateTime), N'FALSE', CAST(N'2022-09-14T11:13:13.230' AS DateTime), N'TRUE', N'VISUALIZAR CUSTO E MARGEM NA INCLUSAO DE ITEM RAPIDO', N' ', N'0', 1, N'', 0, 0, NULL, 0)
end 
GO



insert into Versoes_Atualizadas select 'Versão:1.314.897', getdate();
IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('Tesouraria') 
            AND  UPPER(COLUMN_NAME) = UPPER('Deposito'))
begin
	alter table Tesouraria alter column Deposito decimal(18,2)
end
else
begin
	alter table Tesouraria add Deposito decimal(18,2)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF_Manifestar') 
            AND  UPPER(COLUMN_NAME) = UPPER('Numero_Protocolo'))
begin
	alter table NF_Manifestar alter column Numero_Protocolo VARCHAR(100)
end
else
begin
	alter table NF_Manifestar add Numero_Protocolo VARCHAR(100)
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF_Manifestar') 
            AND  UPPER(COLUMN_NAME) = UPPER('Situacao'))
begin
	alter table NF_Manifestar alter column Situacao tinyint
end
else
begin
	alter table NF_Manifestar add Situacao tinyint
end 
go 

IF EXISTS( SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE UPPER(TABLE_NAME) = UPPER('NF_Manifestar') 
            AND  UPPER(COLUMN_NAME) = UPPER('Validada_Comercial'))
begin
	alter table NF_Manifestar alter column Validada_Comercial tinyint
end
else
begin
	alter table NF_Manifestar add Validada_Comercial tinyint
end 
go 

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'SP_REL_VENDAS_POR_FINALIZADORA')
DROP PROCEDURE [SP_REL_VENDAS_POR_FINALIZADORA]
GO

/****** Object:  StoredProcedure [dbo].[SP_REL_VENDAS_POR_FINALIZADORA]    Script Date: 10/14/2022 11:37:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--PROCEDURES =======================================================================================
create PROCEDURE [dbo].[SP_REL_VENDAS_POR_FINALIZADORA]
				@Filial      As Varchar(20),
                @DataDe      As Varchar(8),
                @DataAte     As Varchar(8)
AS
begin
-- exec SP_REL_VENDAS_POR_FINALIZADORA 'MATRIZ','20210601','20210630'
Declare crFinalizadora cursor
for  SELECT Finalizadora FROM Finalizadora WHERE NAOCOMPUTA = 0 GROUP BY Finalizadora, Nro_Finalizadora order by Nro_Finalizadora
declare @SqlString Nvarchar(max)
SET @SqlString = ''
DECLARE @FINALIZA VARCHAR(30)
open crFinalizadora

FETCH NEXT FROM crFinalizadora INTO @FINALIZA;
WHILE @@FETCH_STATUS = 0
   BEGIN
	
		SET  @SqlString = @SqlString + ',[' + @FINALIZA +'] =ISNULL((select SUM(ISNULL(total,0))from Lista_finalizadora where Filial='+ CHAR(39) +@Filial+ CHAR(39) + '  and emissao =lf.emissao  and id_finalizadora ='+CHAR(39) + @FINALIZA+ CHAR(39) + ' AND isnull(Cancelado,0)=0),0)'
	  --SET @SqlString = @SqlString + CONVERT(VARCHAR(10),@TRIB)
		 
      FETCH  NEXT FROM crFinalizadora INTO @FINALIZA;
      
   END;

CLOSE crFinalizadora;
DEALLOCATE crFinalizadora;
SET @SqlString = 'Select Data =convert(varchar,Emissao,103),SUM(ISNULL(total,0)) AS TOTAL '+@SqlString +'  from Lista_finalizadora lf  ' +
                    ' where Filial='+ CHAR(39) +@Filial+ CHAR(39) + 'and isnull(cancelado,0) = 0  and Emissao between ' + CHAR(39) + @DataDe +  CHAR(39) + ' and '+ CHAR(39) + @DataAte + CHAR(39) +
                    ' group by Emissao  order by convert(varchar,Emissao,102) ';


 --print(@sqlString);
 EXECUTE (@SqlString);

end
go

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Movimento_Venda')
DROP PROCEDURE [sp_Movimento_Venda]
GO
/****** Object:  StoredProcedure [dbo].[sp_Movimento_Venda]    Script Date: 10/21/2022 11:07:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create  Procedure [dbo].[sp_Movimento_Venda]

                @Filial				As Varchar(20),
                @DataDe				As Varchar(8),
                @DataAte			As Varchar(8),
                @finalizadora		As varchar(30),
                @plu				As varchar(17),
                @cupom				As varchar(20),
                @pdv				as varchar(10),                
                @horaInicio			as varchar(7),				
				@horafim			as varchar(7),
				@cancelados			as varchar(15),
				@comanda			as varchar(20),
				@ext_sat			as varchar(6)

AS

begin 
--exec     sp_Movimento_Venda   @Filial='MATRIZ', @DataDe = '20180602',  @dataate = '20180602',  @horaInicio = '00:00',  @horafim = '23:59',  @finalizadora = 'TODOS',  @Pdv = 'TODOS',  @plu = '',  @cupom = '',  @comanda = '',  @cancelados = 'TODOS',  @ext_sat = '' 

Select Data_movimento, S.Documento, S.PLU, m.DESCRICAO, S.QTDE, vlr, Desconto,  Acrescimo ,
	Caixa_Saida, Ext_SAT = '', Hora_venda, ComandaPedidoCupom, Finalizadora = 'NAO FINALIZADOS'
Into 
	#CupomSemPagamento
From 
	Saida_estoque s INNER JOIN Mercadoria m on s.plu = m.plu 
	Where 

		s.Filial = @FILIAL   
	and 	
		s.Data_movimento BETWEEN @DataDe AND @DataAte
	And 
		not s.data_cancelamento is null
	and 
		Caixa_Saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
	And 
		not exists(select * from Lista_finalizadora l 
					Where l.filial = s.Filial 
					and l.Emissao = s.data_movimento
					and l.documento = s.documento 
						And l.pdv = s.caixa_saida
						)


--exec sp_Movimento_Venda @Filial='MATRIZ', @DataDe = '20180705',  @dataate = '20180705',  @horaInicio = '00:00',  @horafim = '23:59',  @finalizadora = 'TODOS',  @Pdv = 'TODOS',  @plu = '',  @cupom = '',  @comanda = '',  @cancelados = '',  @ext_sat = '' 
IF(@plu='' AND @cupom='' and @ext_sat ='')

      BEGIN

            IF(@finalizadora ='TODOS')

                  BEGIN

                        SELECT DISTINCT

                             DATA = CONVERT(VARCHAR,lista.EMISSAO,103),

                             lista.PDV,

                             CUPOM = lista.DOCUMENTO,
                             [Ext SAT ] = 'SFT_'+SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
                             CONVERT(varchar , s.Hora_venda,108) as HORA,
                             
							[COMANDA/PEDIDOS] =  '_'+(SELECT Max(ComandaPedidoCupom) FROM Saida_estoque st  with (index(IX_Movimento_venda_01))

								WHERE st.Filial = @FILIAL And st.data_cancelamento is null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento),
                        
                             
                             FINALIZADORA = lista.id_finalizadora,
							
						     VLR = (SELECT isnull(convert(decimal(18,2),SUM(list1.Total )),0) 
										FROM Lista_finalizadora list1
				                             INNER JOIN Finalizadora ON list1.finalizadora = finalizadora.Nro_Finalizadora 
								  			 --INNER JOIN  Saida_estoque S  with (index(IX_Movimento_venda_01)) ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv and CONVERT(varchar , s.Hora_venda,108) between @horaInicio + ':00'and @horafim + ':59'
									WHERE list1.Filial = @FILIAL And Isnull(Cancelado,0) = 0 
											 AND (list1.Emissao = lista.Emissao)
											 and list1.pdv =lista.pdv
											 and list1.documento = lista.documento
											 AND LIST1.id_finalizadora = LISTA.id_finalizadora
                         ),
                             CANCELADOS = (SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) 
										    FROM Saida_estoque st  with (index(IX_Movimento_venda_01)) 
											WHERE st.Filial = @FILIAL And data_cancelamento is not null 
													and CONVERT(varchar , st.Hora_venda,108) between @horaInicio + ':00'and @horafim + ':59'
													AND (st.Data_movimento = lista.Emissao)
													and st.Caixa_Saida =lista.pdv
													and st.documento = lista.documento),
						 [CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)

						INTO #LISTA_TEMP FROM Lista_finalizadora lista
                            INNER JOIN Finalizadora ON lista.finalizadora = finalizadora.Nro_Finalizadora 
							INNER JOIN Saida_estoque S  with (index(IX_Movimento_venda_01))  ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv	and s.Data_movimento = lista.Emissao
                        WHERE lista.Filial = @FILIAL  AND (Emissao BETWEEN @DataDe  AND  @DataAte )
								  and CONVERT(varchar , s.Hora_venda,108) between @horaInicio + ':00' and @horafim +':59'
                                   and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
								   and (LEN(@cancelados)=0 OR
										
										(@cancelados ='TODOS' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																							WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
																								AND (st.Data_movimento = lista.Emissao)
																							   and st.Caixa_Saida =lista.pdv
																							   and st.documento = lista.documento))>0) 
										OR (@cancelados='ITEM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=0 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0) 
										OR (@cancelados='CUPOM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=1 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0)												   
																						   
																						   ) 
																						   
						and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
						
						--Incluir Registros sem Pagamento
						Insert into #LISTA_TEMP
						Select  DISTINCT
							DATA = CONVERT(VARCHAR,c.Data_movimento,103)
						  , PDV = c.Caixa_Saida
						  , Cupom = Documento
						  , Ext_SAT
						  , CONVERT(varchar , C.Hora_venda,108) as HORA
						  , [COMANDA/PEDIDOS] = '_'+ Max(ComandaPedidoCupom)
						  , Finalizadora
						  , vlr = 0
						  , Cancelados = SUM(Vlr-isnull(Desconto,0)) 
						  ,''
						From 
							#CupomSemPagamento c 
						Where
							CONVERT(varchar , c.Hora_venda,108) between @horaInicio +':00' and @horafim + ':59'
						--And 
						--	(LEN(@comanda)=0 or c.ComandaPedidoCupom  like '%'+@comanda+'%')
						and 
							Finalizadora = (case when @cancelados = ''				 then 'NAO FINALIZADOS' 
													when @cancelados = 'NAO FINALIZADOS' then 'NAO FINALIZADOS' 
													when @cancelados = 'TODOS'			 then 'NAO FINALIZADOS' 
													else 'NAO APARECE NADA' end)								
						Group By 			
							c.Data_movimento, c.Caixa_Saida, Documento, Ext_SAT, Finalizadora	, HORA_VENDA																																	   
                       
                       ----*******************************************************---------
                       
					   
						UPDATE #LISTA_TEMP SET CANCELADOS = (CANCELADOS/(SELECT COUNT(B.CUPOM) FROM #LISTA_TEMP AS B WHERE  B.CUPOM = #LISTA_TEMP.CUPOM and b.pdv = #LISTA_TEMP.pdv)  ) 
						WHERE CUPOM IN (SELECT CUPOM FROM #LISTA_TEMP where CANCELADOS >0 GROUP BY CUPOM,pdv HAVING   COUNT(CUPOM) > 1   )
						AND CANCELADOS >0
						

                       SELECT DISTINCT * FROM #LISTA_TEMP
					   

                  END

            ELSE

                  BEGIN

                        SELECT

                             DATA = CONVERT(VARCHAR,EMISSAO,103),

                             PDV,

                             CUPOM = lista.DOCUMENTO,
                             [Ext SAT] = 'SFT_'+SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
                             CONVERT(varchar , Hora_venda,108) AS HORA,

                             [COMANDA/PEDIDOS] = '_'+(SELECT Max(ComandaPedidoCupom) FROM Saida_estoque st

								WHERE st.Filial = @FILIAL And data_cancelamento is null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento),
                                   VLR =(SELECT isnull(convert(decimal(18,2),SUM(list1.Total )),0) FROM Lista_finalizadora list1

                             INNER JOIN Finalizadora ON list1.finalizadora = finalizadora.Nro_Finalizadora 

                        WHERE list1.Filial = @FILIAL And Isnull(Cancelado,0) = 0 
									AND (list1.Emissao = lista.Emissao)
                                   and list1.pdv =lista.pdv
                                   and list1.documento = lista.documento
                                   
                         ),        

                             FINALIZADORA = id_finalizadora,
                             
                     
                             CANCELADO = (SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st  with (index(IX_Movimento_venda_01))

								WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento
                                    ),
							[CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
													Select TOP 1 S2.ID_CHAVE		 
													FROM SAIDA_ESTOQUE  AS S2
													WHERE S2.Documento = S.Documento
														AND S2.Caixa_Saida = S.Caixa_Saida
														AND S2.Data_movimento = S.Data_movimento
														AND S2.Filial = S.Filial
														AND S2.ID_Chave IS NOT NULL
												)
										)


                      INTO #LISTA_TEMP2   FROM

                             Lista_finalizadora lista

                             INNER JOIN Finalizadora ON lista.finalizadora = finalizadora.Nro_Finalizadora 
                             INNER JOIN  Saida_estoque S  ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv and s.Data_movimento = lista.Emissao

                        WHERE lista.Filial = @FILIAL  AND (Emissao BETWEEN @DataDe  AND  @DataAte )

                        AND finalizadora.Finalizadora  = @finalizadora 
						and CONVERT(varchar , Hora_venda,108) between @horaInicio +':00' and @horafim +':59'
                         and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
						 and (LEN(@cancelados)=0 OR
								(@cancelados ='TODOS' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																							WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
																								AND (st.Data_movimento = lista.Emissao)
																							   and st.Caixa_Saida =lista.pdv
																							   and st.documento = lista.documento))>0) 
										OR (@cancelados='ITEM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=0 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0) 
										OR (@cancelados='CUPOM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=1 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0)												   
																						   
																						   ) 
									
                       and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                      --  GROUP BY Emissao, PDV, lista.DOCUMENTO ,id_finalizadora,CONVERT(varchar , Hora_venda,108),SUBSTRING(S.ID_CHAVE,35,6)




                             SELECT DISTINCT * FROM #LISTA_TEMP2

                  END

      END

 

ELSE IF (@plu<>'' AND @cupom='' and @ext_sat = '')

BEGIN

      SELECT CUPOM = S.Documento,
			 [Ext SAT] = SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
             DATA = CONVERT(VARCHAR,s.Data_movimento,103),
             HORA = convert(varchar,Hora_venda),
	         PDV=convert(varchar,s.caixa_saida) ,
			 'PLU'+S.PLU as PLU,
			 DESCRICAO =M.Descricao,
             QTDE=replace(convert(varchar,S.Qtde),'.',','),
             VLR=replace(convert(varchar,S.vlr),'.',','),
			 [-DESCONTO]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),
			 [+ACRESCIMO]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),
			 TOTAL=replace(convert(varchar,(s.vlr-isnull(s.Desconto,0))+ISNULL(s.acrescimo,0)),'.',',') ,
			 [CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
					Select TOP 1 S2.ID_CHAVE		 
					FROM SAIDA_ESTOQUE  AS S2
					WHERE S2.Documento = S.Documento
						AND S2.Caixa_Saida = S.Caixa_Saida
						AND S2.Data_movimento = S.Data_movimento
						AND S2.Filial = S.Filial
						AND S2.ID_Chave IS NOT NULL
					)
			 )

      FROM Saida_estoque S  with (index(IX_Saida_Estoque)) 
					--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
                    INNER JOIN Mercadoria M ON S.PLU = M.PLU      
	  where s.Filial = @Filial 
	  and s.Data_movimento BETWEEN @DataDe  AND  @DataAte
                        and (len(@plu)=0 or s.PLU = @plu )
	  AND (LEN(@cupom)=0 or  s.Documento  =  @cupom  )
                        and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                        and CONVERT(varchar , Hora_venda,108) between @horaInicio +':00' and @horafim +':59'
                        And s.Data_Cancelamento is null
                         --and (LEN(@pdv)=0 or l.pdv = @pdv)
                        
						and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                        --Group by s.Documento,l.Emissao,l.pdv,s.plu,m.descricao,s.Qtde,s.vlr,s.Desconto,s.Acrescimo,Hora_venda
                        order by s.Data_movimento , Hora_venda

      END

ELSE

      BEGIN
      
            SELECT	CUPOM = S.Documento, --1
					[Ext SAT] = SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),--2
					DATA = CONVERT(VARCHAR,s.Data_movimento,103), --3
					PDV=convert(varchar,s.caixa_saida) ,--4
					'PLU'+S.PLU AS PLU, --5
					DESCRICAO = M.Descricao, --6
					QTDE=replace(convert(varchar,S.Qtde),'.',','),--7
					VLR=replace(convert(varchar,S.vlr),'.',','),--8
					[-DESCONTO]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),--9
					[+ACRESCIMO]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),--10
					TOTAL=replace(convert(varchar,(s.vlr-isnull(s.Desconto,0))+ISNULL(s.acrescimo,0)),'.',','), --11
					[CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
							Select TOP 1 S2.ID_CHAVE		 
							FROM SAIDA_ESTOQUE  AS S2
							WHERE S2.Documento = S.Documento
								AND S2.Caixa_Saida = S.Caixa_Saida
								AND S2.Data_movimento = S.Data_movimento
								AND S2.Filial = S.Filial
								AND S2.ID_Chave IS NOT NULL
							)
					 )

            FROM Saida_estoque S  with (index(IX_Movimento_venda_01)) 
						--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
						INNER JOIN Mercadoria M ON S.PLU = M.PLU      
			where s.Documento like (case when @cupom <>'' then @cupom  else '%' end  )
						and (len(@ext_sat)=0 or SUBSTRING(S.ID_CHAVE,35,6)= @ext_sat)
                        and s.PLU like (case when @plu <>'' then @plu else '%' end )
                        and s.data_movimento BETWEEN @DataDe  AND  @DataAte
                        And s.Data_Cancelamento is null
						and s.Data_movimento between @DataDe aND @DataAte 
                        and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                        and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                       --Group by s.Documento,s.data_movimento,s.caixa_saida,s.plu,m.descricao,s.Qtde,s.vlr,s.Desconto,s.Acrescimo,Hora_venda,SUBSTRING(S.ID_CHAVE,35,6)
		union all                      
			SELECT '',--1
				   '',--2
                   '|-CANCELADO-|',--3
				   pdv=convert(varchar,s.caixa_saida) ,--4
                   '|-'+S.PLU+'-|',--5
                   '|-'+M.Descricao+'-|', --6
                   Qtde=replace(convert(varchar,S.Qtde),'.',','),--7
                   Vlr=replace(convert(varchar,S.vlr),'.',','),--8
                   [-Desconto]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),--9
                   [+Acrescimo]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),--10
                   Total='0,000', --11
				   ''--12
            FROM Saida_estoque S  with (index(IX_Movimento_venda_01))
				--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
				INNER JOIN Mercadoria M ON S.PLU = M.PLU      
			where s.Documento like (case when @cupom <>'' then @cupom  else '%' end  )
					and (len(@ext_sat)=0 or SUBSTRING(S.ID_CHAVE,35,6)= @ext_sat)
					and s.PLU like (case when @plu <>'' then @plu else '%' end )
                    and s.data_movimento BETWEEN @DataDe  AND  @DataAte
                	And s.Data_Cancelamento is NOT null
					and s.Data_movimento between @DataDe aND @DataAte 
                    and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                    and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
		union all

            select  '',--1
					'',--2
					'',--3
					'',--4
					'',--5
					'|-'+ id_finalizadora+'-|'  ,--6
					'',--7
					'',--8
					'',--9
					'',--10
					 '|-'+replace(convert(varchar,(SUM(Lista_Finalizadora.Total))),'.',',')+'-|' --11
					,'' -- 12
			from Lista_finalizadora
			where  Documento like (case when @cupom <>'TODOS' then @cupom  else '%' end  )
		
                   and Emissao BETWEEN @DataDe  AND  @DataAte
                   And Isnull(Cancelado,0) = 0
                   and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
			GROUP BY Emissao, PDV, DOCUMENTO ,id_finalizadora

                       

      END


end

go

IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'U' AND name = 'Fornecedor_Ocorrencia')
CREATE TABLE [dbo].[Fornecedor_Ocorrencia](
	[Fornecedor] [varchar](50) NOT NULL,
	[Data] DateTime NOT NULL,
	[Ocorrencia] nVarchar(MAX) NOT NULL,
	[Status] [VarChar](20) NOT NULL,
	[Usuario] [VarChar](20) NOT NULL
)
go



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'LX_SEQUENCIAL')
DROP PROCEDURE [LX_SEQUENCIAL]
GO

/****** Object:  StoredProcedure [dbo].[LX_SEQUENCIAL]    Script Date: 29/06/2022 10:49:25 ******/

create PROCEDURE [dbo].[LX_SEQUENCIAL] @TABELA_COLUNA VARCHAR(37), @EMPRESA INT = NULL, @SEQUENCIA VARCHAR(20) OUTPUT
AS
BEGIN
	SET NOCOUNT ON
	DECLARE	@SEQUENCIA_ANT VARCHAR(20), 
		@TAMANHO INT, 
		@PERMITE_POR_EMPRESA SMALLINT,
		@EXECUTA SMALLINT,
		@errno   int,
		@errmsg  varchar(255)

	--SET

	SELECT @EXECUTA=1
	WHILE @EXECUTA=1
	BEGIN
		SELECT 	@SEQUENCIA_ANT	= ISNULL(SEQUENCIA,0), 
			@TAMANHO	= ISNULL(TAMANHO,DATALENGTH(RTRIM(SEQUENCIA))), 
			@PERMITE_POR_EMPRESA =0
		FROM SEQUENCIAIS 
		WHERE TABELA_COLUNA=@TABELA_COLUNA
		IF @@ROWCOUNT=0
		BEGIN
			SELECT 	@ERRNO=50001,
				@ERRMSG='O sequencial #'+RTRIM(@TABELA_COLUNA) +' #nao existe na tabela de sequenciais !!!'
			GOTO error
		END

		BEGIN
			SELECT @SEQUENCIA=RIGHT(REPLICATE('0',@TAMANHO)+CONVERT(VARCHAR(20),CONVERT(INT,@SEQUENCIA_ANT)+1),@TAMANHO)

			UPDATE 	SEQUENCIAIS 
			SET 	SEQUENCIA = @SEQUENCIA
			WHERE 	TABELA_COLUNA=@TABELA_COLUNA AND 
				SEQUENCIA=@SEQUENCIA_ANT
			
		END
		IF @@ROWCOUNT=1 OR @@ERROR <> 0
			SELECT @EXECUTA=0
	END


RETURN
error:
    --raiserror @errno @errmsg
RETURN
END

go

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SP_REL_HISTORIO_ENTRADA_SAIDA_CONSOLIDADE]') AND type in (N'P', N'PC'))
begin
	DROP PROCEDURE [SP_REL_HISTORIO_ENTRADA_SAIDA_CONSOLIDADE]
end

GO

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Br_Cons_SaldoKardexPLU')
DROP PROCEDURE [sp_Br_Cons_SaldoKardexPLU]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[sp_Br_Cons_SaldoKardexPLU]
@PLU as Varchar(17)
AS

-- sp_br_cons_saldokardexplu  '44065'
begin
	--declare @plu as varchar(17)
	declare @qtdeEntrada as integer
	declare @qtdeSaidanf As integer
	declare @qtdeSaida As integer
	declare @qtdeAjEntrada as Integer
	declare @qtdeAjSaida as Integer
	declare @dataBase	as datetime
	declare @qtdeBase as integer

	--set @plu = '59382'


	SET @dataBase = ISNULL((select TOP 1 IV.Data  from Inventario iv inner join Inventario_itens ii on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao = 'INVENTARIO' and iv.status = 'ENCERRADO'
	WHERE ii.PLU = @plu order by iv.Data desc), '1900-01-01')

	if @dataBase > '1900-01-01' 
		begin
			SET @qtdeBase = ISNULL((select top 1 ii.Contada from Inventario iv inner join Inventario_itens ii on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao = 'INVENTARIO' and iv.status = 'ENCERRADO'
			WHERE ii.PLU = @plu order by iv.Codigo_inventario  desc), '1900-01-01')
		end
	else
		set @qtdeBase = 0


	set @qtdeAjEntrada = isnull(( select sum(ii.Contada) from Inventario iv inner join Inventario_itens ii 
	on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao in('AJUSTE ENTRADA', 'DEVOLUCAO')
	and iv.status = 'ENCERRADO' WHERE iv.data >= @database and ii.PLU = @plu), 0)

	set @qtdeAjSaida  = isnull(( select sum(ii.Contada) from Inventario iv inner join Inventario_itens ii 
	on iv.Codigo_inventario = ii.Codigo_inventario AND iv.tipoMovimentacao in('AJUSTE SAIDA', 'DESPERDICIO')
	and iv.status = 'ENCERRADO' WHERE iv.Data >= @dataBase and ii.PLU = @plu), 0)
		

	select @qtdeEntrada = sum(i.Qtde * i.Embalagem) 
	from nf inner join nf_item i on nf.Filial = i.Filial and nf.Cliente_Fornecedor = i.Cliente_Fornecedor and nf.codigo = i.codigo
	inner join Natureza_Operacao n on nf.codigo_operacao = n.Codigo_operacao 
	where nf.Tipo_NF = 2
	and i.PLU = @plu
	and nf.data >= case when @dataBase >= '1900-01-01' then @dataBase else '1900-01-01' end
	and ISNULL(nf.nf_canc, 0) < 1
	and n.Baixa_estoque  = 1

		
	select @qtdeSaidanf  = sum(i.Qtde * i.Embalagem) 
	from nf inner join nf_item i on nf.Filial = i.Filial and nf.Cliente_Fornecedor = i.Cliente_Fornecedor and nf.codigo = i.codigo
	inner join Natureza_Operacao n on nf.codigo_operacao = n.Codigo_operacao 
	where nf.Tipo_NF = 1
	and i.PLU = @plu
	and nf.data >= case when @dataBase >= '1900-01-01' then @dataBase else '1900-01-01' end
	and ISNULL(nf.nf_canc, 0) < 1
	and n.Baixa_estoque  = 1

	select @qtdeSaida = sum(s.qtde) from Saida_estoque s with (index=ix_Saida_estoque)
	where s.Filial = 'MATRIZ' AND s.Data_movimento  >= case when @dataBase >= '1900-01-01' then @dataBase else '1900-01-01' end
	and s.PLU = @plu and s.data_cancelamento is null

	/*
	print @database
	print @plu
	print @qtdebase 
	print @qtdeentrada 
	PRINT @qtdeajentrada
	print @qtdesaidanf
	print @qtdesaida
	print @qtdeAjSaida

	PRINT '----'
	*/
	SELECT
	Inicio = CONVERT(VARCHAR, @dataBase, 103) 
	, [Qtde Inicio] =  ISNULL(@qtdeBase, 0)
	, [Entrada NFe] = ISNULL(@qtdeentrada, 0) 
	, [Entrada Ajustes] = ISNULL(@qtdeajentrada, 0) 
	, [Saida NFe] = ISNULL(@qtdesaidanf, 0) 
	, [Saida Cupom] = ISNULL(@qtdesaida, 0) 
	, [Saida Ajustes] = ISNULL(@qtdeAjSaida, 0)
	, [Saldo Final] = ISNULL(@qtdeBase, 0) + ISNULL(@qtdeentrada, 0)  + ISNULL(@qtdeajentrada, 0)  - ISNULL(@qtdesaidanf, 0)  - ISNULL(@qtdesaida, 0)  - ISNULL(@qtdeAjSaida, 0)

end

GO


IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'sp_Rel_EstoqueNaData')
DROP PROCEDURE [sp_Rel_EstoqueNaData]
GO


/****** Object:  StoredProcedure [dbo].[sp_Rel_EstoqueNaData]    Script Date: 07/21/2022 10:30:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--[sp_Rel_EstoqueNaData] 'MATRIZ','TODOS','20220630'
--PROCEDURES =======================================================================================
create procedure [dbo].[sp_Rel_EstoqueNaData]
	@Filial			as varchar(20),
	@Tipo			as varchar(20),	
	@Data			as DateTime

As

set @Data = @Data + 1

IF (OBJECT_ID('tempdb..##CalcCusto') IS NOT NULL)
	DROP TABLE ##CalcCusto
	
IF (OBJECT_ID('tempdb..#PLUs') IS NOT NULL)
	DROP TABLE #PLUs

IF (OBJECT_ID('tempdb..#PLUs2') IS NOT NULL)
	DROP TABLE #PLUs2

DECLARE @NOVO AS INT

IF CONVERT(VARCHAR, @DATA, 102) >= '2022.05'
	BEGIN
		SET @NOVO = 1
	END
ELSE
	BEGIN
		SET @NOVO = 0
	END

CREATE TABLE #PLUS2(PLU VARCHAR(17))

INSERT INTO #PLUS2 
	SELECT DISTINCT PLU FROM NF_Item I WITH (INDEX=IX_NF_ITEM_02)
	INNER JOIN NF ON NF.Cliente_Fornecedor = I.Cliente_Fornecedor AND NF.Codigo = I.Codigo 
	WHERE NF.Data >= DATEADD(YEAR, -2, GETDATE())
INSERT INTO #PLUS2
	SELECT DISTINCT PLU FROM Inventario v INNER JOIN Inventario_itens vi on v.Codigo_inventario = vi.Codigo_inventario WHERE v.Data >= DATEADD(YEAR, -1, GETDATE())
INSERT INTO #PLUS2
	SELECT DISTINCT PLU FROM Saida_estoque WITH (INDEX=IX_SAIDA_ESTOQUE_01) WHERE Filial = @Filial AND Data_movimento >= DATEADD(YEAR, -1, GETDATE())

SELECT DISTINCT PLU INTO #PLUS FROM #PLUS2

--- Calcula Custo na Data
BEGIN
	IF @NOVO = 1
		BEGIN
			--Criar tabela temporária para pegar o último custo
			SELECT NF_ITEM.PLU,
			NF.Data,
			Custo = ISNULL(
			(((NF_ITEM.Total * (CASE WHEN NF_ITEM.Desconto > 0 THEN ((100 - NF_ITEM.Desconto) / 100) ELSE 1 End)) 
			+ NF_ITEM.IVA + NF_ITEM.Frete + NF_ITEM.IPIV + NF_ITEM.Despesas) / (NF_ITEM.Qtde * NF_ITEM.Embalagem))
			,0)
			INTO #NF
			FROM NF with(INDEX=IX_NF_01)
			INNER JOIN NF_ITEM  WITH (INDEX=IX_NF_ITEM_01) 
							ON NF.FILIAL = NF_ITEM.FILIAL 
							AND NF.CLIENTE_FORNECEDOR = NF_ITEM.CLIENTE_FORNECEDOR 
			AND NF.CODIGO = NF_ITEM.CODIGO 
			WHERE NF.FILIAL = 'MATRIZ'
			AND NF.DATA >= DATEADD(YEAR, -2, GETDATE()) AND CONVERT(VARCHAR, NF.DATA, 112)  <= @DATA
			AND NF.TIPO_NF = '2'
			ORDER BY NF.DATA DESC

			--Selecionar último ocusto.
			SELECT ML.Plu,
			Custo = ISNULL((SELECT TOP 1 Custo FROM #NF WHERE #NF.PLU = ML.PLU ORDER BY #NF.DATA DESC), ML.PRECO_CUSTO)
			INTO #CalcCusto1
			FROM 
				Mercadoria_Loja Ml
			WHERE ML.PLU COLLATE DATABASE_DEFAULT IN(SELECT PLU COLLATE DATABASE_DEFAULT FROM #PLUS)
		END
	ELSE
		BEGIN
			
			SELECT NF_Item.Plu,
				Custo = Isnull(Convert(decimal(18,2),Sum(((NF_ITEM.TOTAL * ((100 - CASE WHEN NF_ITEM.DESCONTO > 0 THEN NF_ITEM.DESCONTO ELSE 0 END) / 100)) +  
				NF_ITEM.IVA + 
				NF_ITEM.IPIV) / 
				(NF_ITEM.QTDE * NF_ITEM.EMBALAGEM))),Sum(m.Preco_Custo))
			Into #CalcCusto2
			FROM 
				NF with(INDEX=IX_NF_01)
				INNER JOIN NF_ITEM with(INDEX=IX_NF_ITEM_02) ON NF.FILIAL = NF_ITEM.FILIAL 
				INNER JOIN Mercadoria M ON M.PLU = NF_ITEM.PLU
				AND NF.CLIENTE_FORNECEDOR = NF_ITEM.CLIENTE_FORNECEDOR AND NF.CODIGO = NF_ITEM.CODIGO 
				AND NF.Tipo_NF = NF_ITEM.Tipo_NF 						
				AND Isnull(NF.Serie,0) = Isnull(NF_ITEM.Serie,0)
			WHERE
				NF.FILIAL = @Filial 
			AND 
				NF.DATA = (SELECT MAX(NF.DATA) FROM NF with(INDEX=IX_NF_01)INNER JOIN NF_ITEM  with(INDEX=IX_NF_ITEM_02) 
								ON NF.FILIAL = NF_ITEM.FILIAL AND NF.CLIENTE_FORNECEDOR = NF_ITEM.CLIENTE_FORNECEDOR 
								AND NF.CODIGO = NF_ITEM.CODIGO 
								AND NF.Tipo_NF = NF_ITEM.Tipo_NF 					
								AND Isnull(NF.Serie,0) = Isnull(NF_ITEM.Serie,0)
								WHERE NF.FILIAL = @Filial 
								AND CONVERT(VARCHAR, NF.DATA, 112) <= @data
								AND NF_ITEM.PLU = m.plu
								AND NF.TIPO_NF = '2'
								AND not NF.Codigo_Operacao in ('1202','1411'))
			AND 
				NF.TIPO_NF = '2'
			AND 
				not NF.Codigo_Operacao in ('1202','1411')			
			Group By 
				NF_Item.Plu	
		END
END

DECLARE @STRING AS VARCHAR(MAX)
SET @STRING = 'SELECT * INTO ##CalcCusto FROM ' + CASE WHEN @NOVO = 1 THEN '#CalcCusto1' ELSE '#CalcCusto2' END
EXECUTE(@STRING)

Begin


SELECT 
	M.PLU,
	m.descricao,
	PRECO_CUSTO = ##CalcCusto.Custo,
	M.SALDO_ATUAL,
	m.Tipo,
	SaidaPDV = isnull((Select Sum(s.Qtde) From saida_estoque s with (index=ix_saida_estoque)-- inner join mercadoria_loja l on s.plu = l.plu
						Where s.Filial = @Filial 
						And s.Data_movimento between @Data And Getdate() 
						And s.data_cancelamento is null
						And S.PLU = M.PLU), 0),
	SaidaNF = isnull((Select Sum( ((i.qtde * i.embalagem)  )  )
						From nf Inner Join Natureza_operacao n on n.codigo_operacao = nf.Codigo_operacao 
								Inner Join nf_item i on nf.Filial = i.Filial 
								And nf.Cliente_Fornecedor = i.Cliente_Fornecedor 
								And nf.codigo = i.codigo 								
								And nf.Tipo_NF = i.Tipo_NF 
								And isnull(nf.serie,0) = Isnull(i.serie,0) 	
						Where isnull(nf.nf_canc,0) <> 1
						And nf.tipo_nf = 1
						And n.baixa_estoque = 1
						And nf.Data between @Data And GETDATE()
						And NF.FIlial = @Filial
						And i.PLU = m.plu), 0),
	OutrasSaidas = Isnull((
			(select Isnull(SUM(Contada),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO'
			and v.data between @Data And GETDATE()
			and i.PLU = m.plu
			and exists(select * from Tipo_movimentacao t where t.Movimentacao = v.tipoMovimentacao and t.saida = 1)) 
		),0),								
	OutrasEntradas = Isnull((
			(select Isnull(SUM(Contada),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO'
			and v.data between @Data And GETDATE()
			and i.PLU = m.plu
			and exists(select * from Tipo_movimentacao t where t.Movimentacao = v.tipoMovimentacao and t.saida = 0)) 
		),0),						
	EntradaNF = isnull((Select Sum( ((i.qtde * i.embalagem)  )  )
						From nf Inner Join Natureza_operacao n on n.codigo_operacao = nf.Codigo_operacao 
								Inner Join nf_item i on nf.Filial = i.Filial 
								And nf.Cliente_Fornecedor = i.Cliente_Fornecedor 
								And nf.codigo = i.codigo 								
								And nf.Tipo_NF = i.Tipo_NF 
								And isnull(nf.serie,0) = Isnull(i.serie,0) 									
						Where isnull(nf.nf_canc,0) <> 1
						And nf.tipo_nf = 2
						And n.baixa_estoque = 1
						And nf.Data between @Data And GETDATE()
						And NF.Filial = @Filial
						And i.PLU = m.plu), 0),
	DivInv = Isnull((
			(select Isnull(SUM((i.Contada-i.Saldo_Atual)),0) from inventario_itens i inner join inventario v on i.Codigo_inventario = v.Codigo_inventario 
			and v.status = 'ENCERRADO' and v.tipoMovimentacao  = 'INVENTARIO'
			and v.data between @Data And GETDATE()
			and i.PLU = m.plu)),0),
	ICMSEntrada = ISNULL(T.Saida_Icms, 0),
	Perc_PIS = M.Pis_Perc_Entrada,
	Perc_COFINS = M.Cofins_Perc_Entrada 											
into #lixo 
From 
	Mercadoria m Inner join ##CalcCusto on m.plu = ##CalcCusto.plu
	INNER JOIN Tributacao T on t.codigo_tributacao = M.Codigo_Tributacao 
Where
	m.Filial = @Filial	
And	
	(@Tipo = 'TODOS' OR  @Tipo like '%'+m.Tipo+'%')	


Select 
	PLU, 
	Descricao, 
	Departamento = (Select w.descricao_departamento 
						From W_BR_CADASTRO_DEPARTAMENTO w Inner Join mercadoria m 
						on w.codigo_departamento = m.Codigo_departamento 
						Where m.plu = #lixo.PLU),
	Tipo,
	Custo = convert(decimal(18,2),preco_custo), 
	Saldo = (saldo_atual + OutrasSaidas + SaidaPDV + SaidaNF - EntradaNF - OutrasEntradas+(DivInv*-1) ),
	[Valor Estoque] = convert(decimal(18,2),(saldo_atual + OutrasSaidas + SaidaPDV + SaidaNF - EntradaNF - OutrasEntradas+(DivInv*-1))) * preco_custo,
	ICMSEntrada,
	Perc_PIS,
	Perc_COFINS
into #estoque 
From 
	#lixo
Where 
	(saldo_atual + OutrasSaidas + SaidaPDV + SaidaNF - EntradaNF - OutrasEntradas+(DivInv*-1)) > 0
	
Select 
	Plu = #estoque.PLU, 
	Descricao = #estoque.Descricao, 
	Departamento = #estoque.Departamento, 
	Tipo = #estoque.Tipo,
	Custo = #estoque.Custo, 
	Saldo = #estoque.Saldo, 
	[Valor Estoque]= #estoque.[Valor Estoque], 
	ICMS = convert(decimal(18,2),#estoque.[Valor Estoque]*ICMSEntrada/100),
	PIS = convert(decimal(18,2),#estoque.[Valor Estoque]*Isnull(Perc_PIS,0)/100),
	COFINS = convert(decimal(18,2),#estoque.[Valor Estoque]*Isnull(Perc_COFINS,0)/100) 
into #CalcCustoLiquido	   	 	    	    
From 
	#estoque 
Order by 7 Desc
End


select 
	Plu, Descricao, Departamento, Tipo, Custo, Saldo,[Valor Estoque], ICMS, PIS, COFINS, [Custo Liquido] = convert(decimal(18,2),[Valor Estoque]-icms-pis-cofins)
From 
	#CalcCustoLiquido 
Order by 10 desc

GO

IF not EXISTS (SELECT * FROM sys.indexes WHERE name = 'ix_CPF_Data')
/****** Object:  Index [ix_CPF_Data]    Script Date: 02/08/2022 08:19:35 ******/
CREATE NONCLUSTERED INDEX [ix_CPF_Data] ON [dbo].[Saida_estoque]
(
	[CPF_CNPJ] ASC,
	[Data_movimento] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

insert into Versoes_Atualizadas select 'Versão:1.316.899', getdate();

GO
/****** Object:  StoredProcedure [dbo].[sp_Movimento_Venda]    Script Date: 30/11/2022 08:39:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER  Procedure [dbo].[sp_Movimento_Venda]

                @Filial				As Varchar(20),
                @DataDe				As Varchar(8),
                @DataAte			As Varchar(8),
                @finalizadora		As varchar(30),
                @plu				As varchar(17),
                @cupom				As varchar(20),
                @pdv				as varchar(10),                
                @horaInicio			as varchar(5),				
				@horafim			as varchar(5),
				@cancelados			as varchar(15),
				@comanda			as varchar(20),
				@ext_sat			as varchar(6),
				@cpf				as varchar(14)

AS

begin 
--exec     sp_Movimento_Venda   @Filial='MATRIZ', @DataDe = '20220701',  @dataate = '20220731',  @horaInicio = '00:00',  @horafim = '23:59',  @finalizadora = 'TODOS',  @Pdv = 'TODOS',  @plu = '',  @cupom = '',  @comanda = '',  @cancelados = 'TODOS',  @ext_sat = '', @CPF = '08785616842'

Select Data_movimento, S.Documento, S.PLU, m.DESCRICAO, S.QTDE, vlr, Desconto,  Acrescimo ,
	Caixa_Saida, Ext_SAT = '', Hora_venda, ComandaPedidoCupom, Finalizadora = 'NAO FINALIZADOS'
Into 
	#CupomSemPagamento
From 
	Saida_estoque s INNER JOIN Mercadoria m on s.plu = m.plu 
	Where 
		s.Data_movimento BETWEEN @DataDe AND @DataAte
	And 
		not s.data_cancelamento is null
	And 
		s.Filial = @FILIAL   
	And 
		not exists(select * from Lista_finalizadora l 
					Where l.documento = s.documento and l.Emissao = s.data_movimento
						And l.pdv = s.caixa_saida
						And l.filial = s.Filial)


--exec sp_Movimento_Venda @Filial='MATRIZ', @DataDe = '20180705',  @dataate = '20180705',  @horaInicio = '00:00',  @horafim = '23:59',  @finalizadora = 'TODOS',  @Pdv = 'TODOS',  @plu = '',  @cupom = '',  @comanda = '',  @cancelados = '',  @ext_sat = '' 
IF(@plu='' AND @cupom='' and @ext_sat ='')

      BEGIN

            IF(@finalizadora ='TODOS')

                  BEGIN

                        SELECT DISTINCT

                             DATA = CONVERT(VARCHAR,lista.EMISSAO,103),

                             lista.PDV,

                             CUPOM = lista.DOCUMENTO,
                             [Ext SAT ] = 'SFT_'+SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
                             CONVERT(varchar , s.Hora_venda,108) as HORA,
                             
							[COMANDA/PEDIDOS] =  '_'+(SELECT Max(ComandaPedidoCupom) FROM Saida_estoque st  with (index(IX_Movimento_venda_01))

								WHERE st.Filial = @FILIAL And st.data_cancelamento is null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento),
                        
                             
                             FINALIZADORA = lista.id_finalizadora,
							
						     VLR = (SELECT isnull(convert(decimal(18,2),SUM(list1.Total )),0) 
										FROM Lista_finalizadora list1
				                             INNER JOIN Finalizadora ON list1.finalizadora = finalizadora.Nro_Finalizadora 
								  			 --INNER JOIN  Saida_estoque S  with (index(IX_Movimento_venda_01)) ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv and CONVERT(varchar , s.Hora_venda,108) between @horaInicio and @horafim
									WHERE list1.Filial = @FILIAL And Isnull(Cancelado,0) = 0 
											 AND (list1.Emissao = lista.Emissao)
											 and list1.pdv =lista.pdv
											 and list1.documento = lista.documento
											 AND LIST1.id_finalizadora = LISTA.id_finalizadora
                         ),
                             CANCELADOS = (SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) 
										    FROM Saida_estoque st  with (index(IX_Movimento_venda_01)) 
											WHERE st.Filial = @FILIAL And data_cancelamento is not null 
													and CONVERT(varchar , st.Hora_venda,108) between @horaInicio and @horafim 
													AND (st.Data_movimento = lista.Emissao)
													and st.Caixa_Saida =lista.pdv
													and st.documento = lista.documento),
						 [CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)

						INTO #LISTA_TEMP FROM Lista_finalizadora lista
                            INNER JOIN Finalizadora ON lista.finalizadora = finalizadora.Nro_Finalizadora 
							INNER JOIN Saida_estoque S  with (index(IX_Movimento_venda_01))  ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv	and s.Data_movimento = lista.Emissao
                        WHERE lista.Filial = @FILIAL  AND (Emissao BETWEEN @DataDe  AND  @DataAte )
								  and CONVERT(varchar , s.Hora_venda,108) between @horaInicio and @horafim 
                                   and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
								   and (LEN(@cancelados)=0 OR
										
										(@cancelados ='TODOS' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																							WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
																								AND (st.Data_movimento = lista.Emissao)
																							   and st.Caixa_Saida =lista.pdv
																							   and st.documento = lista.documento))>0) 
										OR (@cancelados='ITEM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=0 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0) 
										OR (@cancelados='CUPOM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=1 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0)												   
																						   
																						   ) 
																						   
						and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')
						and (REPLACE(REPLACE(REPLACE(ISNULL(S.CPF_CNPJ,''),'.',''),'-',''),'/','') LIKE CASE WHEN LEN(@CPF)=0 THEN '%%' ELSE @CPF END)

						
						--Incluir Registros sem Pagamento
						Insert into #LISTA_TEMP
						Select  DISTINCT
							DATA = CONVERT(VARCHAR,c.Data_movimento,103)
						  , PDV = c.Caixa_Saida
						  , Cupom = Documento
						  , Ext_SAT
						  , CONVERT(varchar , C.Hora_venda,108) as HORA
						  , [COMANDA/PEDIDOS] = '_'+ Max(ComandaPedidoCupom)
						  , Finalizadora
						  , vlr = 0
						  , Cancelados = SUM(Vlr-isnull(Desconto,0)) 
						  ,''
						From 
							#CupomSemPagamento c 
						Where
							CONVERT(varchar , c.Hora_venda,108) between @horaInicio and @horafim 
						--And 
						--	(LEN(@comanda)=0 or c.ComandaPedidoCupom  like '%'+@comanda+'%')
						and 
							Finalizadora = (case when @cancelados = ''				 then 'NAO FINALIZADOS' 
													when @cancelados = 'NAO FINALIZADOS' then 'NAO FINALIZADOS' 
													when @cancelados = 'TODOS'			 then 'NAO FINALIZADOS' 
													else 'NAO APARECE NADA' end)								
						Group By 			
							c.Data_movimento, c.Caixa_Saida, Documento, Ext_SAT, Finalizadora	, HORA_VENDA																																	   
                       
                       ----*******************************************************---------
                       
					   
						UPDATE #LISTA_TEMP SET CANCELADOS = (CANCELADOS/(SELECT COUNT(B.CUPOM) FROM #LISTA_TEMP AS B WHERE  B.CUPOM = #LISTA_TEMP.CUPOM and b.pdv = #LISTA_TEMP.pdv)  ) 
						WHERE CUPOM IN (SELECT CUPOM FROM #LISTA_TEMP where CANCELADOS >0 GROUP BY CUPOM,pdv HAVING   COUNT(CUPOM) > 1   )
						AND CANCELADOS >0
						

                       SELECT DISTINCT * FROM #LISTA_TEMP
					   

                  END

            ELSE

                  BEGIN

                        SELECT

                             DATA = CONVERT(VARCHAR,EMISSAO,103),

                             PDV,

                             CUPOM = lista.DOCUMENTO,
                             [Ext SAT] = 'SFT_'+SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
                             CONVERT(varchar , Hora_venda,108) AS HORA,

                             [COMANDA/PEDIDOS] = '_'+(SELECT Max(ComandaPedidoCupom) FROM Saida_estoque st

								WHERE st.Filial = @FILIAL And data_cancelamento is null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento),
                                   VLR =(SELECT isnull(convert(decimal(18,2),SUM(list1.Total )),0) FROM Lista_finalizadora list1

                             INNER JOIN Finalizadora ON list1.finalizadora = finalizadora.Nro_Finalizadora 

                        WHERE list1.Filial = @FILIAL And Isnull(Cancelado,0) = 0 
									AND (list1.Emissao = lista.Emissao)
                                   and list1.pdv =lista.pdv
                                   and list1.documento = lista.documento
                                   
                         ),        

                             FINALIZADORA = id_finalizadora,
                             
                     
                             CANCELADO = (SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st  with (index(IX_Movimento_venda_01))

								WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
									AND (st.Data_movimento = lista.Emissao)
                                   and st.Caixa_Saida =lista.pdv
                                   and st.documento = lista.documento
                                    ),
							[CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
													Select TOP 1 S2.ID_CHAVE		 
													FROM SAIDA_ESTOQUE  AS S2
													WHERE S2.Documento = S.Documento
														AND S2.Caixa_Saida = S.Caixa_Saida
														AND S2.Data_movimento = S.Data_movimento
														AND S2.Filial = S.Filial
														AND S2.ID_Chave IS NOT NULL
												)
										)


                      INTO #LISTA_TEMP2   FROM

                             Lista_finalizadora lista

                             INNER JOIN Finalizadora ON lista.finalizadora = finalizadora.Nro_Finalizadora 
                             INNER JOIN  Saida_estoque S  ON S.Documento=lista.Documento and s.Caixa_Saida = lista.pdv and s.Data_movimento = lista.Emissao

                        WHERE lista.Filial = @FILIAL  AND (Emissao BETWEEN @DataDe  AND  @DataAte )

                        AND finalizadora.Finalizadora  = @finalizadora 
						and CONVERT(varchar , Hora_venda,108) between @horaInicio and @horafim 
                         and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
						 and (LEN(@cancelados)=0 OR
								(@cancelados ='TODOS' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																							WHERE st.Filial = @FILIAL And data_cancelamento is Not null 
																								AND (st.Data_movimento = lista.Emissao)
																							   and st.Caixa_Saida =lista.pdv
																							   and st.documento = lista.documento))>0) 
										OR (@cancelados='ITEM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=0 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0) 
										OR (@cancelados='CUPOM' AND ((SELECT isnull(convert(decimal(18,2),SUM(st.vlr)),0) FROM Saida_estoque st

																						WHERE st.Filial = @FILIAL And data_cancelamento is Not null AND ISNULL(cupom_cancelado,0)=1 
																							AND (st.Data_movimento = lista.Emissao)
																						   and st.Caixa_Saida =lista.pdv
																						   and st.documento = lista.documento))>0)												   
																						   
																						   ) 
									
                       and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
						and (REPLACE(REPLACE(REPLACE(S.CPF_CNPJ,'.',''),'-',''),'/','') LIKE CASE WHEN LEN(@CPF)=0 THEN '%%' ELSE @CPF END)
                      --  GROUP BY Emissao, PDV, lista.DOCUMENTO ,id_finalizadora,CONVERT(varchar , Hora_venda,108),SUBSTRING(S.ID_CHAVE,35,6)




                             SELECT DISTINCT * FROM #LISTA_TEMP2

                  END

      END

 

ELSE IF (@plu<>'' AND @cupom='' and @ext_sat = '')

BEGIN

      SELECT CUPOM = S.Documento,
			 [Ext SAT] = SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),
             DATA = CONVERT(VARCHAR,s.Data_movimento,103),
             HORA = convert(varchar,Hora_venda),
	         PDV=convert(varchar,s.caixa_saida) ,
			 'PLU'+S.PLU as PLU,
			 DESCRICAO =M.Descricao,
             QTDE=replace(convert(varchar,S.Qtde),'.',','),
             VLR=replace(convert(varchar,S.vlr),'.',','),
			 [-DESCONTO]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),
			 [+ACRESCIMO]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),
			 TOTAL=replace(convert(varchar,(s.vlr-isnull(s.Desconto,0))+ISNULL(s.acrescimo,0)),'.',',') ,
			 [CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
					Select TOP 1 S2.ID_CHAVE		 
					FROM SAIDA_ESTOQUE  AS S2
					WHERE S2.Documento = S.Documento
						AND S2.Caixa_Saida = S.Caixa_Saida
						AND S2.Data_movimento = S.Data_movimento
						AND S2.Filial = S.Filial
						AND S2.ID_Chave IS NOT NULL
					)
			 )

      FROM Saida_estoque S  with (index(IX_Movimento_venda_01)) 
					--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
                    INNER JOIN Mercadoria M ON S.PLU = M.PLU      
	  where (LEN(@cupom)=0 or  s.Documento  =  @cupom  )
                        and (len(@plu)=0 or s.PLU = @plu )
                        And s.Data_Cancelamento is null
                        and s.Data_movimento BETWEEN @DataDe  AND  @DataAte
						and s.Data_movimento between @DataDe aND @DataAte
                         --and (LEN(@pdv)=0 or l.pdv = @pdv)
                        and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                        and CONVERT(varchar , Hora_venda,108) between @horaInicio and @horafim 
						and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                        --Group by s.Documento,l.Emissao,l.pdv,s.plu,m.descricao,s.Qtde,s.vlr,s.Desconto,s.Acrescimo,Hora_venda
                        order by s.Data_movimento , Hora_venda

      END

ELSE

      BEGIN
      
            SELECT	CUPOM = S.Documento, --1
					[Ext SAT] = SUBSTRING(isnull(S.ID_CHAVE,(
																Select TOP 1 S2.ID_CHAVE		 
																FROM SAIDA_ESTOQUE  AS S2
																WHERE S2.Documento = S.Documento
																  AND S2.Caixa_Saida = S.Caixa_Saida
																  AND S2.Data_movimento = S.Data_movimento
																  AND S2.Filial = S.Filial
																  AND S2.ID_Chave IS NOT NULL
															)
													)
							 					,35,6),--2
					DATA = CONVERT(VARCHAR,s.Data_movimento,103), --3
					PDV=convert(varchar,s.caixa_saida) ,--4
					'PLU'+S.PLU AS PLU, --5
					DESCRICAO = M.Descricao, --6
					QTDE=replace(convert(varchar,S.Qtde),'.',','),--7
					VLR=replace(convert(varchar,S.vlr),'.',','),--8
					[-DESCONTO]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),--9
					[+ACRESCIMO]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),--10
					TOTAL=replace(convert(varchar,(s.vlr-isnull(s.Desconto,0))+ISNULL(s.acrescimo,0)),'.',','), --11
					[CHAVE] = '|chave|'+isnull(S.ID_CHAVE,(
							Select TOP 1 S2.ID_CHAVE		 
							FROM SAIDA_ESTOQUE  AS S2
							WHERE S2.Documento = S.Documento
								AND S2.Caixa_Saida = S.Caixa_Saida
								AND S2.Data_movimento = S.Data_movimento
								AND S2.Filial = S.Filial
								AND S2.ID_Chave IS NOT NULL
							)
					 )

            FROM Saida_estoque S  with (index(IX_Movimento_venda_01)) 
						--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
						INNER JOIN Mercadoria M ON S.PLU = M.PLU      
			where s.Documento like (case when @cupom <>'' then @cupom  else '%' end  )
						and (len(@ext_sat)=0 or SUBSTRING(S.ID_CHAVE,35,6)= @ext_sat)
                        and s.PLU like (case when @plu <>'' then @plu else '%' end )
                        and s.data_movimento BETWEEN @DataDe  AND  @DataAte
                        And s.Data_Cancelamento is null
						and s.Data_movimento between @DataDe aND @DataAte 
                        and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                        and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
                       --Group by s.Documento,s.data_movimento,s.caixa_saida,s.plu,m.descricao,s.Qtde,s.vlr,s.Desconto,s.Acrescimo,Hora_venda,SUBSTRING(S.ID_CHAVE,35,6)
		union all                      
			SELECT '',--1
				   '',--2
                   '|-CANCELADO-|',--3
				   pdv=convert(varchar,s.caixa_saida) ,--4
                   '|-'+S.PLU+'-|',--5
                   '|-'+M.Descricao+'-|', --6
                   Qtde=replace(convert(varchar,S.Qtde),'.',','),--7
                   Vlr=replace(convert(varchar,S.vlr),'.',','),--8
                   [-Desconto]=replace(convert(varchar,isnull(s.desconto,0)),'.',','),--9
                   [+Acrescimo]=replace(convert(varchar,isnull(s.Acrescimo,0)),'.',','),--10
                   Total='0,000', --11
				   ''--12
            FROM Saida_estoque S  with (index(IX_Movimento_venda_01))
				--INNER JOIN Lista_finalizadora L ON S.Documento=L.Documento and s.Caixa_Saida = l.pdv
				INNER JOIN Mercadoria M ON S.PLU = M.PLU      
			where s.Documento like (case when @cupom <>'' then @cupom  else '%' end  )
					and (len(@ext_sat)=0 or SUBSTRING(S.ID_CHAVE,35,6)= @ext_sat)
					and s.PLU like (case when @plu <>'' then @plu else '%' end )
                    and s.data_movimento BETWEEN @DataDe  AND  @DataAte
                	And s.Data_Cancelamento is NOT null
					and s.Data_movimento between @DataDe aND @DataAte 
                    and s.caixa_saida like (case when @pdv <> 'TODOS' then @pdv else '%' end)
                    and (LEN(@comanda)=0 or S.ComandaPedidoCupom  like '%'+@comanda+'%')	
		union all

            select  '',--1
					'',--2
					'',--3
					'',--4
					'',--5
					'|-'+ id_finalizadora+'-|'  ,--6
					'',--7
					'',--8
					'',--9
					'',--10
					 '|-'+replace(convert(varchar,(SUM(Lista_Finalizadora.Total))),'.',',')+'-|' --11
					,'' -- 12
			from Lista_finalizadora
			where  Documento like (case when @cupom <>'TODOS' then @cupom  else '%' end  )
		
                   and Emissao BETWEEN @DataDe  AND  @DataAte
                   And Isnull(Cancelado,0) = 0
                   and pdv like (case when @pdv <> 'TODOS' then @pdv else '%' end)
			GROUP BY Emissao, PDV, DOCUMENTO ,id_finalizadora

                       

      END


end






